<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">















  <link rel="alternate" href="/default" title="ChenXing">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="http://yoursite.com/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />






  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









    <title> ChenXing </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">ChenXing</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            分类
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">ChenXing</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/09/15/koa-router小笔记/">koa-router小笔记</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-09-15
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Node/">Node</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h3 id="koa-router小笔记"><a href="#koa-router小笔记" class="headerlink" title="koa-router小笔记"></a>koa-router小笔记</h3><p><strong>koa-compose</strong>的一个小知识 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> (<span class="params">context, next</span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> index = <span class="number">-1</span></div><div class="line">    <span class="keyword">return</span> dispatch(<span class="number">0</span>)</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span> (<span class="params">i</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (i &lt;= index) <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'next() called multiple times'</span>))</div><div class="line">      index = i</div><div class="line">      <span class="keyword">let</span> fn = middleware[i]</div><div class="line">      <span class="built_in">console</span>.log(i,index)</div><div class="line">      <span class="keyword">if</span> (i === middleware.length) fn = next</div><div class="line">      <span class="keyword">if</span> (!fn) <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(fn(context, <span class="function"><span class="keyword">function</span> <span class="title">next</span> (<span class="params"></span>) </span>&#123;</div><div class="line">          <span class="keyword">return</span> dispatch(i + <span class="number">1</span>)</div><div class="line">        &#125;))</div><div class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(err)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>之前我看代码的时候就想不通，下面两句话是什么时候执行的？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (i === middleware.length) fn = next</div><div class="line"><span class="keyword">if</span> (!fn) <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</div></pre></td></tr></table></figure>
<p>直到看了<code>koa-router</code>里面的<code>allowdmethods</code>之后才知道什么时候会执行</p>
<p>正常我们<code>use</code>中间件，然后按中间件顺序是不会执行的，<strong>因为最后一个中间件没有next()</strong>,</p>
<p>你可能想到了，我们故意给最后一个中间件添加<code>next()</code>, 即使它后面没有任何中间件。</p>
<p>等下到<code>koa-router</code>的<code>allowmethod</code>的时候再谈谈这个。</p>
<p>老惯例,先上一张图</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</div><div class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> Koa()</div><div class="line"><span class="keyword">var</span> Router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)</div><div class="line"></div><div class="line"><span class="comment">// 装载所有子路由</span></div><div class="line"><span class="keyword">var</span> router = <span class="keyword">new</span> Router()</div><div class="line"><span class="keyword">var</span> home = <span class="keyword">new</span> Router()</div><div class="line"></div><div class="line">router.get(<span class="string">'/'</span>,<span class="keyword">async</span>(ctx,next)=&gt;&#123;</div><div class="line">  ctx.body  = <span class="string">'hello world '</span></div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="comment">// 子路由1</span></div><div class="line">home.get(<span class="string">'/hello'</span>, <span class="keyword">async</span>( ctx,next )=&gt;&#123;</div><div class="line">  <span class="keyword">return</span> next();</div><div class="line">&#125;, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>  (<span class="params">ctx</span>)</span>&#123;</div><div class="line">  ctx.body  = <span class="string">'home'</span></div><div class="line">&#125;)</div><div class="line"></div><div class="line">home.get(<span class="string">'/ '</span>, <span class="keyword">async</span>( ctx,next )=&gt;&#123;</div><div class="line">  <span class="keyword">return</span> next();</div><div class="line">&#125;, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>  (<span class="params">ctx</span>)</span>&#123;</div><div class="line">  ctx.body  = <span class="string">'hello home'</span></div><div class="line">&#125;)</div><div class="line"></div><div class="line"></div><div class="line">router.use(<span class="string">'/home'</span>, home.routes())</div><div class="line"></div><div class="line">app.use(router.routes())</div><div class="line">app.use(router.allowedMethods())</div><div class="line"></div><div class="line">app.listen(<span class="number">3000</span>, () =&gt; &#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'[demo] route-use-middleware is starting at port 3000'</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>use对应的背后逻辑如下(没添加allowMethods方法)</p>
<p><img src="/img/koa/koa-router.jpg" alt="koa-router"></p>
<h3 id="Router结构"><a href="#Router结构" class="headerlink" title="Router结构"></a>Router结构</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Router(opts)&#123;</div><div class="line">	<span class="attr">opts</span> : opts || &#123;&#125;;</div><div class="line">	methods : opts.methods || [<span class="string">'head'</span>,<span class="string">'options'</span>,<span class="string">'get'</span>,<span class="string">'put'</span>,<span class="string">'patch'</span>,<span class="string">'post'</span>,<span class="string">'delete'</span>]</div><div class="line">	params : &#123;   &#125;</div><div class="line">	stack[ layer, layer, layer ]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在我看来这个和<code>express</code>里面<code>router</code>是差不多的,看过源码的可能都会有个印象,就是<code>app = express()</code> 有个<code>_router</code>对象,它也有个<code>stack</code>用来<code>push</code>中间件,更巧的是里面也都是<code>layer</code>对象.</p>
<p>回到<code>koa</code>的<code>router</code>上面来,通过<code>methods</code>插件.往<code>Router</code>对象身上注册一系列方法<code>get,post,put,head,delete</code>.</p>
<p>调用这些方法则会<code>Router.stack.push(layer)</code>实际就是调用<code>register</code>注册<code>layer</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">methods.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">method</span>) </span>&#123;</div><div class="line">	Router.prototype.method = <span class="function"><span class="keyword">function</span> (<span class="params">name,path,middleware</span>) </span>&#123;</div><div class="line">		...</div><div class="line">		<span class="comment">//注册</span></div><div class="line">    	<span class="keyword">this</span>.register(path, [method], middleware, &#123;</div><div class="line">     		 <span class="attr">name</span>: name</div><div class="line">  	    &#125;);</div><div class="line">  		...</div><div class="line">	&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们来看看<code>layer</code>长什么样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//layer对象</span></div><div class="line">Layer &#123;</div><div class="line">  <span class="attr">opts</span>:&#123; </div><div class="line">     <span class="attr">end</span>: <span class="literal">true</span>,</div><div class="line">     <span class="attr">name</span>: <span class="literal">null</span>,</div><div class="line">     <span class="attr">sensitive</span>: <span class="literal">false</span>,</div><div class="line">     <span class="attr">strict</span>: <span class="literal">false</span>,</div><div class="line">     <span class="attr">prefix</span>: <span class="string">''</span>,</div><div class="line">     <span class="attr">ignoreCaptures</span>: <span class="literal">undefined</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">name</span>: <span class="literal">null</span>,</div><div class="line">  <span class="attr">methods</span>: [ <span class="string">'HEAD'</span>, <span class="string">'GET'</span> ], <span class="comment">//当只有一个参数的时候添加head方法</span></div><div class="line">  paramNames: [],</div><div class="line">  <span class="attr">stack</span>: [ [AsyncFunction] ],   <span class="comment">//这里就是我们get,post,放置的async函数</span></div><div class="line">  path: <span class="string">'/'</span>,</div><div class="line">  <span class="attr">regexp</span>: &#123; /^(?:\/(?=$))?$/i keys: [] &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>routes方法</strong></p>
<p><code>Router.routes</code>返回一个<code>dispatch</code>中间件，并设置<code>dispatch.router = this</code>，<strong>在响应请求的时候执行</strong>.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">dispatch(ctx,next)&#123;</div><div class="line">	<span class="keyword">var</span> path = ctx.path;</div><div class="line">	<span class="keyword">var</span> matched = router.match(path,ctx.method)</div><div class="line"> 	<span class="keyword">var</span> matchedLayers = matched.pathAndMethod</div><div class="line">	...</div><div class="line">    if (!matched.route) <span class="keyword">return</span> next();</div><div class="line">  	layerChain = matchedLayers.reduce(<span class="function"><span class="keyword">function</span>(<span class="params">memo, layer</span>) </span>&#123;</div><div class="line">      memo.push(<span class="function"><span class="keyword">function</span>(<span class="params">ctx, next</span>) </span>&#123;</div><div class="line">        ctx.captures = layer.captures(path, ctx.captures);</div><div class="line">        ctx.params = layer.params(path, ctx.captures, ctx.params);</div><div class="line">        <span class="keyword">return</span> next();</div><div class="line">      &#125;);</div><div class="line">      <span class="keyword">return</span> memo.concat(layer.stack);</div><div class="line">    &#125;, []);</div><div class="line">   <span class="keyword">return</span> compose(layerChain)(ctx, next);</div><div class="line">   <span class="comment">// layerChain = [fnc(ctx,next),layer.stack]</span></div><div class="line">   <span class="comment">//该中间件 compose(layerChain)(ctx,next)了，因为next是上级的next，也就是app use compose 里面的next= function next () &#123; return dispatch(i + 1)&#125; 所以暂时不会执行，</span></div><div class="line">   <span class="comment">// 接着执行layer.stack。 也就是 二级路由的compose, 等到 这里面所有路由执行完了, fn = next</span></div><div class="line">   <span class="comment">// 此时的next为 上级的next,也就是说开始执行 app use 别的中间件了</span></div><div class="line">   <span class="comment">//如果说!matched.route，则说明不匹配路由，则执行上级next()</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//metched是mathoded对象</span></div><div class="line">Router.prototype.match (path,method)&#123;</div><div class="line">  	<span class="keyword">var</span> layer = <span class="keyword">this</span>.stack</div><div class="line">	<span class="keyword">return</span> matched&#123;</div><div class="line">		<span class="comment">//放进 与 请求路径向匹配的layer </span></div><div class="line">		path:[layer],</div><div class="line">		<span class="comment">//layer method length 为空 或则methods有值存储</span></div><div class="line">		pathAndMethod:[layer],</div><div class="line">		<span class="attr">route</span>:<span class="literal">false</span>	 layer.method.length存在为<span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//matches对象</span></div><div class="line"><span class="comment">// 如果存在子路由和allowMethods ,如果allowMethod的path被匹配到,那么会match对象会有该allowMethod包装过的layer</span></div><div class="line">&#123; </div><div class="line">	<span class="attr">path</span>: [ Layer &#123;.. ],</div><div class="line">	<span class="attr">pathAndMethod</span>: [ Layer &#123;..],</div><div class="line">  	<span class="attr">route</span>: <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>use方法</strong></p>
<p><code>use(path,router.routes(),router.allowedMethods)</code> 方法就是是把<code>routes</code>返回的<code>dispatch</code>中间件和 <code>allowdMethods</code>返回的中间件，生成<code>layer</code>然后<code>push</code>进自己的<code>stack</code>.</p>
<p>(因为routes().router是自己，也就是layer不生成，allowdMethod生成)，而且会把路径加上<code>path</code>，形成多级路由。</p>
<p><strong>use本质就是移花接木,跟着我念</strong></p>
<p>就是把二级路由<code>stack[layer,layer]</code>添加到自己的<code>stack</code>里面. <code>allowMethods</code>包装的<code>layer</code>添加到自己的<code>stack</code>里面</p>
<p>就是把二级路由<code>stack[layer,layer]</code>添加到自己的<code>stack</code>里面. <code>allowMethods</code>包装的<code>layer</code>添加到自己的<code>stack</code>里面</p>
<p>就是把二级路由<code>stack[layer,layer]</code>添加到自己的<code>stack</code>里面. <code>allowMethods</code>包装的<code>layer</code>添加到自己的<code>stack</code>里面</p>
<p><strong>allowmethods方法</strong></p>
<p><code>allowdmethods</code>  返回一个中间件.</p>
<p>这个中间件调用下一个中间件(一般为空，此时fn不存在)，<code>next().then()</code>也就是说这个<code>next()</code>返回<code>Promise.resolve().</code> </p>
<p><strong>这个中间件是在路由不存在(这时候一点都不执行核心代码，浅略的过了一下)或则路由存在但是方法不匹配的时候执行</strong>。</p>
<p>在这里面对<code>ctx.method</code>先进行判断，看是否是<code>Router</code>自身规定的<code>put,get,post</code>或则说与<code>path[x]=layer</code>路由方法不匹配时抛出异常。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">allowedMethods</span>(<span class="params">ctx, next</span>) </span>&#123;</div><div class="line">   <span class="keyword">return</span> next().then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">       <span class="comment">//处理判断方法逻辑</span></div><div class="line">   &#125;)</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里有个地方我想不通,就是如果此时<code>allowMethods</code>后面没有任何中间件了,那么此时会是<code>next(),</code>会返回</p>
<p><code>promise,resolve()</code>也就是说这个相当于同步的,那么说如果去掉这行<code>next()</code>也是可以的,干嘛要加?不懂…</p>
<p><strong>all方法</strong></p>
<p>也是注册一个<code>layer,</code>但是<code>[methods]</code>是<code>methods</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">register(path, [method], middleware, &#123;</div><div class="line">  <span class="attr">name</span>: name</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<ul>
<li>route(name)根据给定的name，查找stack里面layer的name是此名字的，没有返回false，有返回该layer;</li>
<li>url(name,params) 根据name，和params，首先获取route(name)会返回layer,layer存在 返回一个string,　layer不存在则抛出error</li>
<li>todo </li>
</ul>
<h3 id="分析执行流程"><a href="#分析执行流程" class="headerlink" title="分析执行流程"></a>分析执行流程</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">compose</span> (<span class="params">middleware</span>) </span>&#123;</div><div class="line">  ...</div><div class="line">  return <span class="function"><span class="keyword">function</span> (<span class="params">context, next</span>) </span>&#123;</div><div class="line">      ...</div><div class="line">    return dispatch(<span class="number">0</span>)</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span> (<span class="params">i</span>) </span>&#123;</div><div class="line">      <span class="keyword">if</span> (i === middleware.length) fn = next</div><div class="line">      <span class="keyword">if</span> (!fn)<span class="keyword">return</span> <span class="built_in">Promise</span>.resolve()</div><div class="line">        ...</div><div class="line">      return <span class="built_in">Promise</span>.resolve(fn(context, <span class="function"><span class="keyword">function</span> <span class="title">next</span> (<span class="params"></span>) </span>&#123;</div><div class="line">          <span class="keyword">return</span> dispatch(i + <span class="number">1</span>)</div><div class="line">      &#125;))</div><div class="line">          ...</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>假设说我们代码 是这样 的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">app.use(<span class="keyword">async</span>(ctx,next)=&gt;&#123;</div><div class="line">  <span class="built_in">console</span>.log(<span class="string">'middleware 1'</span>)</div><div class="line">  <span class="keyword">return</span> next();</div><div class="line">&#125;)</div><div class="line">app.use(router.routes())</div><div class="line">app.use(router.allowedMethods())</div></pre></td></tr></table></figure>
<p>最开始<code>fn(ctx).then(handleResponse).catch(onerror)</code>,可以看到传进来参数是没有<code>next</code>的,</p>
<ul>
<li>第一步，执行第一个中间件<ul>
<li>fn(context,next1) , 也就是async(ctx,next) , 请注意，此时<code>next1</code>是 （<strong>我特意用了next1</strong>）</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">next1</span> (<span class="params"></span>) </span>&#123;</div><div class="line">          <span class="keyword">return</span> dispatch(i + <span class="number">1</span>)</div><div class="line"> &#125;)</div></pre></td></tr></table></figure>
<ul>
<li><p>第二步，router,routes()，<strong>此时，暂时暂停了第一个compose的自动执行</strong>，</p>
<ul>
<li><p>因为routes返回一个中间件，<strong>而且会根据路径和方法生成匹配的matched对象</strong>，</p>
</li>
<li><p>如果该对象的<code>route</code>不存在，那么<code>return next1()</code>，即下一个<code>allowedMethods</code>处理方法不匹配的逻辑中间件，</p>
</li>
<li><p>如果存在，则第二次<code>compose</code> 给ctx添加参数的中间件和匹配到该路由和方法的handle中间件(就是我们写的<code>async</code>方法)，<strong>compose(layerChain)(ctx, next1)</strong>, 里面的中间件大概是长这样的 </p>
<ul>
<li>[参数中间件，async, async, 参数中间件，async ]</li>
</ul>
</li>
<li><p><strong>此时第二次compose的是传进来了next1这个参数，</strong> 这意味这开始执行第二个<code>compose</code>,也意味著当执行</p>
<p>所有第二次的路由中间件后，就程序就差不多停止了，剩下的就交<code>then(handleResponse).catch(onerror)</code>了</p>
</li>
</ul>
</li>
</ul>
<p>这里有个神奇的东西，可以试试在路由最后的async里加上 next2() , 会发生意想不到的事。。。就是第一个compose又开始执行了。。。。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/09/10/一些源码分析解析/">一些npm包源码分析</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-09-10
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Node/">Node</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h2 id="spinner解析"><a href="#spinner解析" class="headerlink" title="spinner解析"></a>spinner解析</h2><p>一个命令行旋转器. — <a href="https://github.com/helloIAmPau/node-spinner" target="_blank" rel="external"><strong>cli-spinner</strong></a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Spinner = <span class="built_in">require</span>(<span class="string">'cli-spinner'</span>).Spinner;</div><div class="line"></div><div class="line"><span class="keyword">var</span> spinner = <span class="keyword">new</span> Spinner(<span class="string">'processing.. %s'</span>);</div><div class="line">spinner.setSpinnerString(<span class="string">'|/-\\'</span>);</div><div class="line">spinner.start();</div></pre></td></tr></table></figure>
<p><code>api</code>比较简单</p>
<ul>
<li><code>start</code>启动<br><em><code>stop</code>停止
</em><code>setSpinnerString</code>设置旋转器动画,可以自定义，也可以使用数字索引（引用内置json里面，是一个数组），未设置<code>setSpinnerString</code>默认是<code>json[0]</code><br><em><code>setSpinnerDelay</code>设置延迟，实际就是设置<code>setInterval</code>的<code>time</code>.
</em><code>setDefaultSpinnerString</code>更改默认旋转动画。<br>*<code>setDefaultSpinnerDelay</code>更改默认延迟 </li>
</ul>
<p>核心原理如下 ： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> readline = <span class="built_in">require</span>(<span class="string">'readline'</span>)</div><div class="line"><span class="keyword">var</span> current = <span class="number">0</span>;</div><div class="line"><span class="keyword">var</span> str = <span class="string">"|/-\\"</span></div><div class="line"><span class="keyword">var</span> id = setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    readline.clearLine(process.stdout, <span class="number">0</span>)</div><div class="line">    readline.cursorTo(process.stdout, <span class="number">0</span>)</div><div class="line">    process.stdout.write(str[current] + <span class="string">' '</span> + <span class="string">'spinner is running '</span>)</div><div class="line">    current = ++current % str.length;</div><div class="line">&#125;, <span class="number">60</span>)</div><div class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  	clearInterval(id)</div><div class="line">&#125;,<span class="number">5</span> * <span class="number">1000</span>)</div></pre></td></tr></table></figure>
<p>在<code>start</code>方法里面设置一个<code>setInterval</code>.</p>
<p>利用<code>readline</code>的<code>clearLine</code>清除当前行，<code>cursorTo</code>移动到<code>stream</code>首位,<code>process.stdout.write()</code>不停的输出字符串每一个字符.</p>
<p><code>stop</code>的时候<code>clearInterval</code>，其他方法都是改变属性状态的。</p>
<p>另外说一下<code>readlin</code> 的<code>moveCursor</code>和<code>cursorTo</code>的区别。</p>
<p>两者都需要指定<code>stream</code>，不同的是<code>moveCursor</code>是<strong>相对于当前光标</strong>的位置移动，<code>cursorTo</code>是移动到指定位置。</p>
<h3 id="fuzzy"><a href="#fuzzy" class="headerlink" title="fuzzy"></a>fuzzy</h3><p><a href="https://github.com/mattyork/fuzzy" target="_blank" rel="external">fuzzy</a> 文本模糊匹配</p>
<p><code>sublime text</code>里面有个按键<code>ctrl + p</code>, 查找文件十分方便.而<code>fuzzy</code>就类似于这种效果.</p>
<p><strong>api</strong></p>
<ul>
<li>filter(pattern,arr,opts) 最主要的方法, 模糊匹配文本.</li>
<li>simpleFilter(pattern,arr) 只匹配文本,不添加属性.</li>
<li>test(pattern,str) 单纯的测试一下 是否匹配. </li>
<li>match(pattern,str,opts) 单个匹配, 核心方法</li>
</ul>
<p><strong>简单使用</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> list = [<span class="string">'baconing'</span>, <span class="string">'narwhal'</span>, <span class="string">'a mighty bear canoe'</span>];</div><div class="line"><span class="keyword">var</span> results = fuzzy.filter(<span class="string">'bcn'</span>, list)</div><div class="line"><span class="keyword">var</span> matches = results.map(<span class="function"><span class="keyword">function</span>(<span class="params">el</span>) </span>&#123; <span class="keyword">return</span> el.string; &#125;);</div><div class="line"><span class="built_in">console</span>.log(matches);</div><div class="line"><span class="comment">// [ 'baconing', 'a mighty bear canoe' ]</span></div></pre></td></tr></table></figure>
<p><strong>filter方法</strong></p>
<p>有三个参数<code>(pattern, arr, opts)</code>  pattern 是要匹配的文本,arr是数组.</p>
<p>主要说一下<code>opts</code>参数,<code>opts</code>是一个对象,有四个属性<code>pre,post,caseSensitive,extract</code>,</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">opts&#123;</div><div class="line">  <span class="attr">pre</span>:<span class="string">' &gt; '</span>,</div><div class="line">  <span class="attr">post</span>:<span class="string">' &lt; '</span>,</div><div class="line">  <span class="attr">caseSensitive</span>: boolean , <span class="comment">//大小写是否敏感</span></div><div class="line">  extract: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>pre,post分别是前缀和后缀,用于修饰匹配到的字符.特殊显示.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">var list = ['baconing', 'narwhal', 'a mighty bear canoe'];</div><div class="line"></div><div class="line">var results = fuzzy.filter('bcn', list,&#123;</div><div class="line">	pre:'&lt;strong&gt;',</div><div class="line">	post:'&lt;/strong&gt;',</div><div class="line">&#125;)</div><div class="line"> results.forEach(function (el) &#123;</div><div class="line"> 	console.log(el.string)</div><div class="line"> &#125;)</div><div class="line"></div><div class="line">// print</div><div class="line">&lt;strong&gt;b&lt;/strong&gt;a&lt;strong&gt;c&lt;/strong&gt;o&lt;strong&gt;n&lt;/strong&gt;ing</div><div class="line">a mighty &lt;strong&gt;b&lt;/strong&gt;ear &lt;strong&gt;c&lt;/strong&gt;a&lt;strong&gt;n&lt;/strong&gt;oe</div></pre></td></tr></table></figure>
<p><code>extract</code>是一个函数,用于过滤数组中的元素,比如我们只想匹配特定对象数组里的某个属性.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> list = [</div><div class="line">    &#123;<span class="attr">rompalu</span>: <span class="string">'baconing'</span>, <span class="attr">zibbity</span>: <span class="string">'simba'</span>&#125;</div><div class="line">  , &#123;<span class="attr">rompalu</span>: <span class="string">'narwhal'</span> , <span class="attr">zibbity</span>: <span class="string">'mufasa'</span>&#125;</div><div class="line">  , &#123;<span class="attr">rompalu</span>: <span class="string">'a mighty bear canoe'</span>, <span class="attr">zibbity</span>: <span class="string">'saddam hussein'</span>&#125;</div><div class="line">];</div><div class="line"><span class="keyword">var</span> options = &#123;</div><div class="line"><span class="attr">extract</span>: <span class="function"><span class="keyword">function</span>(<span class="params">el</span>) </span>&#123; <span class="keyword">return</span> el.rompalu; &#125;</div><div class="line">&#125;;</div><div class="line"><span class="keyword">var</span> results = fuzzy.filter(<span class="string">'bcn'</span>, list, options);</div><div class="line"><span class="keyword">var</span> matches = results.map(<span class="function"><span class="keyword">function</span>(<span class="params">el</span>) </span>&#123; <span class="keyword">return</span> el.string; &#125;);</div><div class="line"><span class="built_in">console</span>.log(matches);</div><div class="line"><span class="comment">// [ 'baconing', 'a mighty bear canoe' ]</span></div></pre></td></tr></table></figure>
<p><code>fuzzy</code> 的<code>match</code>方法是核心,<code>fuzzy</code>所有方法都是调用<code>match</code>.</p>
<p>主要是遍历<code>str,</code> 拿到每一个<code>char</code>跟要匹配的文本进行匹配. 如果匹配到某字符,则添加前后缀.同时加上1分分数.</p>
<p>如果全部匹配,返回一个修饰过的<code>str</code>和分数的对象.</p>
<p>不匹配,返回null.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">fuzzy.match = <span class="function"><span class="keyword">function</span>(<span class="params">pattern, str, opts</span>) </span>&#123;</div><div class="line">  opts = opts || &#123;&#125;;</div><div class="line">  <span class="keyword">var</span> patternIdx = <span class="number">0</span></div><div class="line">    , result = []</div><div class="line">    , totalScore = <span class="number">0</span></div><div class="line">    , currScore = <span class="number">0</span></div><div class="line">    <span class="comment">// prefix</span></div><div class="line">    , pre = opts.pre || <span class="string">''</span></div><div class="line">    <span class="comment">// suffix</span></div><div class="line">    , post = opts.post || <span class="string">''</span></div><div class="line">	<span class="comment">//要匹配的数组里的str</span></div><div class="line">    , compareString =  opts.caseSensitive &amp;&amp; str || str.toLowerCase()</div><div class="line">  	<span class="comment">//匹配到单个字符</span></div><div class="line">    , ch;</div><div class="line"></div><div class="line">  pattern = opts.caseSensitive &amp;&amp; pattern || pattern.toLowerCase();</div><div class="line"></div><div class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> idx = <span class="number">0</span>; idx &lt; str.length; idx++) &#123;</div><div class="line">    ch = str[idx];</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(compareString[idx] === pattern[patternIdx]) &#123;</div><div class="line">      <span class="comment">//如果字符相等 为字符添加前后缀</span></div><div class="line">      ch = pre + ch + post;</div><div class="line">      patternIdx += <span class="number">1</span>;</div><div class="line">	  <span class="comment">//添加分数</span></div><div class="line">      currScore += <span class="number">1</span> + currScore;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      currScore = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    totalScore += currScore;</div><div class="line">    result[result.length] = ch;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">if</span>(patternIdx === pattern.length) &#123;</div><div class="line">    totalScore = (compareString === pattern) ? <span class="literal">Infinity</span> : totalScore;</div><div class="line">    <span class="keyword">return</span> &#123;<span class="attr">rendered</span>: result.join(<span class="string">''</span>), <span class="attr">score</span>: totalScore&#125;;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>score</code>分数代表匹配到的字符的个数.当完全匹配的时候,<code>score</code>为<code>Infinity</code>.</p>
<h3 id="onetime"><a href="#onetime" class="headerlink" title="onetime"></a>onetime</h3><p><a href="https://www.npmjs.com/package/onetime" target="_blank" rel="external">onetime</a> <strong>确保函数只调用一次</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">fn, opts</span>) =&gt;</span> &#123;</div><div class="line">    ...</div><div class="line">	let ret;</div><div class="line">	<span class="keyword">let</span> called = <span class="literal">false</span>;</div><div class="line">	<span class="keyword">const</span> fnName = fn.displayName || fn.name || <span class="string">'&lt;anonymous&gt;'</span>;</div><div class="line"></div><div class="line">	<span class="keyword">const</span> onetime = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">if</span> (called) &#123;</div><div class="line">          	<span class="comment">//根据opts.throw选项判断是否要抛出异常</span></div><div class="line">			<span class="keyword">if</span> (opts.throw === <span class="literal">true</span>) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Function \`<span class="subst">$&#123;fnName&#125;</span>\` can only be called once`</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">return</span> ret;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		called = <span class="literal">true</span>;	</div><div class="line">      	ret = fn.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</div><div class="line">		fn = <span class="literal">null</span>;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> ret;</div><div class="line">	&#125;;</div><div class="line">	<span class="comment">//获取fn的属性，name,length,arguents 覆盖到onetime身上</span></div><div class="line">	mimicFn(onetime, fn);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> onetime;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>有个小知识点 : 函数的<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function/displayName" target="_blank" rel="external">displayName</a> 属性, 搞不懂有什么用.</p>
<h3 id="mimic-fn"><a href="#mimic-fn" class="headerlink" title="mimic-fn"></a>mimic-fn</h3><p><a href="https://github.com/sindresorhus/mimic-fn" target="_blank" rel="external">mimic-fn</a> 把一个函数的属性,参数,原型赋值给另一个参数.可以看成是<code>function</code>版的<code>Object.assign</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">(to, <span class="keyword">from</span>) =&gt; &#123;</div><div class="line"></div><div class="line"><span class="keyword">for</span> (<span class="keyword">const</span> prop <span class="keyword">of</span> <span class="built_in">Object</span>.getOwnPropertyNames(<span class="keyword">from</span>).concat(<span class="built_in">Object</span>.getOwnPropertySymbols(<span class="keyword">from</span>))) 	&#123;</div><div class="line">		<span class="built_in">Object</span>.defineProperty(to, prop, <span class="built_in">Object</span>.getOwnPropertyDescriptor(<span class="keyword">from</span>, prop));</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/09/02/fiddler/">fiddler抓包工具</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-09-02
        </span>
        
          <div class="post-category">
            
              <a href="/categories/tools/">tools</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p><strong>Fiddler简介</strong></p>
<p><code>Fiddler</code>是一个抓包工具。</p>
<p>核心原理:     Http代理，客户端的所有请求都要先经过<code>Fiddler</code>，然后转发到相应的服务器，反之，服务器端的所有响应，也都会先经过Fiddler然后发送到客户端。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">客户端　－－－ &gt;request fiddler(proxy)  －－－&gt; request(web server )</div><div class="line">	   &lt;－－－  response fiddler(proxy) &lt;－－－ response(web server )</div></pre></td></tr></table></figure>
<p>启用 Fiddler 时，IE 的PROXY 设定会变成 127.0.0.1:8888.</p>
<p><strong>Fiddler模式</strong></p>
<ul>
<li>流模式 <code>streaming</code><ul>
<li>可实时把服务器数据返回给客户端</li>
</ul>
</li>
<li>缓冲模式<code>buffering</code><ul>
<li>http请求所有的数据都准备好之后才把数据返回给客户端</li>
</ul>
</li>
</ul>
<p><strong>菜单栏</strong></p>
<p>说一下菜单栏几个比较有用的功能.</p>
<ul>
<li><code>replay</code>重新发送请求</li>
<li><code>any process</code> 过滤进程请求好,一个锚点,拉倒对应程序即可监听该程序.</li>
<li><code>find</code>查找回话</li>
<li><code>textwizard</code> 编码 解码文本 内容<ul>
<li>用途对<code>url form</code>参数进行解压编码,十分有用.</li>
</ul>
</li>
</ul>
<p><strong>底部状态栏</strong></p>
<ul>
<li>黑色面板,可以看成说<code>console</code>,输入<code>help</code>会打开浏览器获取帮助</li>
<li><code>capturing fiddler</code>是否要启动<code>fiddler</code>代理</li>
<li><code>web browsers</code>过滤请求来源</li>
</ul>
<p><strong>右侧监控面板</strong></p>
<ul>
<li><code>staistics</code> 数据统计 <ul>
<li>客户端建立链接时间, 开始请求时间, 服务器返回响应时间…..RTT往返时间</li>
</ul>
</li>
<li><code>inspectors</code> <ul>
<li>对请求解包, 可看到各种请求信息.</li>
</ul>
</li>
<li><code>autoResponder</code><ul>
<li>文件代理, 可以不经过服务器而从本地返回. 适合定位文件</li>
</ul>
</li>
<li><code>compose</code><ul>
<li>可视化<code>curl</code>, 对<code>api</code>进行测试</li>
</ul>
</li>
<li><code>log</code><ul>
<li>操作日志</li>
</ul>
</li>
<li><code>timeline</code> <ul>
<li>网站性能分析,不大会用</li>
</ul>
</li>
</ul>
<p>还有一个实用的功能就上<code>host</code>配置,免去了本地更改<code>host</code>的痛苦.</p>
<p>我上感觉爬虫的时候分析<code>post</code>请求的时候比较有用, 有些body编码简直了…直接就是乱码,这种情况一般就是gbk编码的..</p>
<p>测试<code>api</code>一般用<code>httpie</code>,比<code>curl</code>好用多了.</p>
<p><strong>手机抓包</strong></p>
<p>需要安装证书，本人<code>小米手机</code> 上安装会失败，得手动安装。手动安装得需要密码，而这个密码是<strong>锁屏密码</strong> ，没有必须设置。设置后就会不会提示需要密码 了。</p>
<p><code>Fiddler</code>抓取<code>HTTPS</code>流量的原理</p>
<p><code>TLS</code>是一种端到端的传输层加密协议，是<code>HTTPS</code>协议的一个组成部分。访问<code>HTTPS</code>站点时，<code>HTTP</code>请求、响应都通过<code>TLS</code>协议在浏览器和服务器之间加密传输，并且通过数字证书技术保证数据的保密性和完整性；任何“中间人”、包括代{过}{滤}理服务器都只能转发数据，而无法窃听或者篡改数据。<br>要抓取<code>HTTPS</code>流量的明文内容，<code>Fiddler</code>必须解密<code>HTTPS</code>流量。但是，浏览器将会检查数字证书，并发现会话遭到窃听。为了骗过浏览器，<code>Fiddle</code>r通过使用另一个数字证书重新加密<code>HTTPS</code>流量。<code>Fiddler</code>被配置为解密<code>HTTPS</code>流量后，会自动生成一个名为<code>DO_NOT_TRUST_FiddlerRoot</code>的<code>CA</code>证书，并使用该<code>CA</code>颁发每个域名的<code>TLS</code>证书。若<code>DO_NOT_TRUST_FiddlerRoot</code>证书被列入浏览器或其他软件的信任<code>CA</code>名单内，则浏览器或其他软件就会认为<code>HTTPS</code>会话是可信任的、而不会再弹出“证书错误”警告。</p>
<p>开启<code>HTTPS</code>流量解密功能后，<code>Fiddler</code>将会提示用户将D<code>O_NOT_TRUST_FiddlerRoot</code>证书列入<code>IE</code>浏览器的信任<code>CA</code>名单。用于调试客户端时，这已经足够了；<code>Firefox</code>用户也可以很方便的手动导入<code>DO_NOT_TRUST_FiddlerRoot</code>证书。但是，若要在服务器上抓取<code>ASP.Net</code>发出的<code>HTTPS</code>请求，这是不够的——你必须将<code>DO_NOT_TRUST_FiddlerRoot</code>证书导入“机器帐号”的信任<code>CA</code>名单。</p>
<p><code>Tools - Fiddler Options - Connections</code>勾选<code>Allow remote computers to connect</code>即可。<br>如果是抓其他其他机器或移动设备，只需将<code>FiddlerRoot.cer</code>导入带抓包机器的信任<code>CA</code>名单，最后将代{过}{滤}理服务器设置成<code>Fiddler</code>所在<code>IP</code>的<code>8888</code>端口。</p>
<p>知乎上有一篇对网易云进行抓包分析<code>api</code>的，可以自行搜索看看。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/05/02/这些年我用过的软件/">那些年我用过的软件</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-05-02
        </span>
        
          <div class="post-category">
            
              <a href="/categories/tools/">tools</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h2 id="常用软件篇"><a href="#常用软件篇" class="headerlink" title="常用软件篇"></a>常用软件篇</h2><h3 id="StrokesPlus"><a href="#StrokesPlus" class="headerlink" title="StrokesPlus"></a><a href="http://www.baidu.com/link?url=eMmgypP19LcmUtjiK4xRzXckZkRdZov6_--2vBoNBFPPVp5n0DcUwAGZceoVCsBO" target="_blank" rel="external"><em>StrokesPlus</em></a></h3><p>相信很多人都用过，一个全局鼠标手势。一个鼠标解决任何事情。需要自己配置后才能超神。两年前录过一演示段视频，现在不知道放哪了。改天找找，上传到b站(我好像没账号啊，典型的伸手族)。</p>
<p><a href="http://www.bilibili.com/video/av10266857/" target="_blank" rel="external">StrokesPlus的演示</a></p>
<h3 id="Total-Commander"><a href="#Total-Commander" class="headerlink" title="Total Commander "></a><a href="https://www.baidu.com/link?url=DYko5_CMeEXFf2_B1_ly-X1vv890FlStleV4o1XEjmp5lWMVqMwaVEVaYppI6h1O&amp;wd=&amp;eqid=a1d0605b0001dcdc00000003590863ac" target="_blank" rel="external"><em>Total</em> <em>Commander</em> </a></h3><p>文件管理器，可以完全替代<code>win</code>自带的管理，效率不知道高到那里去了。但是学习曲线太陡峭了，全部都是快捷键，比较难记。</p>
<p>但是我们有折中方案。如果说你会<code>vim</code>(这个曲线也比较。。),那么事情就简单了。你配合<a href="https://www.baidu.com/link?url=9sQrI8kRt_Cm4k9IQfkO8yDy-k_xY8l6-t7z3AFwte5snH3Pcwaun9OTweWTIqdZ&amp;wd=&amp;eqid=cb0557910001caed000000035908649d" target="_blank" rel="external">vimdesktop</a>.就可以使用<code>vim</code>命令操作文件了。</p>
<h3 id="vimdesktop"><a href="#vimdesktop" class="headerlink" title="vimdesktop"></a><a href="https://www.baidu.com/link?url=9sQrI8kRt_Cm4k9IQfkO8yDy-k_xY8l6-t7z3AFwte5snH3Pcwaun9OTweWTIqdZ&amp;wd=&amp;eqid=cb0557910001caed000000035908649d" target="_blank" rel="external">vimdesktop</a></h3><p>上面的<code>TotalCMD</code>配合这个就可以无缝连接</p>
<p><strong>可以使用vim命令来操作一切文件，复制，粘贴，删除，解压，预览图片，文件，音频，分类，查找文件，快速复制文件名，路径名，快速打开命令。。。。。</strong></p>
<p>还有一个很重要的功能就是</p>
<p><strong>让不支持vim功能的编辑器(word,自带txt,typora等等一系列文档编辑器)支持vim操作</strong></p>
<p><strong>让不支持vim功能的编辑器(word,自带txt,typora等等一系列文档编辑器)支持vim操作</strong></p>
<p><strong>让不支持vim功能的编辑器(word,自带txt,typora等等一系列文档编辑器)支持vim操作</strong></p>
<p>不过不显示光标，无伤大雅，支持不全，<strong>只能做到简单移动，插入</strong>。</p>
<h3 id="runz"><a href="#runz" class="headerlink" title="runz"></a><a href="https://github.com/goreliu/runz" target="_blank" rel="external">runz</a></h3><p>一个快速启动工具，<strong>仅仅2m，极简，稳定</strong>，实用。输入窗口的操作类似<code>bash</code>，可以使用<code>pipe</code>，但意义不大。主要特点快速调用浏览器，查单词，看系统信息，ip地址，查看进程，生成二维码….</p>
<p>槽点：皮肤略丑。庆幸的是可以自己定义。</p>
<p><img src="/img/tools/1.png" alt="runz"></p>
<h3 id="Everything"><a href="#Everything" class="headerlink" title="Everything"></a><a href="http://www.voidtools.com/" target="_blank" rel="external">Everything</a></h3><p>大家都用过。不多说。值得一提的就是上面的<code>TotalCMD</code> ，<code>Vimdesktop</code>，<code>runz</code>，<code>evertthing</code>是可以互相调用的。<code>everything</code>可以调用<code>TotalCMD</code>，<code>TotalCMD</code>调用<code>everything</code>等等。。。</p>
<h3 id="rime-小小输入法"><a href="#rime-小小输入法" class="headerlink" title="rime/小小输入法"></a><a href="http://rime.im/" target="_blank" rel="external">rime/小小输入法</a></h3><p>个人使用小鹤双拼，双拼加形。无它，唯逼格尔。</p>
<ul>
<li><code>rime</code>输入法，大体上只适合双拼和五笔的人使用，主要原因是词库缺失，但可以自定义(现在整合词库了？)。有两个皮肤很好看。一个安卓风的，一个灰色的。以前没整合在<code>rime</code>里面，现在整合了。</li>
<li>小小输入法，安装完全部只有8M，对就8M。可以说该有的东西全部都有(五笔，双拼加形，明月拼音。。)，不该有的一样没有。如果说非要有槽点的话就是皮肤太丑，庆幸的是也可以自己定义。我之前用<code>ps</code>仿<code>rime</code>那两个我最喜欢的风格做了几个皮肤。可惜用的人太少了。。。</li>
</ul>
<p><img src="/img/tools/2.png" alt="runz"></p>
<p><img src="/img/tools/3.png" alt="runz"></p>
<h3 id="EmEditor"><a href="#EmEditor" class="headerlink" title="EmEditor"></a><a href="https://www.emeditor.com/" target="_blank" rel="external">EmEditor</a></h3><p>岛国的一个编辑器，我一般用来替代自带记事本。优点，处理大文件非常快。查找支持正则查找替换(正则学的渣渣)，可以直接打开浏览器，命令行等等。个人喜欢把皮肤改成自己喜欢的风格，当作记事本，查看东西。</p>
<p><img src="/img/tools/4.png" alt="runz"></p>
<h3 id="Typora"><a href="#Typora" class="headerlink" title="Typora"></a><a href="https://www.typora.io/" target="_blank" rel="external">Typora</a></h3><p>国人写的<code>markdown</code>编辑器，实时渲染，速度略慢，应该是用<code>node</code>桌面应用<code>electron</code>写的。<code>github</code>风格我很喜欢。</p>
<h3 id="smmatraPDF"><a href="#smmatraPDF" class="headerlink" title="smmatraPDF"></a><a href="https://www.sumatrapdfreader.org/free-pdf-reader.html" target="_blank" rel="external">smmatraPDF</a></h3><p>安装完7M，极简的一个<code>pdf</code>的阅读器。</p>
<h2 id="chrome扩展篇"><a href="#chrome扩展篇" class="headerlink" title="chrome扩展篇"></a>chrome扩展篇</h2><p>现在常用两个浏览器，<code>chrome</code>和<code>360极速</code>，听说<code>chrome</code>现在内核飙到了60了。<code>360</code>最近才有了55内核的.不过不稳定，经常崩溃。</p>
<p>我的主力浏览器是<code>360</code>！！！ </p>
<p>为什么，就因为一个扩展<code>Metro</code>新标签</p>
<p><a href="https://chrome.google.com/webstore/detail/new-metrotab/oogmkbpkoblajkomflhkkdmbfggdmefd" target="_blank" rel="external">Metro新标签</a> : 默认的是花花绿绿<code>metro</code>风格，可以自定义程度极强，只要你会一点点<code>ps</code>功力，就可以做到像我这样的。至于有一点我想不通，就是这个扩展默认是<code>chrome</code>商店的，虽说<code>360</code>也就是<code>chrome</code>内核，但是<code>360</code>安装这个扩展后居然比<code>chrome</code>快，无论是哪个版本 。。。,最后一点也就是最重要的就是<code>360</code>皮肤可以改成<code>edge</code>风格，最后整体可以做到统一风格，就像我下面这样的。</p>
<p><img src="/img/tools/5.png" alt="runz"></p>
<p><a href="https://chrome.google.com/webstore/detail/context-search/eopohglffbpfjebajgdholffljaccfdk" target="_blank" rel="external">Context search</a> : 划词搜索,划一下,在旁边就会出现一个框框,用来浏览东西时候随时可以搜索,看在各个平台的商品价格，看百科，看贴吧，搜音乐，搜电影,<strong>而且完全可以自定义,</strong></p>
<p><img src="/img/tools/6.png" alt="runz"></p>
<p><a href="http://vimium.github.io/" target="_blank" rel="external">Vimium </a> : vim操作浏览器的，没啥好说 。</p>
<p><a href="">todolist</a> : 让浏览器在后台常驻的一个扩展，然后就是各种秒点秒开。。</p>
<h2 id="杂七杂八篇"><a href="#杂七杂八篇" class="headerlink" title="杂七杂八篇"></a>杂七杂八篇</h2><p>flysee : 看图软件，600kb。</p>
<p>Potplayer : 影音播放，好久没看电影了。。</p>
<p>IDM : 国外迅雷，配合云盘，爽爽的。</p>
<p>PartitionGuru : 分区工具</p>
<p>PCMaster : 工具箱</p>
<p>ccleaner :  清理</p>
<p>Total Uninstall : 卸载工具 </p>
<p>ashampoo_snap ：阿香婆截图，替代少许ps和xmind</p>
<p>Photoshop CC :  修啊修</p>
<p>xmind : 脑图</p>
<p>sandboxie : 沙盘，裸奔喽。。</p>
<p>FSCapture : 录像和截图，用来录制小视频啥的，体积很小。强力推荐。</p>
<p>gif录制  : GifCam/LICEcap/ScreenGif,  现在已经很少用，没需求。</p>
<p>Carnac : 按键显示, 配合录屏工具使用。</p>
<p>Inpaint : 去水印，ps有些水印去除很费劲。</p>
<p>USBKiller ： 对，这4年，我唯一中过的毒就是舍友的u盘。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2017/04/02/利用pipe处理并发/">利用pipe处理并发的可行性</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-04-02
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Node/">Node</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p>以前在某处看到一个用<code>pipe</code>处理数组的。</p>
<p>前因是作者看到另外一篇文章说<code>JS</code>的那些数组操作 (map/ reduce/filter) 啥的，每次调用的时候都会进行一次完整的遍历。试想一下如果有一个第一个数是1，长度是 1亿 的递增为 1 的数组，需要把所有的数组都乘 3，再排除其中的奇数，如果用 (map/filter) 的方法，只要也需要循环 一亿五千万次；那么如果有其他办法能只循环一亿次，是不是节省了大量的内存资源和循环消耗的时间。于是乎作者用流写了一堆<code>Map/Filter/Reduce</code>什么的。。。</p>
<p>看了之后也没在意，昨天晚上想起之前写爬虫的时候，一般都是利用两个<code>queue</code>来控制并发数。效果尚可，就是代码不好看。灵光一现，我艹，node自带了控制供需平衡的pipe，我为啥要用async来控制，而且代码还不好看。于是乎萌生了这个念头。废话不多说，看代码。</p>
<p><strong>目标：爬取图片</strong></p>
<p>网站在此，<a href="https://alpha.wallhaven.cc/" target="_blank" rel="external">wallhaven</a>，一个国外网站，个人非常喜欢，访问速度有点慢。</p>
<p><strong>可读流，源头。获取全部url(50个链接，600张图片左右）</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">const</span> cheerio = <span class="built_in">require</span>(<span class="string">'cheerio'</span>);</div><div class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>);</div><div class="line"><span class="keyword">const</span> stream = <span class="built_in">require</span>(<span class="string">'stream'</span>);</div><div class="line"></div><div class="line"><span class="keyword">const</span> wallhaven = <span class="string">'https://alpha.wallhaven.cc/latest?page='</span>;</div><div class="line"><span class="keyword">const</span> wallhavenPic = <span class="string">'https://wallpapers.wallhaven.cc/wallpapers/full/wallhaven-'</span>;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getWallhavenUrls</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> rs = stream.Readable(&#123;</div><div class="line">        <span class="attr">objectMode</span>: <span class="literal">true</span></div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">50</span>; i++) &#123;</div><div class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">1</span>) &#123;</div><div class="line">            rs.push(wallhaven + i);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    rs.push(<span class="literal">null</span>);</div><div class="line">    <span class="keyword">return</span> rs;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>双工流，获取图片实际地址</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> options = &#123;</div><div class="line">    <span class="attr">url</span>: <span class="string">""</span>,</div><div class="line">    <span class="attr">headers</span>: &#123;</div><div class="line">        <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.102 Safari/537.36'</span></div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getWallhavenPics</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">const</span> trans = stream.Transform(&#123;</div><div class="line">        <span class="attr">readableObjectMode</span>: <span class="literal">true</span>,</div><div class="line">        <span class="attr">writableObjectMode</span>: <span class="literal">true</span></div><div class="line">    &#125;)</div><div class="line">    trans._transform = <span class="function"><span class="keyword">function</span>(<span class="params">chunk, enc, next</span>) </span>&#123;</div><div class="line">    	options.url = chunk;</div><div class="line">        request(options, <span class="function"><span class="keyword">function</span>(<span class="params">err, res, body</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (!err &amp;&amp; res.statusCode == <span class="number">200</span>) &#123;</div><div class="line">                <span class="keyword">var</span> page = res.text;</div><div class="line">                getPicUrl(body).map(<span class="function"><span class="keyword">function</span>(<span class="params">per</span>) </span>&#123;</div><div class="line">                    trans.push(wallhavenPic + per + <span class="string">".jpg"</span>);</div><div class="line">                &#125;);</div><div class="line">                next();</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> trans;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>可写流，写入图片</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">downloadImg</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> ws = stream.Writable(&#123;</div><div class="line">        <span class="attr">objectMode</span>: <span class="literal">true</span></div><div class="line">    &#125;)</div><div class="line">    <span class="keyword">var</span> i = <span class="number">0</span>;</div><div class="line">    ws._write = <span class="function"><span class="keyword">function</span>(<span class="params">chunk, enc, next</span>) </span>&#123;</div><div class="line">        request.head(chunk, <span class="function"><span class="keyword">function</span>(<span class="params">err, res, body</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (err) <span class="built_in">console</span>.log(err);</div><div class="line">            request(chunk).on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (err) &#123;</div><div class="line">                    <span class="built_in">console</span>.log(<span class="string">'err'</span> + err)</div><div class="line">                &#125;</div><div class="line">            &#125;).pipe(fs.createWriteStream(<span class="string">'G://pics//'</span> + i++ + <span class="string">'.jpg'</span>));</div><div class="line">            next();</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ws;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>一个工具方法，获取地址</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPicUrl</span>(<span class="params">page</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> urls = []</div><div class="line">    <span class="keyword">var</span> $ = cheerio.load(page);</div><div class="line">    $(<span class="string">'.thumb-listing-page'</span>).find(<span class="string">'.preview'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        urls.push($(<span class="keyword">this</span>).attr(<span class="string">'href'</span>).substr(<span class="number">37</span>));</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> urls;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>最后把他们连接起来</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">getWallhavenUrls()</div><div class="line">    .pipe(getWallhavenPics())</div><div class="line">    .pipe(downloadImg())</div></pre></td></tr></table></figure>
<p>cpu稳定在3%以下，mem稳定在30M以下，除了一些连接太慢，console了timeout，其他完美。最后看看成果 </p>
<p><img src="/img/stream/stream.png" alt="stream"></p>

        
      
    </div>

    

    

  </article>

    
  </section>

  
  <nav class="pagination">
    
    
      <a class="next" href="/page/2/">
        <span class="next-text">下一页</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


          </div>
          

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:750701913@qq.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/5196666qwe" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">ChenXing</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  </body>
</html>
