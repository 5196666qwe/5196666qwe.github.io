
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ChenXing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="ChenXing">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="ChenXing">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ChenXing">
  
    <link rel="alternative" href="/atom.xml" title="ChenXing" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
</head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ChenXing</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="yoursite.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main">
  
    <article id="post-打造轻量web框架02" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/15/打造轻量web框架02/" class="article-date">
  <time datetime="2016-10-15T15:50:50.000Z" itemprop="datePublished">2016-10-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/15/打造轻量web框架02/">打造轻量web框架02</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>前面我们完成了一个简单MVC框架了，已经能完成响应，依赖注入，返回渲染数据了，此外，还有一些非常好的特性没有提供，就是AOP。我们可以使用这个特性来实现一些横向拦截操作。比如性能分析，日志收集，安全控制。把这些功能抽离出来之后，再通过“动态织入”的方式掺入业务逻辑模块中。这样做的好处首先是可以保持业务逻辑模块的纯净和高内聚性，其次是可以很方便地复用日志统计等功能模块。</p>
<p>先看看Js是怎么实现AOP，然后我们再看看java是怎么苦逼实现的。最后我们来把这个特性揉进mvc里。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Function</span>.prototype.before = <span class="function"><span class="keyword">function</span> (<span class="params">beforefn</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> __self = <span class="keyword">this</span>; <span class="comment">// 保存原函数的引用</span></div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="comment">// 返回包含了原函数和新函数的"代理"函数</span></div><div class="line">        beforefn.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>); <span class="comment">// 执行新函数，修正 this</span></div><div class="line">        <span class="keyword">return</span> __self.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>); <span class="comment">// 执行原函数</span></div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="built_in">Function</span>.prototype.after = <span class="function"><span class="keyword">function</span> (<span class="params">afterfn</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> __self = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> ret = __self.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</div><div class="line">        afterfn.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</div><div class="line">&#125;;</div><div class="line">func = func.before(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>);</div><div class="line">&#125;).after(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>);</div><div class="line">&#125;);</div><div class="line">func();</div></pre></td></tr></table></figure>
<p>对，你没看错就是这么简单。</p>
<p>然后我们来看看java是怎么实现的.</p>
<h2 id="JDK动态代理和CGlib"><a href="#JDK动态代理和CGlib" class="headerlink" title="JDK动态代理和CGlib"></a>JDK动态代理和CGlib</h2><p>有动态代理就有静态代理.</p>
<p>先写一个Hello World</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Hello</span></span>&#123;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">say</span><span class="params">(String name)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面是一个Hello接口，以下是实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloImpl</span> <span class="keyword">implements</span> <span class="title">Hello</span></span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(String name)</span></span>&#123;</div><div class="line">    System.out.println(<span class="string">"Hello! "</span> + name );</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们要在say方法前面和后面分别需要处理一些逻辑，该怎么作？</p>
<p>要用代理模式，写一个HellpProxy类，让它调用HelloImpl的say方法，在调用前后分别进行逻辑处理即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloProxy</span> <span class="title">implemens</span> <span class="title">Hello</span></span>&#123;</div><div class="line">  <span class="keyword">private</span> Hello hello;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HelloProxy</span><span class="params">()</span></span>&#123;</div><div class="line">    hello = <span class="keyword">new</span> HelloImpl();</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(String name)</span></span>&#123;</div><div class="line">    before();</div><div class="line">    hello.say(name);</div><div class="line">    after();</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</div><div class="line">    System.out.pritln(<span class="string">"before"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</div><div class="line">    System.out.pritln(<span class="string">"after"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后你就知道怎么用了。简单的代理模式使用。</p>
<p>你会发现一个问题，这个代理类显然不是通用的，而且如果接口变了，所有代理类都得变。这是不合理的。所以JDK提供了一个动态代理给我们。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DyncmicProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Object target;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DyncmicProxy</span><span class="params">(Object target)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.target = target;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">		before();</div><div class="line">		Object result = method.invoke(target, args);</div><div class="line">		after();</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</div><div class="line">		System.out.println(<span class="string">"before"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</div><div class="line">		System.out.println(<span class="string">"after"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 DynamicProxy 类中，定义了一个Object类型的 target 变量，它是被代理的对象，通过构造函数来初始化。</p>
<p>DynamicProxy 实现了 InvocationHandler 接口，那么必须实现该接口的 invoke 方法。在该方法中，直接通过反射来去 invoke method，在调用前后分别处理 before 和 after,最后将result返回.</p>
<p>怎么使用？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Hello hello = <span class="keyword">new</span> HelloImpl();	</div><div class="line">		DyncmicProxy dyncmicProxy = <span class="keyword">new</span> DyncmicProxy(hello);	</div><div class="line">		Hello helloProxy = (Hello)Proxy.newProxyInstance(</div><div class="line">				hello.getClass().getClassLoader(), </div><div class="line">				hello.getClass().getInterfaces(), </div><div class="line">				dyncmicProxy</div><div class="line">		);</div><div class="line">		helloProxy.say(<span class="string">"zjl"</span>);	</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重构一下，让这个 DyncmicProxy 类变成通用，避免到处使用 Proxy.newProxyInstance ,而且强制类型转换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DyncmicProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Object target;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DyncmicProxy</span><span class="params">(Object target)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.target = target;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">		before();</div><div class="line">		Object result = method.invoke(target, args);</div><div class="line">		after();</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> (T) Proxy.newProxyInstance(</div><div class="line">				<span class="keyword">this</span>.target.getClass().getClassLoader(),</div><div class="line">				<span class="keyword">this</span>.target.getClass().getInterfaces(), </div><div class="line">				<span class="keyword">this</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</div><div class="line">		System.out.println(<span class="string">"before"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</div><div class="line">		System.out.println(<span class="string">"after"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的动态代理不是万能的，比如说要代理一个没有任何接口的类，它就没有一点卵用了。然后我们看看CGlib这个类库，它是一个在运行期间动态生成字节码的工具，也就是动态生成代理类(改天学学)。先看看怎么用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CGLibProxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span></span>&#123;</div><div class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Class&lt;T&gt; cls)</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> (T) Enhancer.create(cls,<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj,Method method,Object[] args,MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">    before();</div><div class="line">    Object result = proxy.invokeSuper(obj,args);</div><div class="line">    after();</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>需要实现CGlib给我们提供的MethodInterceptor实现类，并填充 intercept 方法。方法中最后一个 MethodProxy 类型的参数 proxy 值得注意. 这是它提供给我们的方法级别代理。我们直接调用 proxy 的 invokeSuper 方法即可。</p>
<p>看看怎么使用.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">  CGLibProxy cgLibProxy = <span class="keyword">new</span> CGLibProxy();</div><div class="line">  Hello helloProxy = cgLibProxy.getProxy(HelloImpl.class);</div><div class="line">  helloProxy.say(<span class="string">"zjl"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="开工前的思考"><a href="#开工前的思考" class="headerlink" title="开工前的思考"></a>开工前的思考</h2><p>学了一项技术，就要应用起来。</p>
<p>停下来思考几分钟，怎么利用这个CGlib对我们mvc框架里面Controller的action进行拦截？</p>
<p>我们记得最后，我们分发器里面返回了注入过的Controller对象，然后调用相应的方法。如果说我们把这个Controller对象换成上面的代理对象，不就ok了？</p>
<p>此时，我们的内心应该是一阵窃喜。然而思考一会儿，这个躁动的心就会平复下来。</p>
<p>得到代理对象很好办，但这里面的before,after方法不应该是写死的，是可以配置的，怎么弄？</p>
<p>对于每个action，不应该只有一组before,after，还有别的拦截器进行某方面处理，怎么解决？</p>
<p>先看看第一大个问题，不是写死的，应该是可以配置的，怎么弄？</p>
<ol>
<li>既然不是写死可配置的，那么肯定是针对这个类的，也就是说before，after应该先存放在某个地方，且这个控制类得知道这两个方法是我的，等到代理的时候取出来调用即可。<ol>
<li>before，after存放在哪里？<ol>
<li>肯定是类的方法啊，用某种类表示某种切面。</li>
</ol>
</li>
<li>怎么让控制类知道这两个方法是我的？<ol>
<li>既然before，after是类的，那么我只要在类上做个标记，告诉这是某控制类的。<ol>
<li>显然用注解做标识是十分合适的。</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>第二个大问题，不应该只有一组before,after，还有别的拦截器进行某方面处理，怎么解决？</p>
<ol>
<li>特别简单啊，我们可以把所有的拦截操作存起来，然后依次取出来即可。类似这样</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj,Method method,Object[] args,MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">		XXXbefore();</div><div class="line"> 		YYYbefore();</div><div class="line">		Object result = proxy.invokeSuper(obj,args);</div><div class="line">		XXXafter();</div><div class="line">  		YYYafter();</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>2.这里面还有个问题，分析方法应该具有控制类信息，也是就说得把控制类和方法当作参数传进来，以便分析。</p>
<p>方法已经有了.剩下的就是实施了。</p>
<p><img src="/img/java_web/java_web2.png" alt="java_web"></p>
<h3 id="定义切面注解"><a href="#定义切面注解" class="headerlink" title="定义切面注解"></a>定义切面注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Aspect &#123;</div><div class="line">    Class&lt;? extends Annotation&gt; value();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注解包含一个value属性，它是一个注解类，用来定义 Controller 这类的注解.</p>
<h3 id="搭建代理框架"><a href="#搭建代理框架" class="headerlink" title="搭建代理框架"></a>搭建代理框架</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Proxy</span> </span>&#123;</div><div class="line">    <span class="function">Object <span class="title">doProxy</span><span class="params">(ProxyChain proxyChain)</span> <span class="keyword">throws</span> Throwable</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Proxy接口包括了一个doProxy方法，传入一个 ProxyChain,用于执行链式操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyChain</span> </span>&#123;</div><div class="line">  	<span class="comment">//目标类</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; targetClass;</div><div class="line">  	<span class="comment">//目标对象</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object targetObject;</div><div class="line">  	<span class="comment">//目标方法</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Method targetMethod;</div><div class="line">  	<span class="comment">//方法代理</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MethodProxy methodProxy;</div><div class="line">  	<span class="comment">//方法参数</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] methodParams;</div><div class="line">	<span class="comment">//代理列表</span></div><div class="line">    <span class="keyword">private</span> List&lt;Proxy&gt; proxyList = <span class="keyword">new</span> ArrayList&lt;Proxy&gt;();</div><div class="line">  	<span class="comment">//索引</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> proxyIndex = <span class="number">0</span>;</div><div class="line">	<span class="comment">//构造方法，set，get省略。</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">doProxyChain</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">        Object methodResult= <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (proxyIndex &lt; proxyList.size()) &#123;</div><div class="line">            methodResult = proxyList.get(proxyIndex++).doProxy(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            methodResult = methodProxy.invokeSuper(targetObject, methodParams);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> methodResult;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代理管理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//创建所有代理对象</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyManager</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createProxy</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; targetClass, <span class="keyword">final</span> List&lt;Proxy&gt; proxyList)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (T) Enhancer.create(targetClass, <span class="keyword">new</span> MethodInterceptor() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ProxyChain(targetClass, o, method, methodProxy, objects, proxyList).doProxyChain();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>谁来调用ProxyManager呢？当然是切面类了，因为在切面类中，需要在目标别调用的前后增加相应的逻辑。我们有必要写一个抽象类，提供一个模板方法，并在该抽象类的具体实现中扩展相应方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AspectProxy</span> <span class="keyword">implements</span> <span class="title">Proxy</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">doProxy</span><span class="params">(ProxyChain proxyChain)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"></div><div class="line">        Object result = <span class="keyword">null</span>;</div><div class="line">        Class&lt;?&gt; cls = proxyChain.getTargetClass();</div><div class="line">        Method method = proxyChain.getTargetMethod();</div><div class="line">        Object[] params = proxyChain.getMethodParams();</div><div class="line">        </div><div class="line">        begin();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (intercept(cls, method, params)) &#123;</div><div class="line">                before(cls, method, params);</div><div class="line">                result = proxyChain.doProxyChain();</div><div class="line">                after(cls, method, params);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                result = proxyChain.doProxyChain();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            error(cls, method, params, e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">finally</span> &#123;</div><div class="line">            end();    </div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] params)</span> <span class="keyword">throws</span> Throwable</span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] params)</span> <span class="keyword">throws</span> Throwable</span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">intercept</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] params)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] params, Exception e)</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这些抽象方法可在 AspectProxy 的子类中有选择的实现，就像下面这样的.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Aspect</span>(Controller.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControllerAspect</span> <span class="keyword">extends</span> <span class="title">AspectProxy</span></span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ControllerAspect.class);</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> <span class="keyword">long</span> begin;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Class&lt;?&gt; cls,Method method,Object[] params)</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">		LOGGER.debug(<span class="string">"----begin---"</span>);</div><div class="line">		LOGGER.debug(String.format(<span class="string">"class:%s"</span>, cls.getName()));</div><div class="line">		LOGGER.debug(String.format(<span class="string">"method:%s"</span>, method.getName()));</div><div class="line">		begin = System.currentTimeMillis();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Class&lt;?&gt; cls,Method method,Object[] params)</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">		LOGGER.debug(String.format(<span class="string">"time:%dms"</span>, System.currentTimeMillis() - begin));</div><div class="line">		LOGGER.debug(<span class="string">"===end+===="</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="加载AOP框架"><a href="#加载AOP框架" class="headerlink" title="加载AOP框架"></a>加载AOP框架</h3><p>上面的逻辑基本就差不多了。剩下的就主要是把上一节的普通对象，变成代理对象即可。</p>
<p>由于我们需要扩展 AspectProxy抽象类的所有具体类,此外还需获取带有Aspect注解的所有类，因为需要在ClassHelper中添加两个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 类操作助手类</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">//加载所有包下的类放到set里面 可获取service controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassHelper</span> </span>&#123;</div><div class="line">	...</div><div class="line">   <span class="comment">//获取报名下所有superclss的 子类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetBySuper(Class&lt;?&gt; superClass) &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</div><div class="line">            <span class="keyword">if</span> (superClass.isAssignableFrom(superClass) &amp;&amp; !superClass.equals(cls)) &#123;</div><div class="line">                classSet.add(cls);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取带某注解的类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetByAnnotation(Class&lt;? extends Annotation&gt; annotationClass) &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</div><div class="line">            <span class="keyword">if</span> (cls.isAnnotationPresent(annotationClass)) &#123;</div><div class="line">                classSet.add(cls);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后的AopHelper类，看看它完成了什么工作，先获取切面class，以及对应的要增强所有的class，然后获取要增强class和对应增强的所有代理class。最后根据这个映射关系得到代理对象，替代原来对象即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AopHelper</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER  = LoggerFactory.getLogger(AopHelper.class);</div><div class="line">	</div><div class="line">	<span class="keyword">static</span>&#123;</div><div class="line">		<span class="keyword">try</span>&#123;</div><div class="line">			<span class="comment">//获取切面类和切面类上面注解集合 比如（controller)  切面和对应增强的class类，一个切面可以增强n个类</span></div><div class="line">			Map&lt;Class&lt;?&gt;,Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap = createProxyMap();</div><div class="line">			<span class="comment">//获取controller和该切面对象列表  比如(controllerraspect) 一个目标类可以被n个切面代理增强</span></div><div class="line">			Map&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt; targetMap = createTargetMap(proxyMap);</div><div class="line">			<span class="keyword">for</span> ( Map.Entry&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt; targetEntry : targetMap.entrySet())&#123;</div><div class="line">				Class&lt;?&gt; targetClass  = targetEntry.getKey();</div><div class="line">				List&lt;Proxy&gt; proxyList = targetEntry.getValue();</div><div class="line">													<span class="comment">// controller  切面对象</span></div><div class="line">				Object proxy = ProxyManager.createProxy(targetClass,proxyList);</div><div class="line">				BeanHelper.setBean(targetClass, proxy);</div><div class="line">			&#125;</div><div class="line">		&#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">			LOGGER.error(<span class="string">"aop failure"</span>,e);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; createProxyMap() <span class="keyword">throws</span> Exception &#123;</div><div class="line">        Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt;();</div><div class="line">        <span class="comment">//获取所有 AspectProxy的子类 比如controllerAspect</span></div><div class="line">        Set&lt;Class&lt;?&gt;&gt; proxyClassSet = ClassHelper.getClassSetBySuper(AspectProxy.class);</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; proxyClass : proxyClassSet) &#123;</div><div class="line">            <span class="keyword">if</span> (proxyClass.isAnnotationPresent(Aspect.class)) &#123;</div><div class="line">                Aspect aspect = proxyClass.getAnnotation(Aspect.class);</div><div class="line">                <span class="comment">//获取所有注解为aspect的value 也就是 注解Controller的类</span></div><div class="line">                Set&lt;Class&lt;?&gt;&gt; targetClassSet = createTargetClassSet(aspect);</div><div class="line">                			<span class="comment">// controlelraspect  List&lt;CustomerConstoller&gt;</span></div><div class="line">                proxyMap.put(proxyClass, targetClassSet);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> proxyMap;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt; createTargetMap(Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap) <span class="keyword">throws</span> Exception&#123;</div><div class="line">        Map&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt; targetMap = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyEntry : proxyMap.entrySet()) &#123;</div><div class="line">            Class&lt;?&gt; proxyClass = proxyEntry.getKey();</div><div class="line">            Set&lt;Class&lt;?&gt;&gt; proxyClassSet = proxyEntry.getValue();</div><div class="line">            <span class="keyword">for</span> (Class&lt;?&gt; targetClass : proxyClassSet) &#123;</div><div class="line">                Proxy proxy = (Proxy) proxyClass.newInstance();</div><div class="line">                <span class="keyword">if</span> (targetMap.containsKey(targetClass)) &#123;</div><div class="line">                    targetMap.get(targetClass).add(proxy);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                    List&lt;Proxy&gt; proxyList = <span class="keyword">new</span> ArrayList&lt;Proxy&gt;();</div><div class="line">                    proxyList.add(proxy);</div><div class="line">                    targetMap.put(targetClass, proxyList);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> targetMap;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取带Aspect类放到set里面</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; createTargetClassSet(Aspect aspect) <span class="keyword">throws</span> Exception &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; targetClassSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="comment">//interface com.chenxing.online.annotation.Controller</span></div><div class="line">        Class&lt;? extends Annotation&gt; annotation = aspect.value();</div><div class="line">        <span class="keyword">if</span> (annotation != <span class="keyword">null</span> &amp;&amp; !annotation.equals(Aspect.class)) &#123;</div><div class="line">        	<span class="comment">//获取所有注解为controller的类</span></div><div class="line">            targetClassSet.addAll(ClassHelper.getClassSetByAnnotation(annotation));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> targetClassSet;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">new</span> AopHelper();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2016/10/15/打造轻量web框架02/" data-id="cj8lswfnt002g5svbtbm4hvuj" class="article-share-link" data-share="baidu" data-title="打造轻量web框架02">Share</a>
      

      
        <a href="http://yoursite.com/2016/10/15/打造轻量web框架02/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-打造轻量web框架01" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/15/打造轻量web框架01/" class="article-date">
  <time datetime="2016-10-15T12:50:50.000Z" itemprop="datePublished">2016-10-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/15/打造轻量web框架01/">打造轻量web框架</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="理想的controlelr"><a href="#理想的controlelr" class="headerlink" title="理想的controlelr"></a>理想的controlelr</h2><p>我们一直使用原始的<code>servlet</code>来充当mvc模式中的<code>controller</code>。这样做虽然可以实现基本的功能，但是servlet的数量会随着业务功能的扩展而不断增加，这不是我们所期望的。因此有必要减少<code>Servlet</code>的数量，将某类业务交给<code>Controller</code>处理，他负责调用<code>Service</code>的相关方法，并将返回值放入<code>Request</code>和<code>Response</code>。除此之外，<code>Service</code>不是通过<code>new</code>的方法来创建的，而是通过一种<code>依赖注入</code>的方式，让框架为我们来创建所需要的对象。</p>
<p>我们在<code>Controller</code>中使用应该是长这样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//假设说我们是一个客户管理</span></div><div class="line"></div><div class="line"><span class="comment">//处理客户管理相关请求</span></div><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerController</span></span>&#123;</div><div class="line">  </div><div class="line">  <span class="meta">@Inject</span></div><div class="line">  <span class="keyword">private</span> CustomerService customerService;</div><div class="line">  </div><div class="line">  <span class="meta">@Action</span>(<span class="string">"get:/xxxxx"</span>)</div><div class="line">  <span class="function"><span class="keyword">public</span> View <span class="title">index</span><span class="params">(Param param)</span></span>&#123;</div><div class="line">    List&lt;Customer&gt; customerList = customerService.getCustomerList();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> View(<span class="string">"customer.jsp"</span>).addModel(<span class="string">"customerList"</span>,customerList);</div><div class="line">  &#125;</div><div class="line">  ....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过<code>Controller</code>注解来定义<code>Controller</code>类，类中通过<code>inject</code>注解定义一系列<code>Service</code>成员变量，这就是<code>依赖注入</code>，此外，有一系列<code>Action</code>注解所定义的方法，在方法中，调用了<code>Service</code>成员变量的方法完成具体业务逻辑。若是返回<code>View</code>对象，则表示<code>jsp</code>页面，若是返回了<code>Data</code>对象，则表示<code>JSON</code>数据。</p>
<p>让我们看看完成这个<code>controlle</code>r需要干几件事。</p>
<ol>
<li><p>最基本的定义注解类，<code>Controller</code>作为标识，<code>inject</code>用来依赖注入，<code>Action</code>表示请求方法和路径。</p>
</li>
<li><p>首先<code>servlet</code>应该统一处理，获取请求方法和路径，那么问题来了，请求到这个方法应该怎么执行？</p>
<ol>
<li>我们自然而然就能想到利用反射，获取相应参数，调用该方法。问题来了，我们是要请求的时候，实例化相应类，完成IOC,在调用方法？</li>
<li>显然这么做不合理，那么多请求，都反射，实例化类，很浪费资源的。我们换条道，提前把实例化过的类保存起来。等到请求的时候取出来，这么做合理很多。</li>
</ol>
</li>
<li><p>跟据上面的推测，我们首先要得到这些标识为<code>Controlle</code>r的类。怎么做？还是反射。获取注解。问题是<code>Class</code>对象哪来的？三种方法，class.forName();Object.class;object.getClass()</p>
<ol>
<li>不假思索，我们就能排除后面两种方法。那么如何获取包名+类名？遍历一下应用包目录，获取即可。然后就有了<code>class</code>对象。</li>
<li>有了<code>class</code>对象，根据注解获取Controller的<code>Class</code>对象，就有了相应的实例化对象。然后依赖注入相应类。即可。</li>
<li>最后的最后，<code>servlet</code>得到请求方法，方法路径获取对应参数，得到实例化对象，调用方法，根据方法的返回值，返回响应页面。o了。</li>
</ol>
</li>
<li>我们的思想已经到位了，剩下的就是实施了。</li>
</ol>
<p><img src="/img/java_web/java_web.png" alt="原型"></p>
<p>这大概是一张流程图，下面代码分别看不懂，先看看这个。</p>
<h2 id="定义框架配置项以及加载"><a href="#定义框架配置项以及加载" class="headerlink" title="定义框架配置项以及加载"></a>定义框架配置项以及加载</h2><p>假设我们搭建是一个<code>web</code>的<code>maven</code>项目，那么在<code>src/main/resources</code>目录下，创建一个名为<code>smart.properties</code>的配置文件，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">smart.framework.jdbc.driver = com.mysql.jdbc.Driver</div><div class="line"></div><div class="line">smart.framework.jdbc.url= jdbc:mysql:<span class="comment">//localhost:3306/demo</span></div><div class="line">smart.framework.jdbc.username= root</div><div class="line">smart.framework.jdbc.password= <span class="number">123456</span></div><div class="line"></div><div class="line">smart.framework.app.base_package = com.xxxx.yyy   <span class="comment">//该项目的基础包名</span></div><div class="line">smart.framework.app.jsp_path= /WEB-INF/view/    <span class="comment">//jsp的路径</span></div><div class="line">smart.framework.app.asset_path= /asset/       <span class="comment">//静态文件资源路径，js或css。。。</span></div></pre></td></tr></table></figure>
<p>配置文件有了，就可以根据配置项的名称来获取配置项的值.我们创建一个<code>ConfigConstant</code>的常量类，维护配置文件中的相关配置名称</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigConstant</span> </span>&#123;</div><div class="line"></div><div class="line">    String CONFIG_FILE = <span class="string">"smart.properties"</span>;</div><div class="line"></div><div class="line">    String JDBC_DRIVER = <span class="string">"smart.framework.jdbc.driver"</span>;</div><div class="line">    String JDBC_URL = <span class="string">"smart.framework.jdbc.url"</span>;</div><div class="line">    String JDBC_USERNAME = <span class="string">"smart.framework.jdbc.username"</span>;</div><div class="line">    String JDBC_PASSWORD = <span class="string">"smart.framework.jdbc.password"</span>;</div><div class="line"></div><div class="line"></div><div class="line">    String APP_BASE_PACKAGE = <span class="string">"smart.framework.app.base_package"</span>;</div><div class="line">    String APP_JSP_PATH = <span class="string">"smart.framework.app.jsp_path"</span>;</div><div class="line">    String APP_ASSET_PATH = <span class="string">"smart.framework.app.asset_path"</span>;</div><div class="line"></div><div class="line">    String APP_UPLOAD_LIMIT = <span class="string">"smart.framework.app.upload_limit"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后我们用一个<code>ConfigHelper</code>类，定义一些静态方法来分别获取配置文件中的配置项。当然了真正实现的是<code>PropsUtil</code>我们的助手类了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigHelper</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Properties CONFIG_PROPS = PropsUtil.loadProps(ConfigConstant.CONFIG_FILE);</div><div class="line"></div><div class="line">    <span class="comment">//获取jdbc是驱动</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getJdbcDriver</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PropsUtil.getString(CONFIG_PROPS, ConfigConstant.JDBC_DRIVER);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取jdbc url</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getJdbcUrl</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PropsUtil.getString(CONFIG_PROPS, ConfigConstant.JDBC_URL);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//获取数据库username</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getJdbcUserName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PropsUtil.getString(CONFIG_PROPS, ConfigConstant.JDBC_USERNAME);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//获取数据库password</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getJdbcPassword</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PropsUtil.getString(CONFIG_PROPS, ConfigConstant.JDBC_PASSWORD);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//获取应用包名 也就是com.chenxing.online</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAppBasePackage</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PropsUtil.getString(CONFIG_PROPS, ConfigConstant.APP_BASE_PACKAGE);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">  	<span class="comment">//这里配置项目提供了默认值</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAppJspPath</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PropsUtil.getString(CONFIG_PROPS, ConfigConstant.APP_JSP_PATH, <span class="string">"/WEB-INF/view/"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAppAssetPath</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PropsUtil.getString(CONFIG_PROPS, ConfigConstant.APP_ASSET_PATH, <span class="string">"/asset/"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>PropsUtil</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PropsUtil</span> </span>&#123;</div><div class="line">  	<span class="comment">//这里使用了logger日志系统来打印日志，可以不管</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(PropsUtil.class);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Properties <span class="title">loadProps</span><span class="params">(String fileName)</span> </span>&#123;</div><div class="line">        Properties props = <span class="keyword">null</span>;</div><div class="line">        InputStream is = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            is = Thread.currentThread().getContextClassLoader().getResourceAsStream(fileName);</div><div class="line">            <span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(fileName + <span class="string">" file is not found"</span>);</div><div class="line">            &#125;</div><div class="line">            props = <span class="keyword">new</span> Properties();</div><div class="line">            props.load(is);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            LOGGER.error(<span class="string">"load properties file failure"</span>, e);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    is.close();</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                    LOGGER.error(<span class="string">"close input stream failure"</span>, e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> props;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getString</span><span class="params">(Properties props, String key)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> getString(props, key, <span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getString</span><span class="params">(Properties props, String key, String defaultValue)</span> </span>&#123;</div><div class="line">        String value = defaultValue;</div><div class="line">        <span class="keyword">if</span> (props.containsKey(key)) &#123;</div><div class="line">            value = props.getProperty(key);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//getInt , getLong等等。。。</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="开发一个类加载器"><a href="#开发一个类加载器" class="headerlink" title="开发一个类加载器"></a>开发一个类加载器</h2><p>我们需要一个<code>类加载器</code>来加载基础包名下所有类，比如使用了某注解的类，实现了某接口的类。</p>
<p>有必要写一个<code>ClassUtil</code>工具类，提供与类操作相关的方法，比如获取类加载器，加载类，获取指定包名下的所有类。代码如下。具体实现有点复杂。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassUtil</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ClassUtil.class);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">//获取类加载器</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Thread.currentThread().getContextClassLoader();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//加载类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className) &#123;</div><div class="line">        <span class="keyword">return</span> loadClass(className, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//加载类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, <span class="keyword">boolean</span> isInitialized) &#123;</div><div class="line">        Class&lt;?&gt; cls = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            cls = Class.forName(className, isInitialized, getClassLoader());</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">            LOGGER.error(<span class="string">"load class failure"</span>, e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> cls;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//获取指定包名下的所有类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSet(String packageName) &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Enumeration&lt;URL&gt; urls = getClassLoader().getResources(packageName.replace(<span class="string">"."</span>, <span class="string">"/"</span>));</div><div class="line">            <span class="comment">//com.xxxx.yyyy</span></div><div class="line">            System.out.println(packageName);</div><div class="line">            <span class="comment">//com/xxxx/yyyy</span></div><div class="line">            System.out.println(packageName.replace(<span class="string">"."</span>, <span class="string">"/"</span>));</div><div class="line">            <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</div><div class="line">                URL url = urls.nextElement();</div><div class="line">                <span class="keyword">if</span> (url != <span class="keyword">null</span>) &#123;</div><div class="line">                    String protocol = url.getProtocol();</div><div class="line">                    <span class="keyword">if</span> (protocol.equals(<span class="string">"file"</span>)) &#123;</div><div class="line">                        String packagePath = url.getPath().replaceAll(<span class="string">"%20"</span>, <span class="string">" "</span>);</div><div class="line">                        addClass(classSet, packagePath, packageName);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (protocol.equals(<span class="string">"jar"</span>)) &#123;</div><div class="line">                        JarURLConnection jarURLConnection = (JarURLConnection)url.openConnection();</div><div class="line">                        <span class="keyword">if</span> (jarURLConnection != <span class="keyword">null</span>) &#123;</div><div class="line">                            JarFile jarFile = jarURLConnection.getJarFile();</div><div class="line">                            <span class="keyword">if</span> (jarFile != <span class="keyword">null</span>) &#123;</div><div class="line">                                Enumeration&lt;JarEntry&gt; jarEntries = jarFile.entries();</div><div class="line">                                <span class="keyword">while</span> (jarEntries.hasMoreElements()) &#123;</div><div class="line">                                    JarEntry jarEntry = jarEntries.nextElement();</div><div class="line">                                    String jarEntryName = jarEntry.getName();</div><div class="line">                                    <span class="keyword">if</span> (jarEntryName.endsWith(<span class="string">".class"</span>)) &#123;</div><div class="line">                                        String className = jarEntryName.substring(<span class="number">0</span>, jarEntryName.lastIndexOf(<span class="string">"."</span>)).replaceAll(<span class="string">"/"</span>, <span class="string">"."</span>);</div><div class="line">                                        doAddClass(classSet, className);</div><div class="line">                                    &#125;</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            LOGGER.error(<span class="string">"get class set failure"</span>, e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//递归来方法添加class文件</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addClass</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; classSet, String packagePath, String packageName)</span> </span>&#123;</div><div class="line">    	File[] files  = <span class="keyword">new</span> File(packagePath).listFiles(<span class="keyword">new</span> FileFilter() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File file )</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> (file.isFile() &amp;&amp; file.getName().endsWith(<span class="string">".class"</span>)) || file.isDirectory();</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">    	</div><div class="line">    	<span class="keyword">for</span> (File file : files)&#123;</div><div class="line">    		String fileName = file.getName();</div><div class="line">    		<span class="keyword">if</span> ( file.isFile() )&#123;</div><div class="line">    			String className = fileName.substring(<span class="number">0</span>,fileName.lastIndexOf(<span class="string">"."</span>));</div><div class="line">    			</div><div class="line">    			<span class="keyword">if</span> (StringUtil.isNotEmpty(packageName))&#123;</div><div class="line">    				className = packageName + <span class="string">"."</span> + className;</div><div class="line">    			&#125;</div><div class="line">    			doAddClass(classSet, className);</div><div class="line">    		&#125; <span class="keyword">else</span> &#123;</div><div class="line">    			String subPackagePath = fileName;</div><div class="line">    			<span class="keyword">if</span> (StringUtil.isNotEmpty(packagePath))&#123;</div><div class="line">    				subPackagePath = packagePath + <span class="string">"/"</span> + subPackagePath;</div><div class="line">    			&#125;</div><div class="line">    			String subPackageName = fileName;</div><div class="line">    			<span class="keyword">if</span> (StringUtil.isNotEmpty(packageName))&#123;</div><div class="line">    				subPackageName = packageName + <span class="string">"."</span> + subPackageName;</div><div class="line">    			&#125;</div><div class="line">    			addClass(classSet, subPackagePath, subPackageName);</div><div class="line">    		&#125;</div><div class="line">    	&#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//真正实现加载class的方法</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doAddClass</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; classSet, String className)</span> </span>&#123;</div><div class="line">        Class&lt;?&gt; cls = loadClass(className, <span class="keyword">false</span>);</div><div class="line">        classSet.add(cls);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于我们在<code>smart.properties</code>配置文件中指定了<code>smart.framework.app.base_package</code>， 它是整个应用的基础包名。通过<code>ClassUtil</code>加载的类都需要基于该基础包名。所以有必要提供<code>ClassHelper</code>助手类，让它分别获取应用包下的所有类，应用包名下所有的<code>Service</code>类，应用包名下所有的<code>Controller</code>类。此外我们可以将带有<code>Controller</code>注解和<code>Service</code>注解的类所产生的对象理解成<code>Bean</code>，所有有必要在该类中增加一个获取应用包名下所有<code>Bean</code>的方法。<code>ClassHelper</code>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 类操作助手类</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">//加载所有包下的类放到set里面 可获取service controller</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassHelper</span> </span>&#123;</div><div class="line">	<span class="comment">//定义类集合 用于存放所加载的类</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;Class&lt;?&gt;&gt; CLASS_SET;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        String basePackage = ConfigHelper.getAppBasePackage();</div><div class="line">        CLASS_SET = ClassUtil.getClassSet(basePackage);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSet() &#123;</div><div class="line">        <span class="keyword">return</span> CLASS_SET;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取应用包名下所有service类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getServiceClassSet() &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</div><div class="line">            <span class="keyword">if</span> (cls.isAnnotationPresent(Service.class)) &#123;</div><div class="line">                classSet.add(cls);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//获取应用包名下所有controller类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getControllerClassSet() &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</div><div class="line">            <span class="keyword">if</span> (cls.isAnnotationPresent(Controller.class)) &#123;</div><div class="line">                classSet.add(cls);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//获取应用包名下所有bean类 包括 service controller</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getBeanClassSet() &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        classSet.addAll(getControllerClassSet());</div><div class="line">        classSet.addAll(getServiceClassSet());</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetBySuper(Class&lt;?&gt; superClass) &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</div><div class="line">            <span class="keyword">if</span> (superClass.isAssignableFrom(superClass) &amp;&amp; !superClass.equals(cls)) &#123;</div><div class="line">                classSet.add(cls);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetByAnnotation(Class&lt;? extends Annotation&gt; annotationClass) &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</div><div class="line">            <span class="keyword">if</span> (cls.isAnnotationPresent(annotationClass)) &#123;</div><div class="line">                classSet.add(cls);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样我们使用<code>ClassHelper</code>封装了<code>ClassUtil</code>，并提供了一系列方法。通过合叶方法可以直接获取我们想要的类集合。我们接下来会继承使用到这个类。</p>
<h2 id="定义注解类"><a href="#定义注解类" class="headerlink" title="定义注解类"></a>定义注解类</h2><p>我们目标是在控制器类上使用<code>Controller</code>注解，来控制类的方法上使用<code>Action</code>注解，在服务类上使用<code>service</code>注解，在控制类中可使用<code>inject</code>注解来将服务类依赖注入.</p>
<p>控制器注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Controller &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Action注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.METHOD)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Action &#123;</div><div class="line">	<span class="comment">//请求类型和路径</span></div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>service注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Service &#123;	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Inject注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.FIELD)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Inject &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="实现Bean容器"><a href="#实现Bean容器" class="headerlink" title="实现Bean容器"></a>实现Bean容器</h2><p>上面我们实现了<code>ClassHelper</code>类，它可以获取所加载的类，但无法通过类实例化对象。因此需要一个反射类，让它封装<code>java</code>反射相关的api，对外提供更好的工具方法。类名可叫做<code>ReflectionUtil</code>，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 反射工具类</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectionUtil</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ReflectionUtil.class);</div><div class="line">	<span class="comment">//创建实例</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newInstance</span><span class="params">(Class&lt;?&gt; cls)</span> </span>&#123;</div><div class="line">        Object instance = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            instance = cls.newInstance();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            LOGGER.error(<span class="string">"new instance failure"</span>, e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//调用方法</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">invokeMethod</span><span class="params">(Object obj, Method method, Object... args)</span> </span>&#123;</div><div class="line">        Object result = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            method.setAccessible(<span class="keyword">true</span>);</div><div class="line">            result = method.invoke(obj, args);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            LOGGER.error(<span class="string">"invoke method failure"</span>, e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//设置成员变量的值</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, Field field, Object value)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            field.setAccessible(<span class="keyword">true</span>);</div><div class="line">            field.set(obj, value);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            LOGGER.error(<span class="string">"set field failure"</span>, e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着我们需要获取所有被框架管理的<code>Bean</code>类(也就是带Controller注解和Service注解的类。上面ClassHelper已经帮我们获取了)。随后需要循环调用<code>ReflectionUtil</code>类的<code>newInstance</code>方法，来实例化对象，最后将每次创建的对象存放在一个静态的<code>Map&lt;Class&lt;?&gt;,Object&gt;</code>中。我们需要随时获取该<code>Map</code>，还需要通过该<code>Map</code>的<code>Key</code>来获取所对应的    <code>bean</code>对象。</p>
<p>BeanHelper类代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//获取所有带service和controller的类，保存到 map里面 key是 类 value是实体</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanHelper</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt; BEAN_MAP = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, Object&gt;();</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">    	System.out.println(<span class="string">"我是beanhelper"</span>);</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; beanClassSet = ClassHelper.getBeanClassSet();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; beanClass : beanClassSet) &#123;</div><div class="line">            Object obj = ReflectionUtil.newInstance(beanClass);</div><div class="line">            BEAN_MAP.put(beanClass, obj);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//获取bean映射</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, Object&gt; getBeanMap() &#123;</div><div class="line">        <span class="keyword">return</span> BEAN_MAP;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//获取bean实例</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; cls)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!BEAN_MAP.containsKey(cls)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"can not get by class: "</span> + cls);</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> (T) BEAN_MAP.get(cls);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="实现依赖注入功能"><a href="#实现依赖注入功能" class="headerlink" title="实现依赖注入功能"></a>实现依赖注入功能</h2><p>还记得之前定义的<code>Inject</code>注解吗？我们就要用它来实现<code>Service</code>实例化。</p>
<p>我们自己不用通过<code>new</code>的方法来实例化，而是通过框架自己来实例化，像这样的实例化过程称为<code>Ioc</code>控制反转，也叫依赖注入。可以理解成一个类需要依赖的成员注入到这个类中。怎么实现？</p>
<p>最简单的方法，通过上面写的<code>BeanHelper</code>获取所有的<code>Bean Map</code>，然后遍历，取出来<code>Bean 类</code>和<code>Bean 实例</code></p>
<p>进而通过反射获取类中所有的成员变量，继续遍历这些所有成员变量，在循环中判断该成员是否带有<code>Inject</code>注解</p>
<p>然后取出该实例，通过反射实例化。</p>
<p>我们把上面这个逻辑写成一个名称<code>IocHelper</code>的类，代码如下；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 依赖注入助手类</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IocHelper</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">    	System.out.println(<span class="string">"我是ｉｏｃ"</span>);</div><div class="line">        Map&lt;Class&lt;?&gt;, Object&gt; beanMap = BeanHelper.getBeanMap();</div><div class="line">        <span class="keyword">if</span> (CollectionUtil.isNotEmpty(beanMap)) &#123;</div><div class="line">            <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; beanEntry : beanMap.entrySet()) &#123;</div><div class="line">                Class&lt;?&gt; beanClass = beanEntry.getKey();</div><div class="line">                Object beanInstance = beanEntry.getValue();</div><div class="line">                Field[] beanFields = beanClass.getDeclaredFields();</div><div class="line">                <span class="keyword">if</span> (ArrayUtil.isNotEmpty(beanFields)) &#123;</div><div class="line">                    <span class="keyword">for</span> (Field beanField : beanFields) &#123;</div><div class="line">                        <span class="keyword">if</span> (beanField.isAnnotationPresent(Inject.class)) &#123;</div><div class="line">                            Class&lt;?&gt; beanFieldClass = beanField.getClass();</div><div class="line">                            Object beanFieldInstance = ReflectionUtil.newInstance(beanField.getType());</div><div class="line">                            <span class="keyword">if</span> (beanFieldInstance != <span class="keyword">null</span>) &#123;</div><div class="line">                                ReflectionUtil.setField(beanInstance, beanField, beanFieldInstance);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>需要注意的是，此时<code>Ioc</code>框架中所管理的对象都是单例的，由于<code>Ioc</code>框架底层是从<code>BeanHelper</code>来获取map的，二map中的对象都是事先创建好并放入这个<code>bean</code>容器的，所有对象都是单例的。</p>
<h2 id="加载Controller"><a href="#加载Controller" class="headerlink" title="加载Controller"></a>加载Controller</h2><p>我们需要创建一个<code>ControllerHelper</code>类，让它来处理如下逻辑：<br>通过<code>ClassHelper</code>，我们可以获取所有定义了<code>Controller</code>注解的类，可以通过反射获取该类<br>中所有带有<code>Action</code>注解的方法，获取Action注解中的请求表达式，进而获取请求方法与请求路径，封装一个请求对象（Request）与处理对象（Handler)，最后将<code>Request</code>与<code>Handler</code>建立一个映射关系，放入一个<code>ActionMap</code>中，并提供一个可根据请求方法与请求路径获取处理对象的方法。</p>
<p>首先定义一个名为Request的类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//封装请求</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String requestMethod;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String requestPath;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Request</span><span class="params">(String requsetMethod, String requestPath)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.requestMethod = requsetMethod;</div><div class="line">        <span class="keyword">this</span>.requestPath = requestPath;</div><div class="line">    &#125;</div><div class="line">  <span class="comment">//set,get,hascode,equals</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后编写一个叫做<code>Handler</code>的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//封装action信息</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Class&lt;?&gt; controllerClass;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Method actionMethod;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Class&lt;?&gt; controllerClass, Method actionMethod)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.controllerClass = controllerClass;</div><div class="line">        <span class="keyword">this</span>.actionMethod = actionMethod;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//set,get</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后是我们的 ControllerHelper </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//控制助手类</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ControllerHelper</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// 请求和处理器的映射关系 </span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Request, Handler&gt; ACTION_MAP = <span class="keyword">new</span> HashMap&lt;Request, Handler&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; controllerClassSet = ClassHelper.getControllerClassSet();</div><div class="line">        <span class="keyword">if</span> (CollectionUtil.isNotEmpty(controllerClassSet)) &#123;</div><div class="line">            <span class="keyword">for</span> (Class&lt;?&gt; controllerClass : controllerClassSet) &#123;</div><div class="line">                Method[] methods = controllerClass.getDeclaredMethods();</div><div class="line">                <span class="keyword">if</span> (ArrayUtil.isNotEmpty(methods)) &#123;</div><div class="line">                    <span class="keyword">for</span> (Method method : methods) &#123;</div><div class="line">                        <span class="keyword">if</span> (method.isAnnotationPresent(Action.class)) &#123;</div><div class="line">                            Action action = method.getAnnotation(Action.class);</div><div class="line">                            String mapping = action.value();</div><div class="line">                            <span class="keyword">if</span> (mapping.matches(<span class="string">"\\w+:/\\w*"</span>)) &#123;</div><div class="line">                                String[] array = mapping.split(<span class="string">":"</span>);</div><div class="line">                                <span class="keyword">if</span> (ArrayUtil.isNotEmpty(array) &amp;&amp; array.length == <span class="number">2</span>) &#123;</div><div class="line">                                	<span class="comment">//比方说 get:/customer</span></div><div class="line">                                	</div><div class="line">                                	<span class="comment">// get</span></div><div class="line">                                    String requestMethod = array[<span class="number">0</span>];</div><div class="line">                                    <span class="comment">///customer</span></div><div class="line">                                    String requestPath = array[<span class="number">1</span>];</div><div class="line">                                    Request request = <span class="keyword">new</span> Request(requestMethod, requestPath);</div><div class="line">                                    Handler handler = <span class="keyword">new</span> Handler(controllerClass, method);</div><div class="line">                                    ACTION_MAP.put(request, handler);</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Handler <span class="title">getHandler</span><span class="params">(String requestMethod, String requestPath)</span> </span>&#123;</div><div class="line">        Request request = <span class="keyword">new</span> Request(requestMethod, requestPath);</div><div class="line">        <span class="keyword">return</span> ACTION_MAP.get(request);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="请求转发器"><a href="#请求转发器" class="headerlink" title="请求转发器"></a>请求转发器</h2><p>以上过程都是为了这一步准备，我们要编写一个<code>Servlet</code>，让它处理所有的请求。从<code>HttpServletRequest</code>对象中获取请求方法和请求路径，通过<code>ControllerHelper#getHandler</code>方法来获取<code>Handler</code>对象。</p>
<p>拿到<code>Handler</code>对象后，我们可以方便地获取<code>Controller</code>类，进而通过<code>BeanHelper@getBean</code>来获取<code>Controller</code>的实例对象。</p>
<p>最后可以从<code>HttpServletRequest</code>对象中获取所有的请求参数，将其作为我们最开始上面的处理方法的<code>Param</code>对象</p>
<p>此外我们从<code>Handler</code>对象中获取<code>Action</code>的方法返回值，该返回值可能有两种情况</p>
<ol>
<li>若返回值是 View 类型的视图对象，则返回一个 jsp 对象，这也就是为什么我们最开始定义配置选项定义了jsp的路径</li>
<li>若是返回 Data 类型的数据对象， 则返回一个 Json 数据</li>
</ol>
<p>这两个类和我们处理返回的逻辑略去，有兴趣可以看看后面代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@WebServlet</span>(urlPatterns = <span class="string">"/*"</span>, loadOnStartup = <span class="number">0</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig servletConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">    	System.out.println(ClassHelper.a+BeanHelper.a+IocHelper.a+ControllerHelper.a);</div><div class="line">        ServletContext servletContext = servletConfig.getServletContext();</div><div class="line">        ServletRegistration jspServlet = servletContext.getServletRegistration(<span class="string">"jsp"</span>);</div><div class="line">        jspServlet.addMapping(ConfigHelper.getAppJspPath() + <span class="string">"*"</span>);</div><div class="line">        ServletRegistration defaultServlet = servletContext.getServletRegistration(<span class="string">"default"</span>);</div><div class="line">        defaultServlet.addMapping(ConfigHelper.getAppAssetPath() + <span class="string">"*"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line"><span class="comment">//        super.service(req, resp);</span></div><div class="line">        String requestMethod = req.getMethod().toLowerCase();</div><div class="line">        String requestPath = req.getPathInfo();</div><div class="line">        Handler handler = ControllerHelper.getHandler(requestMethod, requestPath);</div><div class="line">        <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</div><div class="line">            Class&lt;?&gt; controllerClass = handler.getControllerClass();</div><div class="line">            Object controllerBean = BeanHelper.getBean(controllerClass);</div><div class="line">            Map&lt;String, Object&gt; paramMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line">            Enumeration&lt;String&gt; paramNames = req.getParameterNames();</div><div class="line">            <span class="keyword">while</span> (paramNames.hasMoreElements()) &#123;</div><div class="line">                String paramName = paramNames.nextElement();</div><div class="line">                String paramValue = req.getParameter(paramName);</div><div class="line">                paramMap.put(paramName, paramValue);</div><div class="line">            &#125;</div><div class="line">            String body = CodecUtil.decodeURL(StreamUtil.getString(req.getInputStream()));</div><div class="line">            <span class="keyword">if</span> (StringUtil.isNotEmpty(body)) &#123;</div><div class="line">                String[] params = StringUtil.splitString(body, <span class="string">"&amp;"</span>);</div><div class="line">                <span class="keyword">if</span> (ArrayUtil.isNotEmpty(params)) &#123;</div><div class="line">                    <span class="keyword">for</span> (String param : params) &#123;</div><div class="line">                        String[] array = StringUtil.splitString(param, <span class="string">"="</span>);</div><div class="line">                        <span class="keyword">if</span> (ArrayUtil.isNotEmpty(array) &amp;&amp; array.length == <span class="number">2</span>) &#123;</div><div class="line">                            String paramName = array[<span class="number">0</span>];</div><div class="line">                            String paramValue = array[<span class="number">1</span>];</div><div class="line">                            paramMap.put(paramName, paramValue);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            Param param = <span class="keyword">new</span> Param(paramMap);</div><div class="line">            Method actionMethod = handler.getActionMethod();</div><div class="line">            Object result = ReflectionUtil.invokeMethod(controllerBean, actionMethod, param);</div><div class="line">            <span class="keyword">if</span> (result <span class="keyword">instanceof</span> View) &#123;</div><div class="line">                View view = (View) result;</div><div class="line">                String path = view.getPath();</div><div class="line">                <span class="keyword">if</span> (StringUtil.isNotEmpty(path)) &#123;</div><div class="line">                    <span class="keyword">if</span>(path.startsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">                        resp.sendRedirect(req.getContextPath()+path);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">else</span> &#123;</div><div class="line">                        Map&lt;String, Object&gt; model = view.getModel();</div><div class="line">                        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : model</div><div class="line">                                .entrySet()) &#123;</div><div class="line">                            req.setAttribute(entry.getKey(), entry.getValue());</div><div class="line">                        &#125;</div><div class="line">                        req.getRequestDispatcher(ConfigHelper.getAppJspPath()+path).forward(req, resp);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (result <span class="keyword">instanceof</span> Data) &#123;</div><div class="line">                    Data data = (Data) result;</div><div class="line">                    Object model = data.getModel();</div><div class="line">                    <span class="keyword">if</span>(model != <span class="keyword">null</span>) &#123;</div><div class="line">                        resp.setContentType(<span class="string">"application/json"</span>);</div><div class="line">                        resp.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div><div class="line">                        PrintWriter writer = resp.getWriter();</div><div class="line">                        String json = JsonUtil.toJson(model);</div><div class="line">                        writer.write(json);</div><div class="line">                        writer.flush();</div><div class="line">                        writer.close();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我们搭建了一个简单的MVC框架，定义了一系列注解：通过Controller注解来定义Controller类；通过Inejct注解来实现依赖注入；通过Action注解来定义Action方法。通过一系列的Helper类来初始化MVC框架：通过DispatcherServlet来处理所有的请求；根据请求方法与请求路径来调用具体的Action方法，判断Action方法的返回值，若为View类型，则跳转到JSP页面，若为Data类型，则返回JSON数据。</p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2016/10/15/打造轻量web框架01/" data-id="cj8lswfnv002l5svb21c6d6tn" class="article-share-link" data-share="baidu" data-title="打造轻量web框架">Share</a>
      

      
        <a href="http://yoursite.com/2016/10/15/打造轻量web框架01/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Java算法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/07/Java算法/" class="article-date">
  <time datetime="2016-10-07T12:50:50.000Z" itemprop="datePublished">2016-10-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/07/Java算法/">Java算法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="JAVA算法"><a href="#JAVA算法" class="headerlink" title="JAVA算法"></a>JAVA算法</h1><p>[TOC]</p>
<h2 id="1-Java常用数据结构实现"><a href="#1-Java常用数据结构实现" class="headerlink" title="1.Java常用数据结构实现"></a>1.Java常用数据结构实现</h2><ol>
<li>下压栈</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//使用数组结构实现</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResizingArrayStack</span>&lt;<span class="title">Item</span>&gt;  <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">Item</span>&gt;</span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> Item[] a = (Item[])<span class="keyword">new</span> Object[<span class="number">1</span>];</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> N = <span class="number">0</span>;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> N == <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> N;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resize</span><span class="params">(<span class="keyword">int</span> max)</span></span>&#123;</div><div class="line"></div><div class="line">		Item[] temp = (Item[])<span class="keyword">new</span> Object[max];</div><div class="line">		</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;N;i++)&#123;</div><div class="line">			temp[i] = a[i];</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		a = temp;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(Item item)</span></span>&#123;</div><div class="line">		<span class="keyword">if</span>(N == a.length)&#123;</div><div class="line">			resize(<span class="number">2</span>*a.length);</div><div class="line">		&#125;</div><div class="line">		a[N++] = item;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> Item <span class="title">pop</span><span class="params">()</span></span>&#123;</div><div class="line">		Item item = a[--N];</div><div class="line">		a[N] = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">if</span>( N&gt;<span class="number">0</span> &amp;&amp; N == a.length/<span class="number">4</span>)&#123;</div><div class="line">			resize(a.length/<span class="number">2</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> item;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Iterator&lt;Item&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ReverseArrayIterator();</div><div class="line">	&#125;	</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ReverseArrayIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">Item</span>&gt;</span>&#123;</div><div class="line">		<span class="keyword">private</span> <span class="keyword">int</span> i = N;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>&#123;</div><div class="line">			<span class="keyword">return</span> i &gt; <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="function"><span class="keyword">public</span> Item <span class="title">next</span><span class="params">()</span></span>&#123;</div><div class="line">			<span class="keyword">return</span> a[--i];</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//使用链表结构实现</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Stack</span>&lt;<span class="title">Item</span>&gt; <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">Item</span>&gt;</span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Node first ; <span class="comment">//栈顶</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> N; <span class="comment">//元素数量</span></div><div class="line">	<span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span></span>&#123;</div><div class="line">		Item item;</div><div class="line">		Node next;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> first == <span class="keyword">null</span>; <span class="comment">//或则： N == 0</span></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> N;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(Item item)</span></span>&#123;</div><div class="line">		Node oldFirst = first;</div><div class="line">		first = <span class="keyword">new</span> Node();</div><div class="line">		first.item = item;</div><div class="line">		first.next = oldFirst;</div><div class="line">		N++;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Item <span class="title">pop</span> <span class="params">()</span></span>&#123;</div><div class="line">		Item item = first.item;</div><div class="line">		first = first.next;</div><div class="line">		N--;</div><div class="line">		<span class="keyword">return</span>  item;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> Iterator&lt;Item&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ListIterator();</div><div class="line">	&#125;	</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ListIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">Item</span>&gt;</span>&#123;</div><div class="line">		<span class="keyword">private</span> Node current = first;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>&#123;</div><div class="line">			<span class="keyword">return</span> current != <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="function"><span class="keyword">public</span> Item <span class="title">next</span><span class="params">()</span></span>&#123;</div><div class="line">			Item item = current.item;</div><div class="line">			current = current.next;</div><div class="line">			<span class="keyword">return</span> item;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2.队列</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Queue</span>&lt;<span class="title">Item</span>&gt; <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">Item</span>&gt;</span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> Node first ;</div><div class="line">	<span class="keyword">private</span> Node last;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> N;</div><div class="line">	<span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span></span>&#123;</div><div class="line">		Item item;</div><div class="line">		Node next;</div><div class="line">	&#125;	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> first == <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> N;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Item item)</span></span>&#123;</div><div class="line">		<span class="comment">//向尾部添加元素</span></div><div class="line">		Node oldlast = last;</div><div class="line">		last = <span class="keyword">new</span> Node();</div><div class="line">		last.item = item;</div><div class="line">		last.next = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">if</span>(isEmpty())&#123;</div><div class="line">			first = last;</div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">			oldlast.next = last;</div><div class="line">		&#125;</div><div class="line">		N++;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> Item <span class="title">dequeue</span><span class="params">()</span></span>&#123;</div><div class="line">		Item item = first.item;</div><div class="line">		first = first.next;</div><div class="line">		<span class="keyword">if</span>(isEmpty())&#123;</div><div class="line">			last = <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		N--;</div><div class="line">		<span class="keyword">return</span> item;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> Iterator&lt;Item&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ListIterator();</div><div class="line">	&#125;	</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ListIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">Item</span>&gt;</span>&#123;</div><div class="line">		<span class="keyword">private</span> Node current = first;</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span></span>&#123;</div><div class="line">			<span class="keyword">return</span> current != <span class="keyword">null</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="function"><span class="keyword">public</span> Item <span class="title">next</span><span class="params">()</span></span>&#123;</div><div class="line">			Item item = current.item;</div><div class="line">			current = current.next;</div><div class="line">			<span class="keyword">return</span> item;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-java排序"><a href="#2-java排序" class="headerlink" title="2.java排序"></a>2.java排序</h2><p>1.排序模板</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Example</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a)</span></span>&#123;</div><div class="line">		<span class="comment">//Interger,Double,String,File,URL都实现了Comparable接口(接口里面有个compareTo方法)</span></div><div class="line">      	<span class="comment">//v&lt;w,v=w,v&gt;w三种情况，分别是-1，0，1</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">less</span><span class="params">(Comparable v, Comparable w)</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> v.compareTo(w) &lt; <span class="number">0</span>;</div><div class="line">      	<span class="comment">//	v&lt;w----&gt; -1 , -1 &lt; 0 , true</span></div><div class="line">      	<span class="comment">//  v=w ---&gt;  0 ,  0 &lt; 0 , false</span></div><div class="line">      	<span class="comment">//  v&gt;w----&gt;  1 ,  1 &lt; 0 , false</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">exch</span><span class="params">(Comparable[] a,<span class="keyword">int</span> i,<span class="keyword">int</span> j)</span></span>&#123;</div><div class="line">      	<span class="comment">//在数组a中,交换i和j的位置，j一般是min</span></div><div class="line">		Comparable t = a[i];</div><div class="line">		a[i] = a[j];</div><div class="line">		a[j] = t;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(Comparable[] a)</span></span>&#123;</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; a.length; i++ )&#123;</div><div class="line">			System.out.println(a[i]);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSorted</span><span class="params">(Comparable[] a)</span></span>&#123;</div><div class="line">		<span class="comment">//测试元素是否有序</span></div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; a.length; i++)&#123;</div><div class="line">			<span class="keyword">if</span>(less(a[i],a[i-<span class="number">1</span>]))&#123;</div><div class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>2.1.冒泡排序</strong></p>
<p>遍历数组，两两比较把最大或则最小的数字被交换到了最后一位,然后继续循环。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bubble_sort</span><span class="params">(Comparable[] a)</span></span>&#123;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; a.length - <span class="number">1</span>; i++) &#123;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; a.length - i - <span class="number">1</span>; j++) &#123;  </div><div class="line">			<span class="keyword">if</span> (less(a[j+<span class="number">1</span>], a[j]))</div><div class="line">				exch(a, j, j+<span class="number">1</span> );</div><div class="line">			&#125;  </div><div class="line">		&#125;  </div><div class="line">	&#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>2.选择排序</strong></p>
<p>首先，找到数组中最小的那个元素，其次，将它和数组的第一各元素交换位置(如果是第一个元素就是最小元素那么它和自己交换)。再次，在剩下的元素中找到最小的元素，将它和数组的第二个元素交换位置。如此反复。故名<code>选择排序</code>，因为它在不断地选择剩余元素之中的最小者。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Selection</span></span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a)</span></span>&#123;</div><div class="line">    <span class="keyword">int</span> N = a.length; <span class="comment">//数组长度</span></div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++)&#123;</div><div class="line">      <span class="comment">//将a[]按升序排列</span></div><div class="line">      <span class="keyword">int</span> min = i;<span class="comment">//最小元素的索引</span></div><div class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt; N; j++)&#123;</div><div class="line">        <span class="comment">//让后面元素分别与最小元素的索引比较,如果小则把索引更新,继续比较</span></div><div class="line">        <span class="keyword">if</span>(less(a[j],a[min]))&#123;</div><div class="line">          min = j;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      exch(a, i, min); <span class="comment">//交换两个元素的位置</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//less(),exch(),isSorted(),main()</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>3.插入排序</strong></p>
<p>人们整理扑克的方法是一张一张的来，将每一长牌插入到其他已经有序的牌中的适当位置。</p>
<p>插入排序法的排序思想就是从数组的第二个元素开始,将数组中的每一个元素按照规则插入到已排好序的数组中以达到排序的目的.一般情况下将数组的第一个元素作为启始元素,从第二个元素开始依次插入.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Insertion</span></span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a)</span></span>&#123;</div><div class="line">    <span class="comment">//将a[]按照升序排列</span></div><div class="line">    <span class="keyword">int</span> N = a.length;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; N; i++)&#123;</div><div class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j = i; j &gt; <span class="number">0</span> &amp;&amp; less(a[j], a[j-<span class="number">1</span>]); j--)&#123;</div><div class="line">        <span class="comment">//每次比较a[j],a[j-1]，看是否小于，小于则交换。然后索引值减小，继续计较</span></div><div class="line">        exch(a, j , j-<span class="number">1</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//less(),exch(),isSorted(),main()</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>4.希尔排序</strong></p>
<p>希尔排序是一种基于插入排序的快速版。对于大规模乱序数组插入排序很慢，因为它只会交换相邻元素，因此元素只能一点一点地从数组的一端到另一端。希尔排序为了加快速度简单地改进了插入排序，交换不相邻的元素以对数组的局部进行排序，并最终用插入排序将局部有序的数组排序。</p>
<p>希尔排序的思想是使数组中任意间隔为h的元素都是有序的。这样的数组被称为h有序数组。一个h有序数组就是h个互相独立的有序数组编织在一起组成的一个数组。</p>
<p>实现希尔排序的一种方法是对于每个h，用插入排序将h各子数组独立排序。但因为子数组是互相独立的，一个更简单的方法是在h-字数组中将每个元素交换到比它大的元素之前去 (将比他大的元素向右移动一格),只需要在插入排序的代码中将移动元素的距离由1改为h即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Shell</span></span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a)</span></span>&#123;</div><div class="line">    <span class="keyword">int</span> N = a.length;</div><div class="line">    <span class="keyword">int</span> h = <span class="number">1</span>;</div><div class="line">    <span class="keyword">while</span>(h &lt; N/<span class="number">3</span>)&#123;</div><div class="line">      h = <span class="number">3</span>*h + <span class="number">1</span>;</div><div class="line">      <span class="comment">//1,4,13,40,121,364,1093 最接近数组长度的。。</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span>(h &gt;= <span class="number">1</span>)&#123;</div><div class="line">      <span class="comment">//将数组变成h有序</span></div><div class="line">      <span class="comment">//首先是使用接近数组的一个增量，比如说你数组长度是16，那么增量是13，那么你会循环三13-0，14-1，15-2</span></div><div class="line">      <span class="comment">//然后第一次增量结束，h减小为4，4-0，5-1，6-2，7-3，8-4，9-5（5-1），10-6(6-2)，11-7(7-3)，12-8(8-4)，13-9(9-5(5-1))，14-10(10-6(6-2))，15-11(11-7(7-3))</span></div><div class="line">      <span class="comment">//之后h变为1，因为前面做的工作已经很多了，那么这里的就快的多了。</span></div><div class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> i = h ; i &lt; N; i++)&#123;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = i; j &gt;=h &amp;&amp; less(a[j], a[j-h]); j-=h)&#123;</div><div class="line">          exch(a, j, j-h);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      h = h/<span class="number">3</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>5.归并排序</strong></p>
<p><code>归并</code>—-即将两个有序的数组归并成一个更大的有序数组。要将一个数组排序可以先将它分成两半分别排序，然后把结果归并起来。</p>
<p>5.1原地归并排序抽象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(Comparable[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> mid, <span class="keyword">int</span> hi)</span></span>&#123;</div><div class="line">  	<span class="comment">//将a[lo..mid] 和 a[mid+1..hi]归并</span></div><div class="line">	<span class="keyword">int</span>  i = lo, j = mid+<span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> k = lo; k &lt;= hi; k++)&#123;</div><div class="line">		aux[k] = a[k];  <span class="comment">//将a[lo..hi]复制到aux[lo..hi]</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> k = lo; k &lt;= hi; k++)&#123;</div><div class="line">		<span class="keyword">if</span>(i &gt; mid)&#123;</div><div class="line">          <span class="comment">//左半边元素用尽取右半边元素</span></div><div class="line">			a[k] = aux[j++];</div><div class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(j &gt; hi)&#123;</div><div class="line">          <span class="comment">//右半边元素用尽取左半边元素,</span></div><div class="line">			a[k] = aux[i++];</div><div class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(less(aux[j], aux[i]))&#123;</div><div class="line">          <span class="comment">//右半边元素小于左半边元素取右半边元素</span></div><div class="line">			a[k] = aux[j++];</div><div class="line">		&#125;<span class="keyword">else</span>&#123;</div><div class="line">          <span class="comment">//右半边元素大于左半边元素取左半边元素</span></div><div class="line">			a[k] = aux[i++];</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>5.2自顶向下的归并排序</p>
<p>基于原地归并的抽象实现了一种递归归并。</p>
<p>如果它能将两个子数组排序，它就能够通过归并两个子数组来将整个数组排序。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Comparable[] aux;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a)</span></span>&#123;</div><div class="line">	aux = <span class="keyword">new</span> Comparable[a.length];</div><div class="line">	sort(a,<span class="number">0</span>,a.length-<span class="number">1</span>);</div><div class="line">  	<span class="comment">//这里为什么是a.length-1个？</span></div><div class="line">  	<span class="comment">//一方面保证了下面mid的值总是在中间那个值，或则最接近中间那个值</span></div><div class="line">  	<span class="comment">//比如说你数组长度为5,那么mid为2，长度为4，mid为1，长度为3，mid为1</span></div><div class="line">  	<span class="comment">//另一方面a[a.length-1]是最后一个元素</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span></span>&#123;</div><div class="line">  	<span class="comment">//hi 和 lo十分接近的时候，下面的mid就是0(1/2=0)了，这时候再次递归的时候就return</span></div><div class="line">	<span class="keyword">if</span>(hi &lt;= lo)&#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">int</span> mid = lo + (hi - lo)/<span class="number">2</span>;</div><div class="line">	sort(a, lo, mid); <span class="comment">//将左半边排序</span></div><div class="line">	sort(a, mid+<span class="number">1</span>, hi); <span class="comment">//将右半边排序</span></div><div class="line">	merge(a, lo, mid, hi); <span class="comment">//归并结果</span></div><div class="line">&#125;</div><div class="line"><span class="comment">//正如名字一样，自顶向下是，你传进来是整个大的数组。然后，通过递归，切分更小的数组进行归并。最后，再整合小的数组，完成最终的归并。</span></div></pre></td></tr></table></figure>
<p>5.3自顶向上的归并排序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> Comparable[] aux;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a)</span></span>&#123;</div><div class="line">	<span class="keyword">int</span> N = a.length;</div><div class="line">	aux = <span class="keyword">new</span> Comparable[N];</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> sz = <span class="number">1</span>; sz &lt; N; sz = sz +sz)&#123;   <span class="comment">//sz子数组大小</span></div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> lo = <span class="number">0</span>; lo &lt; N-sz; lo += sz+sz)&#123;  <span class="comment">//lo:子数组索引</span></div><div class="line">			merge(a, lo, lo+sz-<span class="number">1</span>, Math.min(lo+sz+sz-<span class="number">1</span>, N-<span class="number">1</span>));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//从sz子数组大小为1开始归并，然后每次加倍。</span></div></pre></td></tr></table></figure>
<p><strong>6.快速排序</strong></p>
<p>快速排序是一种分治的排序算法。它将一个数组分成两个字数组，将两部分独立地排序。</p>
<p>快速排序和归并排序是互补的：</p>
<p>归并排序将数组分成两个子数组分别排序，并将有序的子数组归并以将整个数组排序。</p>
<p>快速排序将数组排序的方式则是当两个子数组都有序时这个数组也就自然有序了。</p>
<p>在第一种情况中，递归调用发生在处理整个数组之前；在第二种情况中，递归调用发生在处整个数组之后。在归并排序中，一个数组被等分为两半，在快速排序中，<strong>切分(partition)</strong>的位置取决于数组的内容。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Quick</span></span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a)</span></span>&#123;</div><div class="line">    sort(a, <span class="number">0</span>, a.length-<span class="number">1</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(hi &lt;= lo)&#123;</div><div class="line">      <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> j = partition(a, lo, hi);</div><div class="line">    sort(a, lo, j-<span class="number">1</span>); <span class="comment">//将左半部分a[lo..j-1]排序----》递归。。。</span></div><div class="line">    sort(a, j+<span class="number">1</span>, hi); <span class="comment">//将右半部分a[j+1..hi]排序----》递归。。。</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关键在于切分，这个拨成使得数组满足三个条件；</p>
<ol>
<li>对于某个j, a[j]已经排定; 也就是<strong>a[lo..j-1]&lt;=a[j]&lt;=a[j+1..hi]</strong></li>
<li><strong>a[lo]</strong>到<strong>a[j-1]</strong>中的所有元素都不大于<strong>a[j]</strong>;</li>
<li><strong>a[j+1]</strong>到<strong>a[hi]</strong>中的元素都不小于<strong>a[j]</strong>;</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">partition</span><span class="params">(Comparable[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span></span></div><div class="line">&#123;	</div><div class="line">  <span class="keyword">int</span> i = lo, j = hi+<span class="number">1</span>;</div><div class="line">  Comparable v = a[lo];</div><div class="line">  <span class="keyword">while</span>(<span class="keyword">true</span>)</div><div class="line">  &#123; <span class="comment">//扫描左右，检查扫面是否结束并交换元素</span></div><div class="line">    <span class="comment">//a[++i]&gt;=v&gt;=a[--j] 之后交换a[i]和a[j]来保证i左侧的元素都不大于v，j右侧的元素都不小于v</span></div><div class="line">    <span class="keyword">while</span>(less(a[++i], v))&#123;</div><div class="line">      <span class="comment">//a[++i]&gt;=v不执行</span></div><div class="line">      <span class="keyword">if</span>(i == hi)&#123;</div><div class="line">		<span class="keyword">break</span>;	</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">while</span>(less(v, a[--j]))&#123;</div><div class="line">      <span class="comment">//v&gt;=a[--j]不执行</span></div><div class="line">      <span class="keyword">if</span>(j == lo)&#123;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//当指针相遇时交换a[lo]和a[j]，切分结束。(这样切分值就留在了a[j]中了)</span></div><div class="line">    <span class="comment">//也就是说下面的return的时候 那个条件就达成了。。</span></div><div class="line">    <span class="keyword">if</span>(i &gt;= j) <span class="keyword">break</span>;</div><div class="line">    exch(a, i, j);</div><div class="line">  &#125;</div><div class="line">  exch(a, lo, j); <span class="comment">//将v = a[j]放入正确的位置</span></div><div class="line">  <span class="keyword">return</span> j; <span class="comment">//a[lo..j-1]&lt;=a[j]&lt;=a[j+1..hi]达成</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>6.1三向切分的快速排序 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Quick3way</span></span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a)</span></span>&#123;</div><div class="line">    sort(a, <span class="number">0</span>, a.length-<span class="number">1</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(Comparable[] a, <span class="keyword">int</span> lo, <span class="keyword">int</span> hi)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(hi &lt;= lo) <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">int</span> lt = lo, i = lo+<span class="number">1</span>, gt = hi;</div><div class="line">    Comparable v = a[lo];</div><div class="line">    <span class="keyword">while</span>(i &lt;= gt)&#123;</div><div class="line">      <span class="keyword">int</span> cmp = a[i].compareTo(v);</div><div class="line">      <span class="keyword">if</span>(cmp &lt; <span class="number">0</span>)&#123;</div><div class="line">        exch(a, lt++, i++);</div><div class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(cmp &gt; <span class="number">0</span> )&#123;</div><div class="line">        exch(a, i, gt--);</div><div class="line">      &#125;<span class="keyword">else</span>&#123;</div><div class="line">        i++;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    sort(a, lo, lt - <span class="number">1</span>);</div><div class="line">    sort(a, gt+<span class="number">1</span>, hi);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3-java查找"><a href="#3-java查找" class="headerlink" title="3.java查找"></a>3.java查找</h2>
      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2016/10/07/Java算法/" data-id="cj8lswfml000v5svbnt41if5m" class="article-share-link" data-share="baidu" data-title="Java算法">Share</a>
      

      
        <a href="http://yoursite.com/2016/10/07/Java算法/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-使用hexo-github搭建静态博客" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/04/使用hexo-github搭建静态博客/" class="article-date">
  <time datetime="2015-10-04T03:01:31.000Z" itemprop="datePublished">2015-10-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/hexo/">hexo</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/04/使用hexo-github搭建静态博客/">使用hexo+github搭建静态博客</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="认识hexo"><a href="#认识hexo" class="headerlink" title="认识hexo"></a>认识hexo</h1><p>&#8195;&#8195;hexo是一款基于Node.js的静态博客框架，可以生成静态文件并且一键部署到github pages上，并且他可以使用markdown来编写文章，十分简单。</p>
<p>他有许多优点：</p>
<ul>
<li>快速：hexo基于Node.js，支持多进程，几百篇文章可以秒生成。</li>
<li>写文章流程：支持GitHub Flavored Markdown和所有Octopress的插件。</li>
<li>扩展性：Hexo支持EJS、Swig和Stylus。通过插件支持Haml、Jade和Less。</li>
</ul>
<p><em>这是一篇用hexo在github上面搭建博客的教程</em></p>
<hr>
<h1 id="安装："><a href="#安装：" class="headerlink" title="安装："></a>安装：</h1><h2 id="系统环境："><a href="#系统环境：" class="headerlink" title="系统环境："></a>系统环境：</h2><ul>
<li>系统： win10 64bit</li>
<li>编译器：<a href="http://www.sublimetext.com/" target="_blank" rel="external">sublime text 3</a>（可以看这篇文章）</li>
<li>编码： 把文本编码确定成 UTF-8</li>
</ul>
<h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><ol>
<li>可以选择安装GitHub for Windows 或者 git 。</li>
<li>注册github，选择Repositories，然后new新建一个仓库，建好仓库之后选择settings，到GitHub Pages那一栏，选择Launch automatic page generator，接下去就是确定。</li>
<li>然后就是把仓库clone下来，关于怎么clone和使用git可以参考这篇文字。</li>
</ol>
<h2 id="nodejs"><a href="#nodejs" class="headerlink" title="nodejs"></a>nodejs</h2><p>下载安装<a href="https://nodejs.org/" target="_blank" rel="external">nodejs</a>，nodejs安装后会自动带有npm包，如果嫌外网下npm下载包文件比较慢，可以使用淘宝的<a href="http://npm.taobao.org/" target="_blank" rel="external">cnpm</a>镜像。<br>nodejs安装好之后可以打开命令行（win+r，输入cmd，确定），<br>输入 node -v 查看nodejs版本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ node -v</div><div class="line">$ v0.12.7 <span class="comment">##版本号</span></div></pre></td></tr></table></figure></p>
<p>输入 npm -v 查看npm版本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ npm -v</div><div class="line">$ v2.11.3 <span class="comment">##版本号</span></div></pre></td></tr></table></figure></p>
<p>到这里说明nodejs安装成功了。</p>
<h2 id="hexo"><a href="#hexo" class="headerlink" title="hexo"></a>hexo</h2><p>打开命令行，我这里安装的是3.x版本（后面可能会有个小坑）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install hexo-cli -g <span class="_">-d</span></div></pre></td></tr></table></figure></p>
<p>查看hexo的版本号：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo -v</div></pre></td></tr></table></figure></p>
<p>进入到我们clone的那个文件夹，执行命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo init</div></pre></td></tr></table></figure></p>
<p>接着安装依赖包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install</div></pre></td></tr></table></figure></p>
<p>接着可以启动服务测试一下:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo s</div></pre></td></tr></table></figure></p>
<p>用浏览器打开<code>http://localhost:4000/</code>或者<code>http://127.0.0.1:4000/</code>就可以看到页面了。</p>
<hr>
<h1 id="Hexo的使用"><a href="#Hexo的使用" class="headerlink" title="Hexo的使用"></a>Hexo的使用</h1><h2 id="目录和文件"><a href="#目录和文件" class="headerlink" title="目录和文件"></a>目录和文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">├── .deploy       #需要部署的文件</div><div class="line">├── node_modules  #Hexo插件</div><div class="line">├── public        #生成的静态网页文件</div><div class="line">├── scaffolds     #模板</div><div class="line">├── source        #博客正文和其他源文件, 404 、favicon 、CNAME</div><div class="line">|   ├── _drafts   #草稿</div><div class="line">|   └── _posts    #文章</div><div class="line">├── themes        #主题</div><div class="line">├── _config.yml   #全局配置文件</div><div class="line">└── package.json</div></pre></td></tr></table></figure>
<p>（有些文件是在部署时才会产生的）</p>
<h2 id="全局站点配置文件-config-yml"><a href="#全局站点配置文件-config-yml" class="headerlink" title="全局站点配置文件_config.yml"></a>全局站点配置文件_config.yml</h2><p>（yml语法严格，注意冒号后面必须加空格）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"># Site #站点信息</div><div class="line">title: Hexo #博客标题</div><div class="line">subtitle: 啦啦啦 #副标题</div><div class="line">description: 哈哈哈 #描述</div><div class="line">author: John Doe #作者</div><div class="line">language: zh-Hans #语言</div><div class="line">timezone: Asia/Shanghai #时区</div><div class="line"></div><div class="line"># URL #链接格式</div><div class="line">url: http://yoursite.com #博客网址</div><div class="line">root: / #根目录</div><div class="line">permalink: :year/:month/:day/:title/ #文章的链接格式</div><div class="line">permalink_defaults:</div><div class="line"></div><div class="line"># Directory #目录</div><div class="line">source_dir: source #源文件</div><div class="line">public_dir: public #生成的文件</div><div class="line">tag_dir: tags #标签文件夹</div><div class="line">archive_dir: archives #归档文件夹</div><div class="line">category_dir: categories #分类文件夹</div><div class="line">code_dir: downloads/code #下载文件</div><div class="line">i18n_dir: :lang #国际化</div><div class="line">skip_render:</div><div class="line"></div><div class="line"># Writing #写作</div><div class="line">new_post_name: :title.md #文章标题</div><div class="line">default_layout: post #模板</div><div class="line">titlecase: false #标题是否换成小写</div><div class="line">external_link: true #是否在新页面打开链接</div><div class="line">filename_case: 0</div><div class="line">render_drafts: false</div><div class="line">post_asset_folder: false</div><div class="line">relative_link: false</div><div class="line">future: true</div><div class="line">highlight:</div><div class="line">  enable: true</div><div class="line">  line_number: true</div><div class="line">  auto_detect: true</div><div class="line">  tab_replace:</div><div class="line"></div><div class="line"># Category &amp; Tag #分类和标签</div><div class="line">default_category: uncategorized</div><div class="line">category_map:</div><div class="line">tag_map:</div><div class="line"></div><div class="line"># Date #时间日期格式</div><div class="line">date_format: YYYY-MM-DD</div><div class="line">time_format: HH:mm:ss</div><div class="line"></div><div class="line"># Pagination #分页</div><div class="line">per_page: 10 #每页文章数</div><div class="line">pagination_dir: page</div><div class="line"></div><div class="line"># Extensions #插件和主题</div><div class="line">## Plugins: http://hexo.io/plugins/</div><div class="line">## Themes: http://hexo.io/themes/</div><div class="line">theme: landscape</div><div class="line"></div><div class="line"># Deployment #部署配置</div><div class="line">## Docs: http://hexo.io/docs/deployment.html</div><div class="line">deploy:</div><div class="line">  type:</div></pre></td></tr></table></figure></p>
<h2 id="站点的-config-yml-配置"><a href="#站点的-config-yml-配置" class="headerlink" title="站点的_config.yml 配置"></a>站点的_config.yml 配置</h2><h3 id="站点建立时间"><a href="#站点建立时间" class="headerlink" title="站点建立时间"></a>站点建立时间</h3><p>例如 <code>© 2015 - 2016</code><br>在文件添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">since: 2015</div></pre></td></tr></table></figure></p>
<h3 id="头像设置"><a href="#头像设置" class="headerlink" title="头像设置"></a>头像设置</h3><p>/images/avatar.jpg //头像图片放置在主题的 source/images/<br>在文件添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">avatar: /images/avatar.png</div></pre></td></tr></table></figure></p>
<h3 id="侧边栏社交链接"><a href="#侧边栏社交链接" class="headerlink" title="侧边栏社交链接"></a>侧边栏社交链接</h3><p>增加 social<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># Social links</div><div class="line">social:</div><div class="line">  GitHub: https://github.com/tongchengqiu</div><div class="line">  Twitter: https://twitter.com/tongchengqiu</div><div class="line">  Zhihu: http://www.zhihu.com/people/tongchengqiu</div></pre></td></tr></table></figure></p>
<h2 id="友情链接"><a href="#友情链接" class="headerlink" title="友情链接"></a>友情链接</h2><h3 id="标题"><a href="#标题" class="headerlink" title="标题"></a>标题</h3><p>links_title: 友情链接</p>
<h3 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h3><p>links:<br>  Hexo: <a href="http://hexo.io/" target="_blank" rel="external">http://hexo.io/</a><br>  Lmintlcx: <a href="http://blog.lmintlcx.com/" target="_blank" rel="external">http://blog.lmintlcx.com/</a></p>
<h2 id="命令的使用"><a href="#命令的使用" class="headerlink" title="命令的使用"></a>命令的使用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">hexo help #查看帮助</div><div class="line">hexo init #初始化目录</div><div class="line">hexo new &quot;postName&quot; #新建文章</div><div class="line">hexo new page &quot;pageName&quot; #新建页面</div><div class="line">hexo generate #生成网页, 可以在public目录查看整个网站的文件</div><div class="line">hexo server #本地预览,&apos;Ctrl+C&apos;关闭</div><div class="line">hexo deploy #部署.deploy目录</div><div class="line">hexo clean #清除缓存, 建议每次执行命令前先清理缓存</div><div class="line">hexo n == hexo new</div><div class="line">hexo g == hexo generate</div><div class="line">hexo s == hexo server</div><div class="line">hexo d == hexo deploy</div></pre></td></tr></table></figure>
<h2 id="写文章"><a href="#写文章" class="headerlink" title="写文章"></a>写文章</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo new &quot;文章标题&quot;</div></pre></td></tr></table></figure>
<p>然后到_post 目录下打开 文章标题.md<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">title: 文章标题</div><div class="line">date: 2015-10-3 11:11:11</div><div class="line">tags:</div><div class="line">- 标签1</div><div class="line">- 标签2</div><div class="line">- 标签3</div><div class="line">categories: [分类1,分类2,分类3]</div><div class="line">---</div><div class="line">正文, 使用 Markdown 语法书写</div></pre></td></tr></table></figure></p>
<p>编辑后可以先预览<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hexo clean</div><div class="line">hexo s</div></pre></td></tr></table></figure></p>
<p>然后打开浏览器预览</p>
<h2 id="部署上传更新"><a href="#部署上传更新" class="headerlink" title="部署上传更新"></a>部署上传更新</h2><p>以github为例，打开站点根目录下的_config.yml文件，找到deploy部分，更改配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">deploy:</div><div class="line">  type: git</div><div class="line">  repository: git@github.com:test/test.git #在仓库找到该仓库的ssh</div><div class="line">  branch: github-pages #分支，这里为github-pages</div></pre></td></tr></table></figure></p>
<p>然后就可以部署了，在文件根目录执行命令行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ hexo clean</div><div class="line">$ hexo deploy</div></pre></td></tr></table></figure></p>
<p>这里有可能会报个错误<code>ERROR Deployer not found : git</code><br>这里需要安装一个包<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ npm install hexo-deployer-git --save</div></pre></td></tr></table></figure></p>
<p>然后就可以继续执行<code>deploy</code>了，第一次部署可能会有点慢，可以耐心等候哦。<br>成功之后可以继续打开仓库的settings，在GitHub Pages会看到 Your site is published at <a href="http://qiutongcheng.com.（如果还没有绑定域名就会是github给你分配的url哦）" target="_blank" rel="external">http://qiutongcheng.com.（如果还没有绑定域名就会是github给你分配的url哦）</a><br>就可以打开链接看看咯~</p>
<hr>
<h1 id="绑定域名"><a href="#绑定域名" class="headerlink" title="绑定域名"></a>绑定域名</h1><p>当然我们的个人博客当然希望绑定自己的一个个性域名咯~</p>
<h2 id="注册购买顶级域名"><a href="#注册购买顶级域名" class="headerlink" title="注册购买顶级域名"></a>注册购买顶级域名</h2><p>国内购买可以上<a href="http://wanwang.aliyun.com/" target="_blank" rel="external">万网</a>；<br>嫌国内不好可以用<a href="https://www.godaddy.com/" target="_blank" rel="external">godaddy</a>。</p>
<h2 id="DNS设置"><a href="#DNS设置" class="headerlink" title="DNS设置"></a>DNS设置</h2><p>在购买域名的后台管理设置DNS<br>主机记录@, 类型A, 记录值192.30.252.153<br>主机记录www, 类型A, 记录值192.30.252.153</p>
<h2 id="在github绑定域名"><a href="#在github绑定域名" class="headerlink" title="在github绑定域名"></a>在github绑定域名</h2><p>在source文件夹下面新建 CNAME（不要后缀），内容输入要绑定的域名，比如<br><code>qiutongcheng.com</code>或者<code>www.qiutongcheng.com</code>。</p>
<h2 id="绑定子域名"><a href="#绑定子域名" class="headerlink" title="绑定子域名"></a>绑定子域名</h2><p>比如要绑定 <code>blog.qiutongcheng.com</code> ：<br>吧CNAME内容改成 <code>blog.qiutongcheng.com</code><br>DNS设置里面添加 主机记录有blog，类型 CNAME ，记录值 <code>blog.qiutongcheng.com</code></p>
<hr>
<h1 id="主题"><a href="#主题" class="headerlink" title="主题"></a>主题</h1><p>hexo的<a href="https://github.com/hexojs/hexo/wiki/Themes" target="_blank" rel="external">(主题列表)</a><br>我使用的是 NexT 主题，这里一NexT主题为例剖析一下吧。</p>
<h2 id="下载与使用"><a href="#下载与使用" class="headerlink" title="下载与使用"></a>下载与使用</h2><p>执行命令行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">clone</span> https://github.com/iissnan/hexo-theme-next themes/next <span class="comment">#主题的地址</span></div></pre></td></tr></table></figure></p>
<p>也可以下载zip文件，然后手动解压到themes目录下<br>配置全局站点文件<code>_config.yml</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">themes: next #主题文件夹名</div></pre></td></tr></table></figure></p>
<h2 id="主题的目录结构"><a href="#主题的目录结构" class="headerlink" title="主题的目录结构"></a>主题的目录结构</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">.</div><div class="line">├── languages          #国际化</div><div class="line">|   ├── default.yml    #默认</div><div class="line">|   └── zh-CN.yml      #中文</div><div class="line">├── layout             #布局</div><div class="line">|   ├── _partial       #局部的布局</div><div class="line">|   └── _widget        #小挂件的布局</div><div class="line">├── script             #js脚本</div><div class="line">├── source             #源代码文件</div><div class="line">|   ├── css            #CSS</div><div class="line">|   |   ├── _base      #基础CSS</div><div class="line">|   |   ├── _partial   #局部CSS</div><div class="line">|   |   ├── fonts      #字体</div><div class="line">|   |   ├── images     #图片</div><div class="line">|   |   └── style.styl #style.css</div><div class="line">|   ├── fancybox       #fancybox</div><div class="line">|   └── js             #js</div><div class="line">├── _config.yml        #主题配置文件</div><div class="line">└── README.md          #主题介绍</div></pre></td></tr></table></figure>
<h2 id="主题配置文件-config-yml文件"><a href="#主题配置文件-config-yml文件" class="headerlink" title="主题配置文件_config.yml文件"></a>主题配置文件_config.yml文件</h2><p>打开主题目录下的_config.yml文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">menu: #菜单</div><div class="line">  home: / #首页</div><div class="line">  archives: /archives #归档</div><div class="line">  #commonweal: /404.html #404页面</div><div class="line">  #tags: /tags #标签</div><div class="line">  #categories: /categories #分类</div><div class="line">  about: /about #关于</div><div class="line"></div><div class="line"># 小图标</div><div class="line">favicon: /favicon.ico</div><div class="line"></div><div class="line"># 默认关键词</div><div class="line">keywords: &quot;~&quot;</div><div class="line"></div><div class="line"># 留空使用默认的, false 禁用, 也可以写指定的地址</div><div class="line">rss:</div><div class="line"></div><div class="line"># Icon fonts</div><div class="line"># default | linecons | fifty-shades | feather</div><div class="line">icon_font: default</div><div class="line"></div><div class="line"># 代码高亮主题 https://github.com/chriskempson/tomorrow-theme</div><div class="line"># normal | night | night eighties | night blue | night bright</div><div class="line">highlight_theme: normal</div><div class="line"></div><div class="line"># MathJax Support #数学公式</div><div class="line">mathjax: true</div><div class="line"></div><div class="line"># Schemes #启用主题中的主题Mist</div><div class="line">scheme: Mist</div><div class="line"></div><div class="line"># 侧边栏</div><div class="line">#  - post    只在文章页面显示</div><div class="line">#  - always  所有页面显示</div><div class="line">#  - hide    隐藏</div><div class="line">sidebar: always</div><div class="line"></div><div class="line"># 自动滚动到&quot;阅读更多&quot;标记的下面</div><div class="line">scroll_to_more: true</div><div class="line"></div><div class="line"># 自动给目录添加序号</div><div class="line">toc_list_number: true</div><div class="line"></div><div class="line"># 自动截取摘要</div><div class="line">auto_excerpt:</div><div class="line">  enable: false</div><div class="line">  length: 150</div><div class="line"></div><div class="line"># Lato 字体</div><div class="line">use_font_lato: true</div><div class="line"></div><div class="line"># Make duoshuo show UA</div><div class="line"># user_id must NOT be null when admin_enable is true!</div><div class="line"># you can visit http://dev.duoshuo.com get duoshuo user id.</div><div class="line">duoshuo_info:</div><div class="line">  ua_enable: true</div><div class="line">  admin_enable: false</div><div class="line">  user_id: 0</div><div class="line">  #admin_nickname: ROOT</div><div class="line"></div><div class="line">## DO NOT EDIT THE FOLLOWING SETTINGS</div><div class="line">## UNLESS YOU KNOW WHAT YOU ARE DOING</div><div class="line"></div><div class="line"># 动画</div><div class="line">use_motion: true</div><div class="line"></div><div class="line"># Fancybox 看图插件</div><div class="line">fancybox: true</div><div class="line"></div><div class="line"># Static files</div><div class="line">vendors: vendors</div><div class="line">css: css</div><div class="line">js: js</div><div class="line">images: images</div><div class="line"></div><div class="line"># Theme version</div><div class="line">version: 0.4.5.1</div></pre></td></tr></table></figure></p>
<h3 id="选择Scheme"><a href="#选择Scheme" class="headerlink" title="选择Scheme"></a>选择Scheme</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scheme: Mist</div></pre></td></tr></table></figure>
<h3 id="添加网站图标"><a href="#添加网站图标" class="headerlink" title="添加网站图标"></a>添加网站图标</h3><p>将网站图标文件 favicon.ico 放到source目录下面<br>修改主题_config.yml文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">favicon: /favicon.ico</div></pre></td></tr></table></figure></p>
<h3 id="菜单设置"><a href="#菜单设置" class="headerlink" title="菜单设置"></a>菜单设置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">menu:</div><div class="line">  home: /</div><div class="line">  archives: /archives</div><div class="line">  categories: /categories</div><div class="line">  tags: /tags</div><div class="line">  commonweal: /404.html</div><div class="line">  about: /about</div></pre></td></tr></table></figure>
<h3 id="标签页面"><a href="#标签页面" class="headerlink" title="标签页面"></a>标签页面</h3><p>执行命令行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo new page &quot;tags&quot;</div></pre></td></tr></table></figure></p>
<p>到生成的页面文件里<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">title: tags</div><div class="line">date: 2015-10-4 22:37:08</div><div class="line">type: &quot;tags&quot;</div><div class="line">comments: false    #关闭评论（建议）</div><div class="line">---</div></pre></td></tr></table></figure></p>
<h3 id="分类页面"><a href="#分类页面" class="headerlink" title="分类页面"></a>分类页面</h3><p>执行命令行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo new page &quot;categories&quot;</div></pre></td></tr></table></figure></p>
<p>到生成的页面文件里<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">title: categories</div><div class="line">date: 2015-10-4 22:37:08</div><div class="line">type: &quot;categories&quot;</div><div class="line">comments: false    #关闭评论（建议）</div><div class="line">---</div></pre></td></tr></table></figure></p>
<h3 id="关于页面"><a href="#关于页面" class="headerlink" title="关于页面"></a>关于页面</h3><p>执行命令行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hexo new page &quot;about&quot;</div></pre></td></tr></table></figure></p>
<p>到生成的页面文件里<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">title: about</div><div class="line">date: 2015-10-4 22:37:08</div><div class="line">type: &quot;about&quot;</div><div class="line">comments: false    #关闭评论（建议）</div><div class="line">---</div></pre></td></tr></table></figure></p>
<h3 id="RSS链接"><a href="#RSS链接" class="headerlink" title="RSS链接"></a>RSS链接</h3><p>编辑主题的_config.yml文件<br>禁止：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rss: false</div></pre></td></tr></table></figure></p>
<p>使用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rss:</div></pre></td></tr></table></figure></p>
<p>需要安装插件 hexo-generator-feed ，继续看下面有安装插件教程<br>自定义：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rss: url#自定义的地址</div></pre></td></tr></table></figure></p>
<h3 id="侧边栏设置"><a href="#侧边栏设置" class="headerlink" title="侧边栏设置"></a>侧边栏设置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sidebar: post  #只在文章页面自动显示</div><div class="line">#sidebar: always #在所以页面自动显示</div><div class="line">#sidebar: hide #全隐藏</div></pre></td></tr></table></figure>
<h3 id="腾讯公益-404-页面"><a href="#腾讯公益-404-页面" class="headerlink" title="腾讯公益 404 页面"></a>腾讯公益 404 页面</h3><p>source 目录下新建 404.html 页面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE HTML&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">  &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8;&quot;/&gt;</div><div class="line">  &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge,chrome=1&quot; /&gt;</div><div class="line">  &lt;meta name=&quot;robots&quot; content=&quot;all&quot; /&gt;</div><div class="line">  &lt;meta name=&quot;robots&quot; content=&quot;index,follow&quot;/&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line"></div><div class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;http://www.qq.com/404/search_children.js&quot; charset=&quot;utf-8&quot; homePageUrl=&quot;your-site-url&quot; homePageName=&quot;回到我的主页&quot;&gt;&lt;/script&gt;</div><div class="line"></div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<h3 id="首页文章摘录"><a href="#首页文章摘录" class="headerlink" title="首页文章摘录"></a>首页文章摘录</h3><p>在主题配置文件添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">auto_excerpt:</div><div class="line">  enable: true</div><div class="line">  length: 150 #默认截取的长度为 150 字符</div></pre></td></tr></table></figure></p>
<hr>
<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><h2 id="评论系统"><a href="#评论系统" class="headerlink" title="评论系统"></a>评论系统</h2><h3 id="多说评论系统"><a href="#多说评论系统" class="headerlink" title="多说评论系统"></a>多说评论系统</h3><p>注册<a href="http://duoshuo.com/" target="_blank" rel="external">多说</a>，配置域名站点域名 xxx.duoshuo.com<br>在站点配置文件添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">duoshuo_shortname: xxx</div></pre></td></tr></table></figure></p>
<h2 id="设置网站统计"><a href="#设置网站统计" class="headerlink" title="设置网站统计"></a>设置网站统计</h2><h3 id="百度统计"><a href="#百度统计" class="headerlink" title="百度统计"></a>百度统计</h3><p>登陆注册<a href="http://tongji.baidu.com/web/welcome/login" target="_blank" rel="external">百度统计</a>，配置后到代码获取页面，<br>找到代码里 <code>hm?js</code> 复制后面一串字符串ID  xxx<br>在站点配置文件添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">baidu_analytics: xxxxxxxxxxxxxxxx</div></pre></td></tr></table></figure></p>
<h2 id="分享"><a href="#分享" class="headerlink" title="分享"></a>分享</h2><h3 id="百度分享"><a href="#百度分享" class="headerlink" title="百度分享"></a>百度分享</h3><p>在站点配置文件添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 百度分享服务</div><div class="line">baidushare: true</div></pre></td></tr></table></figure></p>
<h3 id="多说分享"><a href="#多说分享" class="headerlink" title="多说分享"></a>多说分享</h3><p>在站点配置文件添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># 多说分享服务</div><div class="line">duoshuo_share: true</div></pre></td></tr></table></figure></p>
<h2 id="版权协议"><a href="#版权协议" class="headerlink" title="版权协议"></a>版权协议</h2><p>在站点配置文件添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># Creative Commons 4.0 International License.</div><div class="line"># http://creativecommons.org/</div><div class="line"># Available: by | by-nc | by-nc-nd | by-nc-sa | by-nd | by-sa | zero</div><div class="line">creative_commons: by-nc-sa</div></pre></td></tr></table></figure></p>
<h2 id="网站访问量统计"><a href="#网站访问量统计" class="headerlink" title="网站访问量统计"></a>网站访问量统计</h2><p>使用 <a href="http://service.ibruce.info/" target="_blank" rel="external">不蒜子</a> 提供的服务<br>算法a: pv的方式, 单个用户连续点击n篇文章, 记录n次访问量.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;span id=&quot;busuanzi_container_site_pv&quot;&gt;</div><div class="line">    本站总访问量&lt;span id=&quot;busuanzi_value_site_pv&quot;&gt;&lt;/span&gt;次</div><div class="line">&lt;/span&gt;</div></pre></td></tr></table></figure></p>
<p>算法b: uv的方式, 单个用户连续点击n篇文章, 只记录1次访客数.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;span id=&quot;busuanzi_container_site_uv&quot;&gt;</div><div class="line">  本站访客数&lt;span id=&quot;busuanzi_value_site_uv&quot;&gt;&lt;/span&gt;人次</div><div class="line">&lt;/span&gt;</div></pre></td></tr></table></figure></p>
<p>找到themes/next/layout/partials/footer.wsig文件<br>在最后一行前面添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;script async src=&quot;https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;span id=&quot;busuanzi_container_site_pv&quot;&gt;</div><div class="line">    本站总访问量&lt;span id=&quot;busuanzi_value_site_pv&quot;&gt;&lt;/span&gt;次</div><div class="line">&lt;/span&gt;</div></pre></td></tr></table></figure></p>
<h2 id="网站运行时间"><a href="#网站运行时间" class="headerlink" title="网站运行时间"></a>网站运行时间</h2><p>在最后一行前面添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line">var birthDay = new Date(&quot;11/20/2014&quot;);</div><div class="line">var now = new Date();</div><div class="line">var duration = now.getTime() - birthDay.getTime();</div><div class="line">var total= Math.floor(duration / (1000 * 60 * 60 * 24));</div><div class="line">document.getElementById(&quot;showDays&quot;).innerHTML = &quot;本站已运行 &quot;+total+&quot; 天&quot;;</div><div class="line">&lt;/script&gt;</div><div class="line">&lt;span id=&quot;showDays&quot;&gt;&lt;/span&gt;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2015/10/04/使用hexo-github搭建静态博客/" data-id="cj8lswfnl00205svbtl0lz992" class="article-share-link" data-share="baidu" data-title="使用hexo+github搭建静态博客">Share</a>
      

      
        <a href="http://yoursite.com/2015/10/04/使用hexo-github搭建静态博客/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hexo/">hexo</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/5/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span>
  </nav>
</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node/">Node</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/es6/">es6</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node/">Node</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/es6/">es6</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/">tools</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/JavaScript/" style="font-size: 17.5px;">JavaScript</a> <a href="/tags/Node/" style="font-size: 20px;">Node</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/es6/" style="font-size: 12.5px;">es6</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/tools/" style="font-size: 12.5px;">tools</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/09/15/koa-router小笔记/">koa-router小笔记</a>
          </li>
        
          <li>
            <a href="/2017/09/10/一些源码分析解析/">一些npm包源码分析</a>
          </li>
        
          <li>
            <a href="/2017/09/02/fiddler/">fiddler抓包工具</a>
          </li>
        
          <li>
            <a href="/2017/05/02/这些年我用过的软件/">那些年我用过的软件</a>
          </li>
        
          <li>
            <a href="/2017/04/02/利用pipe处理并发/">利用pipe处理并发的可行性</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
      <ul>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 ChenXing<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"reqianduan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/script.js"></script>

</div>
</body>
</html>
