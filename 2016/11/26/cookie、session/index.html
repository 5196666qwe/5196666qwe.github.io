<!DOCTYPE html>
<html lang="en">
<head>
  <!-- content-Type -->
<meta charset="utf-8">


<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="language" content="en">
<meta name="robots" content="all">


<meta content="yes" name="apple-mobile-web-app-capable">
<meta content="black" name="apple-mobile-web-app-status-bar-style">
<meta content="telephone=no" name="format-detection">
<meta content="email=no" name="format-detection">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






<meta name="google-site-verification" content="xxxxxxxxxx" />




<meta name="baidu-site-verification" content="xxxxxxxxxx" />







<meta name="keywords" content="Node," />


<meta name="description" content="[TOC]
cookie在web应用中，多个请求之间共享“用户会话”是非常必要的。但HTTP1.0协议是无状态的。那这时Cookie就出现了。那Cookie又是如何处理的呢？
Cookie的处理：

服务端向客户端发送Cookie
客户端的浏览器把Cookie保存
然后在每次请求浏览器都会将Cookie发送到服务端

在HTML文档被发送之前，Web服务器通过传送HTTP 包头中的Set-Cook">
<meta property="og:type" content="article">
<meta property="og:title" content="cookie、session">
<meta property="og:url" content="http://yoursite.com/2016/11/26/cookie、session/index.html">
<meta property="og:site_name" content="ChenXing">
<meta property="og:description" content="[TOC]
cookie在web应用中，多个请求之间共享“用户会话”是非常必要的。但HTTP1.0协议是无状态的。那这时Cookie就出现了。那Cookie又是如何处理的呢？
Cookie的处理：

服务端向客户端发送Cookie
客户端的浏览器把Cookie保存
然后在每次请求浏览器都会将Cookie发送到服务端

在HTML文档被发送之前，Web服务器通过传送HTTP 包头中的Set-Cook">
<meta property="og:updated_time" content="2016-12-14T08:38:39.233Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="cookie、session">
<meta name="twitter:description" content="[TOC]
cookie在web应用中，多个请求之间共享“用户会话”是非常必要的。但HTTP1.0协议是无状态的。那这时Cookie就出现了。那Cookie又是如何处理的呢？
Cookie的处理：

服务端向客户端发送Cookie
客户端的浏览器把Cookie保存
然后在每次请求浏览器都会将Cookie发送到服务端

在HTML文档被发送之前，Web服务器通过传送HTTP 包头中的Set-Cook">






  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />






<link href="http://cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


<script>
(function(){
  var bp = document.createElement('script');
  bp.src = '//push.zhanzhang.baidu.com/push.js';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();
</script>

  <title> cookie、session </title>
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'xxxxxxxxxx', 'auto');
  ga('send', 'pageview');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?1551fdd18711ccb1c048bb11f579b1a4";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



</head>
<body lang="zh-Hans">

  <!--[if lte IE 9]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->


  <div class="another-theme layout">

    
<header class="header" id="header">

  <div class="header-cont">
    <div class="text-area">
      
        <h1 class="title" data-text="cookie、session"> cookie、session </h1>

        
        <div class="post-meta">
          <div class="post-time">
            发表于
            <time  datetime="2016-11-26T20:53:53+08:00" content="2016-11-26">
              2016-11-26
            </time>
          </div>

          
            <div class="post-category" >
              
                <span>
                  <a href="/categories#Node" itemprop="url" rel="index">
                    <span itemprop="name">Node</span>
                  </a>
                </span>

                
                

              
            </div>
          

          
            
          
        </div>
        
      
    </div>
    <!-- Navigation -->
    
    <nav class="navigation clearfix" id="navigation">
      
        
        <a class="nav-link" href="/" rel="section">
          首页
        </a>
      
        
        <a class="nav-link" href="/tags" rel="section">
          标签
        </a>
      
        
        <a class="nav-link" href="/categories" rel="section">
          分类
        </a>
      
        
        <a class="nav-link" href="/about" rel="section">
          关于
        </a>
      
    </nav>
    
  </div>
  <div class="mask"></div>
</header>


    <main class="container">

      

  <article class="post-article post-type-normal post" itemscope>

  <div class="post-body">

    <div class="content markdown-body"><p>[TOC]</p>
<h2 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h2><p>在web应用中，多个请求之间<em>共享“用户会话”</em>是非常必要的。但HTTP1.0协议是无状态的。那这时Cookie就出现了。那Cookie又是如何处理的呢？</p>
<p><strong>Cookie的处理</strong>：</p>
<ul>
<li>服务端向客户端<em>发送Cookie</em></li>
<li>客户端的浏览器把<em>Cookie保存</em></li>
<li>然后在每次请求浏览器都会将Cookie发送到服务端</li>
</ul>
<p>在HTML文档被发送之前，Web服务器通过传送HTTP 包头中的<em>Set-Cookie</em> 消息把一个cookie 发送到用户的浏览器中，如下示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Set-Cookie: name=value; Path=/; expires=Wednesday, 09-Nov-99 23:12:40 GMT;</div></pre></td></tr></table></figure>
<p>其中比较重要的属性：</p>
<ul>
<li><strong>name=value</strong>：键值对，可以设置要保存的<em> Key/Value</em>，注意这里的 name 不能和其他属性项的名字一样</li>
<li><strong>Expires</strong>： 过期时间（秒），在设置的某个时间点后该 Cookie 就会失效，如 expires=Wednesday, 09-Nov-99 23:12:40 GMT</li>
<li><strong>maxAge</strong>： 最大失效时间（毫秒），设置在多少后失效</li>
<li><strong>secure</strong>： 当 secure 值为 true 时，cookie 在 HTTP 中是无效，在 HTTPS 中才有效</li>
<li><strong>Path</strong>： 表示 cookie 影响到的路，如 path=/。如果路径不能匹配时，浏览器则不发送这个Cookie</li>
<li><strong>httpOnly</strong>： 是微软对COOKIE做的扩展。如果在COOKIE中设置了“httpOnly”属性，则通过程序（JS脚本、applet等）将无法读取到COOKIE信息，防止XSS攻击产生</li>
</ul>
<h2 id="nodejs中的-cookie"><a href="#nodejs中的-cookie" class="headerlink" title="nodejs中的 cookie"></a>nodejs中的 cookie</h2><p>nodejs是如何想客户端发送cookie的呢？ 有两个中方案：</p>
<ul>
<li>使用<strong>response.writeHead</strong>，代码如下：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//设置过期时间为一分钟</span></div><div class="line"><span class="keyword">var</span> today = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line"><span class="keyword">var</span> time = today.getTime() + <span class="number">60</span>*<span class="number">1000</span>;</div><div class="line"><span class="keyword">var</span> time2 = <span class="keyword">new</span> <span class="built_in">Date</span>(time);</div><div class="line"><span class="keyword">var</span> timeObj = time2.toGMTString();</div><div class="line">response.writeHead(&#123;</div><div class="line">   <span class="string">'Set-Cookie'</span>:<span class="string">'myCookie="type=ninja", "language=javascript";path="/";Expires='</span>+timeObj+<span class="string">';httpOnly=true'</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>缺点：使用response.writeHead只能发送一次头部，即只能调用一次，且不能与response.render共存，否则会报错。</p>
<ul>
<li>使用<strong>response.cookie</strong>，代码示例如下：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">response.cookie(<span class="string">'haha'</span>, <span class="string">'name1=value1&amp;name2=value2'</span>, &#123;<span class="attr">maxAge</span>:<span class="number">10</span>*<span class="number">1000</span>, <span class="attr">path</span>:<span class="string">'/'</span>, <span class="attr">httpOnly</span>:<span class="literal">true</span>&#125;);</div></pre></td></tr></table></figure>
<p>语法: <em>response.cookie(‘cookieName’, ‘name=value[name=value…]’,[options]);</em></p>
<h2 id="express-中的-cookie"><a href="#express-中的-cookie" class="headerlink" title="express 中的 cookie"></a>express 中的 cookie</h2><p>express 在 4.x 版本之后，管理session和cookies等许多模块都不再直接包含在express中， `而是需要单独下载安装相应模块。</p>
<p>cookieParser安装：<em>$ npm install cookie-parser</em></p>
<p>使用方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express      = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="comment">// 首先引入 cookie-parser 这个模块</span></div><div class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);</div><div class="line"> </div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line">app.use(cookieParser());</div><div class="line"> </div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="comment">// 如果请求中的 cookie 存在 isVisit, 则输出 cookie</span></div><div class="line">    <span class="comment">// 否则，设置 cookie 字段 isVisit, 并设置过期时间为1分钟</span></div><div class="line">    <span class="keyword">if</span> (req.cookies.isVisit) &#123;</div><div class="line">        <span class="built_in">console</span>.log(req.cookies);</div><div class="line">        res.send(<span class="string">"再次欢迎访问"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        res.cookie(<span class="string">'isVisit'</span>, <span class="number">1</span>, &#123;<span class="attr">maxAge</span>: <span class="number">60</span> * <span class="number">1000</span>&#125;);</div><div class="line">        res.send(<span class="string">"欢迎第一次访问"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">app.listen(<span class="number">80</span>);</div></pre></td></tr></table></figure>
<h2 id="什么是session？"><a href="#什么是session？" class="headerlink" title="什么是session？"></a>什么是session？</h2><p>cookie 虽然很方便，但是使用 cookie 有一个很大的弊端，cookie 中的所有数据在客户端就可以被修改，数据非常容易被伪造，那么一些重要的数据就不能存放在 cookie 中了，而且如果 cookie 中数据字段太多会影响传输效率。为了解决这些问题，就产生了 session，session 中的数据是保留在服务器端的。</p>
<p>session 的运作通过一个 <code>session_id</code> 来进行。<code>session_id</code> 通常是存放在客户端的 cookie 中，比如在 express 中，默认是<code>connect.sid</code> 这个字段，当请求到来时，服务端检查 cookie 中保存的 session_id 并通过这个 session_id 与服务器端的 session data 关联起来，进行数据的保存和修改。</p>
<h2 id="express中的-session"><a href="#express中的-session" class="headerlink" title="express中的 session"></a>express中的 session</h2><p>跟cookie一样都需要单独的安装和引用模块， 安装模块：<em>$sudo npm install express-session</em> 主要的方法就是 session(options)，其中 options 中包含可选参数，主要有：</p>
<ul>
<li><strong>name</strong>: 设置 cookie 中，保存 session 的字段名称，默认为 connect.sid 。</li>
<li><strong>store</strong>: session 的存储方式，默认存放在内存中，也可以使用 redis，mongodb 等。express 生态中都有相应模块的支持。</li>
<li><strong>secret</strong>: 通过设置的 secret 字符串，来计算 hash 值并放在 cookie 中，使产生的 signedCookie 防篡改。</li>
<li><strong>cookie</strong>: 设置存放 session id 的 cookie 的相关选项，默认为 (default: { path: ‘/‘, httpOnly: true, secure: false, maxAge: null })</li>
<li><strong>genid</strong>: 产生一个新的 session_id 时，所使用的函数， 默认使用 uid2 这个 npm 包。</li>
<li><strong>rolling</strong>: 每个请求都重新设置一个 cookie，默认为 false。</li>
<li><strong>resave</strong>: 即使 session 没有被修改，也保存 session 值，默认为 true。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);</div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line"> </div><div class="line">app.use(session(&#123;</div><div class="line">    <span class="attr">secret</span>: <span class="string">'hubwiz app'</span>, <span class="comment">//secret的值建议使用随机字符串</span></div><div class="line">    cookie: &#123;<span class="attr">maxAge</span>: <span class="number">60</span> * <span class="number">1000</span> * <span class="number">30</span>&#125; <span class="comment">// 过期时间（毫秒）</span></div><div class="line">&#125;));</div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (req.session.sign) &#123;<span class="comment">//检查用户是否已经登录</span></div><div class="line">        <span class="built_in">console</span>.log(req.session);<span class="comment">//打印session的值</span></div><div class="line">        res.send(<span class="string">'welecome &lt;strong&gt;'</span> + req.session.name + <span class="string">'&lt;/strong&gt;, 欢迎你再次登录'</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        req.session.sign = <span class="literal">true</span>;</div><div class="line">        req.session.name = <span class="string">'哈哈'</span>;</div><div class="line">        res.send(<span class="string">'欢迎登陆！'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">app.listen(<span class="number">80</span>);</div></pre></td></tr></table></figure>
<h2 id="sescet是个啥？"><a href="#sescet是个啥？" class="headerlink" title="sescet是个啥？"></a>sescet是个啥？</h2><p>我们知道，<a href="https://zh.wikipedia.org/wiki/%E6%95%A3%E5%88%97%E5%87%BD%E6%95%B8" target="_blank" rel="external">HASH算法</a>可以计算任何一种数据的数字“指纹”。它具有这样的基本特性：如果两个数据的散列值不同，那么两个原始值也不同；并且从散列值很难得到原始值。</p>
<p>如果采用hash算法计算得到密码密文并加以保存，这样既可以不保存密码明文，又可以进行密码的验证。web应用中一般采用hash算法来解决密码加密存储问题。下面便是整个加密与验证的过程。</p>
<p>当用户注册时：</p>
<ol>
<li>从客户端的POST请求得到明文的用户名与密码；</li>
<li>对密码进行加密得到密码密文；</li>
<li>将密码密文与用户名存入数据库。</li>
</ol>
<p>当用户需要登录时：</p>
<ol>
<li>从客户端的POST请求得到明文的用户名与密码；</li>
<li>采用同样的方法，对密码进行加密得到密文；</li>
<li>根据用户名从数据库中找到对应的密码密文；</li>
<li>比对这两个密文，如果一致则登录成功，否则密码错误。</li>
</ol>
<p>Node.js内置的<code>crypto</code>模块封装了OpenSSL的诸多算法：hash、hmac、cipher、decipher，还有签名和验证方法。我们可以使用它来进行密码加密。当然我们除了手动实现该过程，也可以使用工具来进行加密与验证。</p>
<blockquote>
<p>即使采用密码加密存储策略，传输过程（包括注册、登录）仍然是明文的形式到达服务器。你可能会问为什么不加密后发送呢？因为Web客户端语言都是解释执行的语言，源代码是透明的。即使客户端进行加密，其加密手段也是公开的，并没有增加安全性。解决该问题的唯一手段是采用HTTPS，加密整个TCP传输通道。</p>
</blockquote>
<p><strong>我们使用<code>cookie</code>已经可以维护用户的登录状态了，然而用户可以伪造一个<code>cookie</code>，那我们的网站岂不是会被用户欺骗？</strong></p>
<blockquote>
<p>很多HTTP客户端软件（包括curl、Node.js）都可以发送任意的HTTP请求，这种攻击非常容易。Cookie是可以被篡改的！</p>
</blockquote>
<p>服务器可以通过hash来检测客户端对Cookie的篡改，通过对Cookie的校验，就可以得到一个安全的<a href="https://en.wikipedia.org/wiki/Session_(computer_science" target="_blank" rel="external">Session</a>)（会话）并且在用户的不同请求中得到维护。</p>
<p>我们除了设置cookie的值，再给一个配对的校验码，只要客户端不知道如何计算配对的校验码，它修改cookie值后我们便会检测到。一个简单的校验过程如下：</p>
<p>在设置Cookie时，计算Hash：</p>
<ol>
<li>确定需要写入cookie的键<code>authenticated</code>和值<code>true</code>；</li>
<li>将<code>true</code>与某个只有服务器知道的字符串<code>#$a3*</code>相加得到<code>true#$a3*</code>；</li>
<li>对<code>true#$a3*</code>进行hash，得到哈希值<code>6hTiBl7lVpdlPjYmVhavhlbcRP3C1wMQJn9ubQaUids</code>；</li>
<li>在cookie中，设置<code>authenticated</code>值为<code>true|6hTiBl7lVpdlPjYmVhavhlbcRP3C1wMQJn9ubQaUids</code>；</li>
</ol>
<p>在后续请求到达时，进行校验：</p>
<ol>
<li>得到cookie <code>authenticated</code>值<code>true|6hTiBl7lVpdlPjYmVhavhlbcRP3C1wMQJn9ubQaUids</code>；</li>
<li>其中其中的值<code>true</code>和客户端传来的哈希值<code>6hTiBl7lVpdlPjYmVhavhlbcRP3C1wMQJn9ubQaUids</code>；</li>
<li>将<code>true</code>与<code>#$a3*</code>（注意，该字符串只有服务器知道）相加得到<code>true#$a3*</code>；</li>
<li>对<code>true#$a3*</code>进行hash，得到我们计算的哈希值<code>6hTiBl7lVpdlPjYmVhavhlbcRP3C1wMQJn9ubQaUids</code>；</li>
<li>将客户端传来的哈希值与我们计算的哈希值进行比对，如果一致则cookie未被篡改，否则cookie无效。</li>
</ol>
<p>因为客户端不知道我们的<code>secret</code>：<code>#$a3*</code>，于是它篡改cookie值<code>true</code>后无法得到正确的哈希值，于是服务器便会发现cookie值与哈希值不匹配了。</p>
<h2 id="session的存储"><a href="#session的存储" class="headerlink" title="session的存储"></a>session的存储</h2><p> 1）内存、2）cookie本身、3）redis 或 memcached 等缓存中，或者4）数据库中。线上来说，缓存的方案比较常见，存数据库的话，查询效率相比前三者都太低，</p>
<h3 id="1）-在内存中存储-session"><a href="#1）-在内存中存储-session" class="headerlink" title="1） 在内存中存储 session"></a>1） 在内存中存储 session</h3><p><code>express-session</code> 默认使用内存来存 session，对于开发调试来说很方便。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="comment">// 首先引入 express-session 这个模块</span></div><div class="line"><span class="keyword">var</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line">app.listen(<span class="number">5000</span>);</div><div class="line"></div><div class="line"><span class="comment">// 按照上面的解释，设置 session 的可选参数</span></div><div class="line">app.use(session(&#123;</div><div class="line">  <span class="attr">secret</span>: <span class="string">'recommand 128 bytes random string'</span>, <span class="comment">// 建议使用 128 个字符的随机字符串</span></div><div class="line">  cookie: &#123; <span class="attr">maxAge</span>: <span class="number">60</span> * <span class="number">1000</span> &#125;</div><div class="line">&#125;));</div><div class="line"></div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">// 检查 session 中的 isVisit 字段</span></div><div class="line">  <span class="comment">// 如果存在则增加一次，否则为 session 设置 isVisit 字段，并初始化为 1。</span></div><div class="line">  <span class="keyword">if</span>(req.session.isVisit) &#123;</div><div class="line">    req.session.isVisit++;</div><div class="line">    res.send(<span class="string">'&lt;p&gt;第 '</span> + req.session.isVisit + <span class="string">'次来此页面&lt;/p&gt;'</span>);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    req.session.isVisit = <span class="number">1</span>;</div><div class="line">    res.send(<span class="string">"欢迎第一次来这里"</span>);</div><div class="line">    <span class="built_in">console</span>.log(req.session);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="2）-在-redis-中存储-session"><a href="#2）-在-redis-中存储-session" class="headerlink" title="2） 在 redis 中存储 session"></a>2） 在 redis 中存储 session</h3><p>session 存放在内存中不方便进程间共享，因此可以使用 redis 等缓存来存储 session。</p>
<p>假设你的机器是 4 核的，你使用了 4 个进程在跑同一个 node web 服务，当用户访问进程1时，他被设置了一些数据当做 session 存在内存中。而下一次访问时，他被负载均衡到了进程2，则此时进程2的内存中没有他的信息，认为他是个新用户。这就会导致用户在我们服务中的状态不一致。</p>
<p>使用 redis 作为缓存，可以使用 <code>connect-redis</code> 模块(<a href="https://github.com/tj/connect-redis" target="_blank" rel="external">https://github.com/tj/connect-redis</a> )来得到 redis 连接实例，然后在 session 中设置存储方式为该实例。</p>
<p> <strong>参数</strong></p>
<ul>
<li><strong>client</strong> 你可以复用现有的redis客户端对象， 由 redis.createClient() 创建</li>
<li><strong>host</strong> Redis服务器名</li>
<li><strong>port</strong> Redis服务器端口</li>
<li><p><strong>socket</strong> Redis服务器的unix_socket</p>
<p><strong>可选参数</strong></p>
</li>
<li><p><strong>ttl</strong> Redis session TTL 过期时间 （秒）</p>
</li>
<li><strong>disableTTL</strong> 禁用设置的 TTL</li>
<li><strong>db</strong> 使用第几个数据库</li>
<li><strong>pass</strong> Redis数据库的密码</li>
<li><strong>prefix</strong> 数据表前辍即schema, 默认为 “sess:”</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);</div><div class="line"><span class="keyword">var</span> redisStore = <span class="built_in">require</span>(<span class="string">'connect-redis'</span>)(session);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express();</div><div class="line">app.listen(<span class="number">5000</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> options = &#123;</div><div class="line">    <span class="string">"host"</span>: <span class="string">"127.0.0.1"</span>,</div><div class="line">    <span class="string">"port"</span>: <span class="string">"6379"</span>,</div><div class="line">    <span class="string">"ttl"</span>: <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">30</span>,   <span class="comment">//session的有效期为30天(秒)</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line">app.use(session(&#123;</div><div class="line">  <span class="comment">// 假如你不想使用 redis 而想要使用 memcached 的话，代码改动也不会超过 5 行。</span></div><div class="line">  <span class="comment">// 这些 store 都遵循着统一的接口，凡是实现了那些接口的库，都可以作为 session 的 store 使用，比如都需要实现 .get(keyString) 和 .set(keyString, value) 方法。</span></div><div class="line">  <span class="comment">// 编写自己的 store 也很简单</span></div><div class="line">  store: <span class="keyword">new</span> redisStore(options),</div><div class="line">  <span class="attr">secret</span>: <span class="string">'somesecrettoken'</span></div><div class="line">&#125;));</div><div class="line"></div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span>(req.session.isVisit) &#123;</div><div class="line">    req.session.isVisit++;</div><div class="line">    res.send(<span class="string">'&lt;p&gt;第 '</span> + req.session.isVisit + <span class="string">'次来到此页面&lt;/p&gt;'</span>);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    req.session.isVisit = <span class="number">1</span>;</div><div class="line">    res.send(<span class="string">'欢迎第一次来这里'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们可以运行 <code>redis-cli</code> 查看结果。</p>
<h3 id="3）在mongodb中存储session"><a href="#3）在mongodb中存储session" class="headerlink" title="3）在mongodb中存储session"></a>3）在mongodb中存储session</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</div><div class="line"><span class="keyword">var</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);</div><div class="line"><span class="keyword">var</span> MongoStore = <span class="built_in">require</span>(<span class="string">'connect-mongo/es5'</span>)(session);</div><div class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</div><div class="line"></div><div class="line"><span class="keyword">var</span> app = express()</div><div class="line"></div><div class="line">mongoose.connect(<span class="string">'mongodb://127.0.0.1:27017/hubwiz'</span>); <span class="comment">//连接数据库</span></div><div class="line">mongoose.connection.on(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'-----------数据库连接成功！------------'</span>);</div><div class="line">&#125;);</div><div class="line"> </div><div class="line">app.use(session(&#123;</div><div class="line">    <span class="attr">secret</span>: <span class="string">"what do you want to do?"</span>, <span class="comment">//secret的值建议使用128个随机字符串</span></div><div class="line">    cookie: &#123;<span class="attr">maxAge</span>: <span class="number">60</span> * <span class="number">1000</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">14</span>&#125;, <span class="comment">//过期时间</span></div><div class="line">    resave: <span class="literal">true</span>, <span class="comment">// 即使 session 没有被修改，也保存 session 值，默认为 true</span></div><div class="line">    saveUninitialized: <span class="literal">true</span>,</div><div class="line">    <span class="attr">store</span>: <span class="keyword">new</span> MongoStore(&#123;</div><div class="line">        <span class="attr">mongooseConnection</span>: mongoose.connection <span class="comment">//使用已有的数据库连接</span></div><div class="line">    &#125;)</div><div class="line">&#125;));</div><div class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">// 检查 session 中的 isVisit 字段</span></div><div class="line">  <span class="comment">// 如果存在则增加一次，否则为 session 设置 isVisit 字段，并初始化为 1。</span></div><div class="line">  <span class="keyword">if</span>(req.session.isVisit) &#123;</div><div class="line">    req.session.isVisit++;</div><div class="line">    <span class="built_in">console</span>.log(req.session)</div><div class="line">    res.send(<span class="string">'&lt;p&gt;第 '</span> + req.session.isVisit + <span class="string">'次来此页面&lt;/p&gt;'</span>);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    req.session.isVisit = <span class="number">1</span>;</div><div class="line">    res.send(<span class="string">"欢迎第一次来这里"</span>);</div><div class="line">    <span class="built_in">console</span>.log(req.session);</div><div class="line">  &#125;</div><div class="line">&#125;);</div><div class="line">app.listen(<span class="number">8080</span>);</div></pre></td></tr></table></figure>
<p>参考：</p>
<p><a href="https://github.com/alsotang/node-lessons/tree/master/lesson16" target="_blank" rel="external">session</a></p>
<p><a href="https://www.tianmaying.com/" target="_blank" rel="external">天码营</a></p>
</div>

    <div class="post-sidebar">
  <div class="toggle-btn" id="toggle-btn">
    <i class="fa fa-reorder"></i>
  </div>
  <section class="post-toc-wrap" id="post-sidebar">
    <h2 class="toc-title">内容目录</h2>
    <div class="post-toc">
      
      
        <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#cookie"><span class="nav-number">1.</span> <span class="nav-text">cookie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nodejs中的-cookie"><span class="nav-number">2.</span> <span class="nav-text">nodejs中的 cookie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#express-中的-cookie"><span class="nav-number">3.</span> <span class="nav-text">express 中的 cookie</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是session？"><span class="nav-number">4.</span> <span class="nav-text">什么是session？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#express中的-session"><span class="nav-number">5.</span> <span class="nav-text">express中的 session</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sescet是个啥？"><span class="nav-number">6.</span> <span class="nav-text">sescet是个啥？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#session的存储"><span class="nav-number">7.</span> <span class="nav-text">session的存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1）-在内存中存储-session"><span class="nav-number">7.1.</span> <span class="nav-text">1） 在内存中存储 session</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2）-在-redis-中存储-session"><span class="nav-number">7.2.</span> <span class="nav-text">2） 在 redis 中存储 session</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3）在mongodb中存储session"><span class="nav-number">7.3.</span> <span class="nav-text">3）在mongodb中存储session</span></a></li></ol></li></ol></div>
      
    </div>
  </section>
</div>


  </div>

  <footer class="post-footer">
    
      <div class="post-tags">
        
          <a href="/tags#Node" rel="tag">#Node</a>
        
      </div>
    
    

  </footer>

</article>




      
  <div class="comments" id="comments">
    
  </div>




    </main>

    <footer class="footer clearfix">
  <div class="copyright" >
    <span>Copyright</span>
    
    &copy; 
    <span itemprop="copyrightYear">2017</span>
    <span class="author" itemprop="copyrightHolder">ChenXing</span>
  </div>

  <div class="info">
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <span id="busuanzi_container_site_pv">
        总访问量<span id="busuanzi_value_site_pv"></span>次
    </span>
  </div>

</footer>


  </div>

  <div class="back-top-btn" id="back-top-btn"><i class="fa fa-chevron-up"></i></div>






  





<script type="text/javascript" src="/js/motto.min.js?v=0.4.5.1"></script>
<script type="text/javascript" src="/js/main.js?v=0.4.5.1"></script>


</body>
</html>
