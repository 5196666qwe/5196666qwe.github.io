<!DOCTYPE html>
<html lang="en">
<head>
  <!-- content-Type -->
<meta charset="utf-8">


<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="language" content="en">
<meta name="robots" content="all">


<meta content="yes" name="apple-mobile-web-app-capable">
<meta content="black" name="apple-mobile-web-app-status-bar-style">
<meta content="telephone=no" name="format-detection">
<meta content="email=no" name="format-detection">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






<meta name="google-site-verification" content="xxxxxxxxxx" />




<meta name="baidu-site-verification" content="xxxxxxxxxx" />







<meta name="keywords" content="Java," />


<meta name="description" content="前面我们完成了一个简单MVC框架了，已经能完成响应，依赖注入，返回渲染数据了，此外，还有一些非常好的特性没有提供，就是AOP。我们可以使用这个特性来实现一些横向拦截操作。比如性能分析，日志收集，安全控制。把这些功能抽离出来之后，再通过“动态织入”的方式掺入业务逻辑模块中。这样做的好处首先是可以保持业务逻辑模块的纯净和高内聚性，其次是可以很方便地复用日志统计等功能模块。
先看看Js是怎么实现AOP，">
<meta property="og:type" content="article">
<meta property="og:title" content="打造轻量web框架02">
<meta property="og:url" content="http://yoursite.com/2016/10/15/打造轻量web框架02/index.html">
<meta property="og:site_name" content="ChenXing">
<meta property="og:description" content="前面我们完成了一个简单MVC框架了，已经能完成响应，依赖注入，返回渲染数据了，此外，还有一些非常好的特性没有提供，就是AOP。我们可以使用这个特性来实现一些横向拦截操作。比如性能分析，日志收集，安全控制。把这些功能抽离出来之后，再通过“动态织入”的方式掺入业务逻辑模块中。这样做的好处首先是可以保持业务逻辑模块的纯净和高内聚性，其次是可以很方便地复用日志统计等功能模块。
先看看Js是怎么实现AOP，">
<meta property="og:image" content="http://yoursite.com/img/java_web/java_web2.png">
<meta property="og:updated_time" content="2017-03-22T14:19:03.359Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="打造轻量web框架02">
<meta name="twitter:description" content="前面我们完成了一个简单MVC框架了，已经能完成响应，依赖注入，返回渲染数据了，此外，还有一些非常好的特性没有提供，就是AOP。我们可以使用这个特性来实现一些横向拦截操作。比如性能分析，日志收集，安全控制。把这些功能抽离出来之后，再通过“动态织入”的方式掺入业务逻辑模块中。这样做的好处首先是可以保持业务逻辑模块的纯净和高内聚性，其次是可以很方便地复用日志统计等功能模块。
先看看Js是怎么实现AOP，">
<meta name="twitter:image" content="http://yoursite.com/img/java_web/java_web2.png">






  <link rel="shorticon icon" type="image/x-icon" href="/img/favicon.ico?v=0.4.5.1" />






<link href="http://cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


<script>
(function(){
  var bp = document.createElement('script');
  bp.src = '//push.zhanzhang.baidu.com/push.js';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();
</script>

  <title> 打造轻量web框架02 </title>
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'xxxxxxxxxx', 'auto');
  ga('send', 'pageview');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?1551fdd18711ccb1c048bb11f579b1a4";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



</head>
<body lang="zh-Hans">

  <!--[if lte IE 9]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->


  <div class="another-theme layout">

    
<header class="header" id="header">

  <div class="header-cont">
    <div class="text-area">
      
        <h1 class="title" data-text="打造轻量web框架02"> 打造轻量web框架02 </h1>

        
        <div class="post-meta">
          <div class="post-time">
            发表于
            <time  datetime="2016-10-15T23:50:50+08:00" content="2016-10-15">
              2016-10-15
            </time>
          </div>

          
            <div class="post-category" >
              
                <span>
                  <a href="/categories#Java" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                

              
            </div>
          

          
            
              <span class="post-comments-count">
                <a href="/2016/10/15/打造轻量web框架02/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/15/打造轻量web框架02/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          
        </div>
        
      
    </div>
    <!-- Navigation -->
    
    <nav class="navigation clearfix" id="navigation">
      
        
        <a class="nav-link" href="/" rel="section">
          首页
        </a>
      
        
        <a class="nav-link" href="/tags" rel="section">
          标签
        </a>
      
        
        <a class="nav-link" href="/categories" rel="section">
          分类
        </a>
      
        
        <a class="nav-link" href="/about" rel="section">
          关于
        </a>
      
    </nav>
    
  </div>
  <div class="mask"></div>
</header>


    <main class="container">

      

  <article class="post-article post-type-normal post" itemscope>

  <div class="post-body">

    <div class="content markdown-body"><p>前面我们完成了一个简单MVC框架了，已经能完成响应，依赖注入，返回渲染数据了，此外，还有一些非常好的特性没有提供，就是AOP。我们可以使用这个特性来实现一些横向拦截操作。比如性能分析，日志收集，安全控制。把这些功能抽离出来之后，再通过“动态织入”的方式掺入业务逻辑模块中。这样做的好处首先是可以保持业务逻辑模块的纯净和高内聚性，其次是可以很方便地复用日志统计等功能模块。</p>
<p>先看看Js是怎么实现AOP，然后我们再看看java是怎么苦逼实现的。最后我们来把这个特性揉进mvc里。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Function</span>.prototype.before = <span class="function"><span class="keyword">function</span> (<span class="params">beforefn</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> __self = <span class="keyword">this</span>; <span class="comment">// 保存原函数的引用</span></div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="comment">// 返回包含了原函数和新函数的"代理"函数</span></div><div class="line">        beforefn.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>); <span class="comment">// 执行新函数，修正 this</span></div><div class="line">        <span class="keyword">return</span> __self.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>); <span class="comment">// 执行原函数</span></div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="built_in">Function</span>.prototype.after = <span class="function"><span class="keyword">function</span> (<span class="params">afterfn</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> __self = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> ret = __self.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</div><div class="line">        afterfn.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</div><div class="line">&#125;;</div><div class="line">func = func.before(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>);</div><div class="line">&#125;).after(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>);</div><div class="line">&#125;);</div><div class="line">func();</div></pre></td></tr></table></figure>
<p>对，你没看错就是这么简单。</p>
<p>然后我们来看看java是怎么实现的.</p>
<h2 id="JDK动态代理和CGlib"><a href="#JDK动态代理和CGlib" class="headerlink" title="JDK动态代理和CGlib"></a>JDK动态代理和CGlib</h2><p>有动态代理就有静态代理.</p>
<p>先写一个Hello World</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Hello</span></span>&#123;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">say</span><span class="params">(String name)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面是一个Hello接口，以下是实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloImpl</span> <span class="keyword">implements</span> <span class="title">Hello</span></span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(String name)</span></span>&#123;</div><div class="line">    System.out.println(<span class="string">"Hello! "</span> + name );</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们要在say方法前面和后面分别需要处理一些逻辑，该怎么作？</p>
<p>要用代理模式，写一个HellpProxy类，让它调用HelloImpl的say方法，在调用前后分别进行逻辑处理即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloProxy</span> <span class="title">implemens</span> <span class="title">Hello</span></span>&#123;</div><div class="line">  <span class="keyword">private</span> Hello hello;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HelloProxy</span><span class="params">()</span></span>&#123;</div><div class="line">    hello = <span class="keyword">new</span> HelloImpl();</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(String name)</span></span>&#123;</div><div class="line">    before();</div><div class="line">    hello.say(name);</div><div class="line">    after();</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</div><div class="line">    System.out.pritln(<span class="string">"before"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</div><div class="line">    System.out.pritln(<span class="string">"after"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后你就知道怎么用了。简单的代理模式使用。</p>
<p>你会发现一个问题，这个代理类显然不是通用的，而且如果接口变了，所有代理类都得变。这是不合理的。所以JDK提供了一个动态代理给我们。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DyncmicProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Object target;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DyncmicProxy</span><span class="params">(Object target)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.target = target;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">		before();</div><div class="line">		Object result = method.invoke(target, args);</div><div class="line">		after();</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</div><div class="line">		System.out.println(<span class="string">"before"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</div><div class="line">		System.out.println(<span class="string">"after"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 DynamicProxy 类中，定义了一个Object类型的 target 变量，它是被代理的对象，通过构造函数来初始化。</p>
<p>DynamicProxy 实现了 InvocationHandler 接口，那么必须实现该接口的 invoke 方法。在该方法中，直接通过反射来去 invoke method，在调用前后分别处理 before 和 after,最后将result返回.</p>
<p>怎么使用？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Hello hello = <span class="keyword">new</span> HelloImpl();	</div><div class="line">		DyncmicProxy dyncmicProxy = <span class="keyword">new</span> DyncmicProxy(hello);	</div><div class="line">		Hello helloProxy = (Hello)Proxy.newProxyInstance(</div><div class="line">				hello.getClass().getClassLoader(), </div><div class="line">				hello.getClass().getInterfaces(), </div><div class="line">				dyncmicProxy</div><div class="line">		);</div><div class="line">		helloProxy.say(<span class="string">"zjl"</span>);	</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重构一下，让这个 DyncmicProxy 类变成通用，避免到处使用 Proxy.newProxyInstance ,而且强制类型转换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DyncmicProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Object target;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DyncmicProxy</span><span class="params">(Object target)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.target = target;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">		before();</div><div class="line">		Object result = method.invoke(target, args);</div><div class="line">		after();</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> (T) Proxy.newProxyInstance(</div><div class="line">				<span class="keyword">this</span>.target.getClass().getClassLoader(),</div><div class="line">				<span class="keyword">this</span>.target.getClass().getInterfaces(), </div><div class="line">				<span class="keyword">this</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</div><div class="line">		System.out.println(<span class="string">"before"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</div><div class="line">		System.out.println(<span class="string">"after"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的动态代理不是万能的，比如说要代理一个没有任何接口的类，它就没有一点卵用了。然后我们看看CGlib这个类库，它是一个在运行期间动态生成字节码的工具，也就是动态生成代理类(改天学学)。先看看怎么用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CGLibProxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span></span>&#123;</div><div class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Class&lt;T&gt; cls)</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> (T) Enhancer.create(cls,<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj,Method method,Object[] args,MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">    before();</div><div class="line">    Object result = proxy.invokeSuper(obj,args);</div><div class="line">    after();</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>需要实现CGlib给我们提供的MethodInterceptor实现类，并填充 intercept 方法。方法中最后一个 MethodProxy 类型的参数 proxy 值得注意. 这是它提供给我们的方法级别代理。我们直接调用 proxy 的 invokeSuper 方法即可。</p>
<p>看看怎么使用.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">  CGLibProxy cgLibProxy = <span class="keyword">new</span> CGLibProxy();</div><div class="line">  Hello helloProxy = cgLibProxy.getProxy(HelloImpl.class);</div><div class="line">  helloProxy.say(<span class="string">"zjl"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="开工前的思考"><a href="#开工前的思考" class="headerlink" title="开工前的思考"></a>开工前的思考</h2><p>学了一项技术，就要应用起来。</p>
<p>停下来思考几分钟，怎么利用这个CGlib对我们mvc框架里面Controller的action进行拦截？</p>
<p>我们记得最后，我们分发器里面返回了注入过的Controller对象，然后调用相应的方法。如果说我们把这个Controller对象换成上面的代理对象，不就ok了？</p>
<p>此时，我们的内心应该是一阵窃喜。然而思考一会儿，这个躁动的心就会平复下来。</p>
<p>得到代理对象很好办，但这里面的before,after方法不应该是写死的，是可以配置的，怎么弄？</p>
<p>对于每个action，不应该只有一组before,after，还有别的拦截器进行某方面处理，怎么解决？</p>
<p>先看看第一大个问题，不是写死的，应该是可以配置的，怎么弄？</p>
<ol>
<li>既然不是写死可配置的，那么肯定是针对这个类的，也就是说before，after应该先存放在某个地方，且这个控制类得知道这两个方法是我的，等到代理的时候取出来调用即可。<ol>
<li>before，after存放在哪里？<ol>
<li>肯定是类的方法啊，用某种类表示某种切面。</li>
</ol>
</li>
<li>怎么让控制类知道这两个方法是我的？<ol>
<li>既然before，after是类的，那么我只要在类上做个标记，告诉这是某控制类的。<ol>
<li>显然用注解做标识是十分合适的。</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>第二个大问题，不应该只有一组before,after，还有别的拦截器进行某方面处理，怎么解决？</p>
<ol>
<li>特别简单啊，我们可以把所有的拦截操作存起来，然后依次取出来即可。类似这样</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj,Method method,Object[] args,MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">		XXXbefore();</div><div class="line"> 		YYYbefore();</div><div class="line">		Object result = proxy.invokeSuper(obj,args);</div><div class="line">		XXXafter();</div><div class="line">  		YYYafter();</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>2.这里面还有个问题，分析方法应该具有控制类信息，也是就说得把控制类和方法当作参数传进来，以便分析。</p>
<p>方法已经有了.剩下的就是实施了。</p>
<p><img src="/img/java_web/java_web2.png" alt="java_web"></p>
<h3 id="定义切面注解"><a href="#定义切面注解" class="headerlink" title="定义切面注解"></a>定义切面注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Aspect &#123;</div><div class="line">    Class&lt;? extends Annotation&gt; value();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注解包含一个value属性，它是一个注解类，用来定义 Controller 这类的注解.</p>
<h3 id="搭建代理框架"><a href="#搭建代理框架" class="headerlink" title="搭建代理框架"></a>搭建代理框架</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Proxy</span> </span>&#123;</div><div class="line">    <span class="function">Object <span class="title">doProxy</span><span class="params">(ProxyChain proxyChain)</span> <span class="keyword">throws</span> Throwable</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Proxy接口包括了一个doProxy方法，传入一个 ProxyChain,用于执行链式操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyChain</span> </span>&#123;</div><div class="line">  	<span class="comment">//目标类</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; targetClass;</div><div class="line">  	<span class="comment">//目标对象</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object targetObject;</div><div class="line">  	<span class="comment">//目标方法</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Method targetMethod;</div><div class="line">  	<span class="comment">//方法代理</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MethodProxy methodProxy;</div><div class="line">  	<span class="comment">//方法参数</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] methodParams;</div><div class="line">	<span class="comment">//代理列表</span></div><div class="line">    <span class="keyword">private</span> List&lt;Proxy&gt; proxyList = <span class="keyword">new</span> ArrayList&lt;Proxy&gt;();</div><div class="line">  	<span class="comment">//索引</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> proxyIndex = <span class="number">0</span>;</div><div class="line">	<span class="comment">//构造方法，set，get省略。</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">doProxyChain</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">        Object methodResult= <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (proxyIndex &lt; proxyList.size()) &#123;</div><div class="line">            methodResult = proxyList.get(proxyIndex++).doProxy(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            methodResult = methodProxy.invokeSuper(targetObject, methodParams);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> methodResult;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代理管理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//创建所有代理对象</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyManager</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createProxy</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; targetClass, <span class="keyword">final</span> List&lt;Proxy&gt; proxyList)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (T) Enhancer.create(targetClass, <span class="keyword">new</span> MethodInterceptor() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ProxyChain(targetClass, o, method, methodProxy, objects, proxyList).doProxyChain();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>谁来调用ProxyManager呢？当然是切面类了，因为在切面类中，需要在目标别调用的前后增加相应的逻辑。我们有必要写一个抽象类，提供一个模板方法，并在该抽象类的具体实现中扩展相应方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AspectProxy</span> <span class="keyword">implements</span> <span class="title">Proxy</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">doProxy</span><span class="params">(ProxyChain proxyChain)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"></div><div class="line">        Object result = <span class="keyword">null</span>;</div><div class="line">        Class&lt;?&gt; cls = proxyChain.getTargetClass();</div><div class="line">        Method method = proxyChain.getTargetMethod();</div><div class="line">        Object[] params = proxyChain.getMethodParams();</div><div class="line">        </div><div class="line">        begin();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (intercept(cls, method, params)) &#123;</div><div class="line">                before(cls, method, params);</div><div class="line">                result = proxyChain.doProxyChain();</div><div class="line">                after(cls, method, params);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                result = proxyChain.doProxyChain();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            error(cls, method, params, e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">finally</span> &#123;</div><div class="line">            end();    </div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] params)</span> <span class="keyword">throws</span> Throwable</span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] params)</span> <span class="keyword">throws</span> Throwable</span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">intercept</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] params)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] params, Exception e)</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这些抽象方法可在 AspectProxy 的子类中有选择的实现，就像下面这样的.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Aspect</span>(Controller.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControllerAspect</span> <span class="keyword">extends</span> <span class="title">AspectProxy</span></span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ControllerAspect.class);</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> <span class="keyword">long</span> begin;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Class&lt;?&gt; cls,Method method,Object[] params)</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">		LOGGER.debug(<span class="string">"----begin---"</span>);</div><div class="line">		LOGGER.debug(String.format(<span class="string">"class:%s"</span>, cls.getName()));</div><div class="line">		LOGGER.debug(String.format(<span class="string">"method:%s"</span>, method.getName()));</div><div class="line">		begin = System.currentTimeMillis();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Class&lt;?&gt; cls,Method method,Object[] params)</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">		LOGGER.debug(String.format(<span class="string">"time:%dms"</span>, System.currentTimeMillis() - begin));</div><div class="line">		LOGGER.debug(<span class="string">"===end+===="</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="加载AOP框架"><a href="#加载AOP框架" class="headerlink" title="加载AOP框架"></a>加载AOP框架</h3><p>上面的逻辑基本就差不多了。剩下的就主要是把上一节的普通对象，变成代理对象即可。</p>
<p>由于我们需要扩展 AspectProxy抽象类的所有具体类,此外还需获取带有Aspect注解的所有类，因为需要在ClassHelper中添加两个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 类操作助手类</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">//加载所有包下的类放到set里面 可获取service controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassHelper</span> </span>&#123;</div><div class="line">	...</div><div class="line">   <span class="comment">//获取报名下所有superclss的 子类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetBySuper(Class&lt;?&gt; superClass) &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</div><div class="line">            <span class="keyword">if</span> (superClass.isAssignableFrom(superClass) &amp;&amp; !superClass.equals(cls)) &#123;</div><div class="line">                classSet.add(cls);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取带某注解的类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetByAnnotation(Class&lt;? extends Annotation&gt; annotationClass) &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</div><div class="line">            <span class="keyword">if</span> (cls.isAnnotationPresent(annotationClass)) &#123;</div><div class="line">                classSet.add(cls);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后的AopHelper类，看看它完成了什么工作，先获取切面class，以及对应的要增强所有的class，然后获取要增强class和对应增强的所有代理class。最后根据这个映射关系得到代理对象，替代原来对象即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AopHelper</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER  = LoggerFactory.getLogger(AopHelper.class);</div><div class="line">	</div><div class="line">	<span class="keyword">static</span>&#123;</div><div class="line">		<span class="keyword">try</span>&#123;</div><div class="line">			<span class="comment">//获取切面类和切面类上面注解集合 比如（controller)  切面和对应增强的class类，一个切面可以增强n个类</span></div><div class="line">			Map&lt;Class&lt;?&gt;,Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap = createProxyMap();</div><div class="line">			<span class="comment">//获取controller和该切面对象列表  比如(controllerraspect) 一个目标类可以被n个切面代理增强</span></div><div class="line">			Map&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt; targetMap = createTargetMap(proxyMap);</div><div class="line">			<span class="keyword">for</span> ( Map.Entry&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt; targetEntry : targetMap.entrySet())&#123;</div><div class="line">				Class&lt;?&gt; targetClass  = targetEntry.getKey();</div><div class="line">				List&lt;Proxy&gt; proxyList = targetEntry.getValue();</div><div class="line">													<span class="comment">// controller  切面对象</span></div><div class="line">				Object proxy = ProxyManager.createProxy(targetClass,proxyList);</div><div class="line">				BeanHelper.setBean(targetClass, proxy);</div><div class="line">			&#125;</div><div class="line">		&#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">			LOGGER.error(<span class="string">"aop failure"</span>,e);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; createProxyMap() <span class="keyword">throws</span> Exception &#123;</div><div class="line">        Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt;();</div><div class="line">        <span class="comment">//获取所有 AspectProxy的子类 比如controllerAspect</span></div><div class="line">        Set&lt;Class&lt;?&gt;&gt; proxyClassSet = ClassHelper.getClassSetBySuper(AspectProxy.class);</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; proxyClass : proxyClassSet) &#123;</div><div class="line">            <span class="keyword">if</span> (proxyClass.isAnnotationPresent(Aspect.class)) &#123;</div><div class="line">                Aspect aspect = proxyClass.getAnnotation(Aspect.class);</div><div class="line">                <span class="comment">//获取所有注解为aspect的value 也就是 注解Controller的类</span></div><div class="line">                Set&lt;Class&lt;?&gt;&gt; targetClassSet = createTargetClassSet(aspect);</div><div class="line">                			<span class="comment">// controlelraspect  List&lt;CustomerConstoller&gt;</span></div><div class="line">                proxyMap.put(proxyClass, targetClassSet);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> proxyMap;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt; createTargetMap(Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap) <span class="keyword">throws</span> Exception&#123;</div><div class="line">        Map&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt; targetMap = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyEntry : proxyMap.entrySet()) &#123;</div><div class="line">            Class&lt;?&gt; proxyClass = proxyEntry.getKey();</div><div class="line">            Set&lt;Class&lt;?&gt;&gt; proxyClassSet = proxyEntry.getValue();</div><div class="line">            <span class="keyword">for</span> (Class&lt;?&gt; targetClass : proxyClassSet) &#123;</div><div class="line">                Proxy proxy = (Proxy) proxyClass.newInstance();</div><div class="line">                <span class="keyword">if</span> (targetMap.containsKey(targetClass)) &#123;</div><div class="line">                    targetMap.get(targetClass).add(proxy);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                    List&lt;Proxy&gt; proxyList = <span class="keyword">new</span> ArrayList&lt;Proxy&gt;();</div><div class="line">                    proxyList.add(proxy);</div><div class="line">                    targetMap.put(targetClass, proxyList);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> targetMap;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取带Aspect类放到set里面</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; createTargetClassSet(Aspect aspect) <span class="keyword">throws</span> Exception &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; targetClassSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="comment">//interface com.chenxing.online.annotation.Controller</span></div><div class="line">        Class&lt;? extends Annotation&gt; annotation = aspect.value();</div><div class="line">        <span class="keyword">if</span> (annotation != <span class="keyword">null</span> &amp;&amp; !annotation.equals(Aspect.class)) &#123;</div><div class="line">        	<span class="comment">//获取所有注解为controller的类</span></div><div class="line">            targetClassSet.addAll(ClassHelper.getClassSetByAnnotation(annotation));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> targetClassSet;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">new</span> AopHelper();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</div>

    <div class="post-sidebar">
  <div class="toggle-btn" id="toggle-btn">
    <i class="fa fa-reorder"></i>
  </div>
  <section class="post-toc-wrap" id="post-sidebar">
    <h2 class="toc-title">内容目录</h2>
    <div class="post-toc">
      
      
        <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#JDK动态代理和CGlib"><span class="nav-text">JDK动态代理和CGlib</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开工前的思考"><span class="nav-text">开工前的思考</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#定义切面注解"><span class="nav-text">定义切面注解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#搭建代理框架"><span class="nav-text">搭建代理框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加载AOP框架"><span class="nav-text">加载AOP框架</span></a></li></ol></li></ol></div>
      
    </div>
  </section>
</div>


  </div>

  <footer class="post-footer">
    
      <div class="post-tags">
        
          <a href="/tags#Java" rel="tag">#Java</a>
        
      </div>
    
    

  </footer>

</article>




      
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/10/15/打造轻量web框架02/"
           data-title="打造轻量web框架02" data-url="http://yoursite.com/2016/10/15/打造轻量web框架02/">
      </div>
    
  </div>




    </main>

    <footer class="footer clearfix">
  <div class="copyright" >
    <span>Copyright</span>
    
    &copy; 
    <span itemprop="copyrightYear">2017</span>
    <span class="author" itemprop="copyrightHolder">ChenXing</span>
  </div>

  <div class="info">
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <span id="busuanzi_container_site_pv">
        总访问量<span id="busuanzi_value_site_pv"></span>次
    </span>
  </div>

</footer>


  </div>

  <div class="back-top-btn" id="back-top-btn"><i class="fa fa-chevron-up"></i></div>





  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"xxxxxxxxxx"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     






<script type="text/javascript" src="/js/motto.min.js?v=0.4.5.1"></script>
<script type="text/javascript" src="/js/main.js?v=0.4.5.1"></script>


</body>
</html>
