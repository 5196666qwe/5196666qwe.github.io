
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>打造轻量web框架02 | ChenXing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前面我们完成了一个简单MVC框架了，已经能完成响应，依赖注入，返回渲染数据了，此外，还有一些非常好的特性没有提供，就是AOP。我们可以使用这个特性来实现一些横向拦截操作。比如性能分析，日志收集，安全控制。把这些功能抽离出来之后，再通过“动态织入”的方式掺入业务逻辑模块中。这样做的好处首先是可以保持业务逻辑模块的纯净和高内聚性，其次是可以很方便地复用日志统计等功能模块。
先看看Js是怎么实现AOP，">
<meta property="og:type" content="article">
<meta property="og:title" content="打造轻量web框架02">
<meta property="og:url" content="http://yoursite.com/2016/10/15/打造轻量web框架02/index.html">
<meta property="og:site_name" content="ChenXing">
<meta property="og:description" content="前面我们完成了一个简单MVC框架了，已经能完成响应，依赖注入，返回渲染数据了，此外，还有一些非常好的特性没有提供，就是AOP。我们可以使用这个特性来实现一些横向拦截操作。比如性能分析，日志收集，安全控制。把这些功能抽离出来之后，再通过“动态织入”的方式掺入业务逻辑模块中。这样做的好处首先是可以保持业务逻辑模块的纯净和高内聚性，其次是可以很方便地复用日志统计等功能模块。
先看看Js是怎么实现AOP，">
<meta property="og:image" content="http://yoursite.com/img/java_web/java_web2.png">
<meta property="og:updated_time" content="2017-03-22T14:19:03.359Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="打造轻量web框架02">
<meta name="twitter:description" content="前面我们完成了一个简单MVC框架了，已经能完成响应，依赖注入，返回渲染数据了，此外，还有一些非常好的特性没有提供，就是AOP。我们可以使用这个特性来实现一些横向拦截操作。比如性能分析，日志收集，安全控制。把这些功能抽离出来之后，再通过“动态织入”的方式掺入业务逻辑模块中。这样做的好处首先是可以保持业务逻辑模块的纯净和高内聚性，其次是可以很方便地复用日志统计等功能模块。
先看看Js是怎么实现AOP，">
<meta name="twitter:image" content="http://yoursite.com/img/java_web/java_web2.png">
  
    <link rel="alternative" href="/atom.xml" title="ChenXing" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
</head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">ChenXing</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="yoursite.com">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main"><article id="post-打造轻量web框架02" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/15/打造轻量web框架02/" class="article-date">
  <time datetime="2016-10-15T15:50:50.000Z" itemprop="datePublished">2016-10-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      打造轻量web框架02
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>前面我们完成了一个简单MVC框架了，已经能完成响应，依赖注入，返回渲染数据了，此外，还有一些非常好的特性没有提供，就是AOP。我们可以使用这个特性来实现一些横向拦截操作。比如性能分析，日志收集，安全控制。把这些功能抽离出来之后，再通过“动态织入”的方式掺入业务逻辑模块中。这样做的好处首先是可以保持业务逻辑模块的纯净和高内聚性，其次是可以很方便地复用日志统计等功能模块。</p>
<p>先看看Js是怎么实现AOP，然后我们再看看java是怎么苦逼实现的。最后我们来把这个特性揉进mvc里。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Function</span>.prototype.before = <span class="function"><span class="keyword">function</span> (<span class="params">beforefn</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> __self = <span class="keyword">this</span>; <span class="comment">// 保存原函数的引用</span></div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="comment">// 返回包含了原函数和新函数的"代理"函数</span></div><div class="line">        beforefn.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>); <span class="comment">// 执行新函数，修正 this</span></div><div class="line">        <span class="keyword">return</span> __self.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>); <span class="comment">// 执行原函数</span></div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"><span class="built_in">Function</span>.prototype.after = <span class="function"><span class="keyword">function</span> (<span class="params">afterfn</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> __self = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> ret = __self.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</div><div class="line">        afterfn.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> func = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="number">2</span>);</div><div class="line">&#125;;</div><div class="line">func = func.before(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>);</div><div class="line">&#125;).after(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>);</div><div class="line">&#125;);</div><div class="line">func();</div></pre></td></tr></table></figure>
<p>对，你没看错就是这么简单。</p>
<p>然后我们来看看java是怎么实现的.</p>
<h2 id="JDK动态代理和CGlib"><a href="#JDK动态代理和CGlib" class="headerlink" title="JDK动态代理和CGlib"></a>JDK动态代理和CGlib</h2><p>有动态代理就有静态代理.</p>
<p>先写一个Hello World</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Hello</span></span>&#123;</div><div class="line">  <span class="function"><span class="keyword">void</span> <span class="title">say</span><span class="params">(String name)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面是一个Hello接口，以下是实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloImpl</span> <span class="keyword">implements</span> <span class="title">Hello</span></span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(String name)</span></span>&#123;</div><div class="line">    System.out.println(<span class="string">"Hello! "</span> + name );</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们要在say方法前面和后面分别需要处理一些逻辑，该怎么作？</p>
<p>要用代理模式，写一个HellpProxy类，让它调用HelloImpl的say方法，在调用前后分别进行逻辑处理即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloProxy</span> <span class="title">implemens</span> <span class="title">Hello</span></span>&#123;</div><div class="line">  <span class="keyword">private</span> Hello hello;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">HelloProxy</span><span class="params">()</span></span>&#123;</div><div class="line">    hello = <span class="keyword">new</span> HelloImpl();</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(String name)</span></span>&#123;</div><div class="line">    before();</div><div class="line">    hello.say(name);</div><div class="line">    after();</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</div><div class="line">    System.out.pritln(<span class="string">"before"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</div><div class="line">    System.out.pritln(<span class="string">"after"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后你就知道怎么用了。简单的代理模式使用。</p>
<p>你会发现一个问题，这个代理类显然不是通用的，而且如果接口变了，所有代理类都得变。这是不合理的。所以JDK提供了一个动态代理给我们。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DyncmicProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Object target;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DyncmicProxy</span><span class="params">(Object target)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.target = target;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">		before();</div><div class="line">		Object result = method.invoke(target, args);</div><div class="line">		after();</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</div><div class="line">		System.out.println(<span class="string">"before"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</div><div class="line">		System.out.println(<span class="string">"after"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 DynamicProxy 类中，定义了一个Object类型的 target 变量，它是被代理的对象，通过构造函数来初始化。</p>
<p>DynamicProxy 实现了 InvocationHandler 接口，那么必须实现该接口的 invoke 方法。在该方法中，直接通过反射来去 invoke method，在调用前后分别处理 before 和 after,最后将result返回.</p>
<p>怎么使用？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		Hello hello = <span class="keyword">new</span> HelloImpl();	</div><div class="line">		DyncmicProxy dyncmicProxy = <span class="keyword">new</span> DyncmicProxy(hello);	</div><div class="line">		Hello helloProxy = (Hello)Proxy.newProxyInstance(</div><div class="line">				hello.getClass().getClassLoader(), </div><div class="line">				hello.getClass().getInterfaces(), </div><div class="line">				dyncmicProxy</div><div class="line">		);</div><div class="line">		helloProxy.say(<span class="string">"zjl"</span>);	</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重构一下，让这个 DyncmicProxy 类变成通用，避免到处使用 Proxy.newProxyInstance ,而且强制类型转换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DyncmicProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Object target;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">DyncmicProxy</span><span class="params">(Object target)</span></span>&#123;</div><div class="line">		<span class="keyword">this</span>.target = target;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">		before();</div><div class="line">		Object result = method.invoke(target, args);</div><div class="line">		after();</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">return</span> (T) Proxy.newProxyInstance(</div><div class="line">				<span class="keyword">this</span>.target.getClass().getClassLoader(),</div><div class="line">				<span class="keyword">this</span>.target.getClass().getInterfaces(), </div><div class="line">				<span class="keyword">this</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</div><div class="line">		System.out.println(<span class="string">"before"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</div><div class="line">		System.out.println(<span class="string">"after"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的动态代理不是万能的，比如说要代理一个没有任何接口的类，它就没有一点卵用了。然后我们看看CGlib这个类库，它是一个在运行期间动态生成字节码的工具，也就是动态生成代理类(改天学学)。先看看怎么用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CGLibProxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span></span>&#123;</div><div class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Class&lt;T&gt; cls)</span></span>&#123;</div><div class="line">    <span class="keyword">return</span> (T) Enhancer.create(cls,<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj,Method method,Object[] args,MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">    before();</div><div class="line">    Object result = proxy.invokeSuper(obj,args);</div><div class="line">    after();</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>需要实现CGlib给我们提供的MethodInterceptor实现类，并填充 intercept 方法。方法中最后一个 MethodProxy 类型的参数 proxy 值得注意. 这是它提供给我们的方法级别代理。我们直接调用 proxy 的 invokeSuper 方法即可。</p>
<p>看看怎么使用.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</div><div class="line">  CGLibProxy cgLibProxy = <span class="keyword">new</span> CGLibProxy();</div><div class="line">  Hello helloProxy = cgLibProxy.getProxy(HelloImpl.class);</div><div class="line">  helloProxy.say(<span class="string">"zjl"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="开工前的思考"><a href="#开工前的思考" class="headerlink" title="开工前的思考"></a>开工前的思考</h2><p>学了一项技术，就要应用起来。</p>
<p>停下来思考几分钟，怎么利用这个CGlib对我们mvc框架里面Controller的action进行拦截？</p>
<p>我们记得最后，我们分发器里面返回了注入过的Controller对象，然后调用相应的方法。如果说我们把这个Controller对象换成上面的代理对象，不就ok了？</p>
<p>此时，我们的内心应该是一阵窃喜。然而思考一会儿，这个躁动的心就会平复下来。</p>
<p>得到代理对象很好办，但这里面的before,after方法不应该是写死的，是可以配置的，怎么弄？</p>
<p>对于每个action，不应该只有一组before,after，还有别的拦截器进行某方面处理，怎么解决？</p>
<p>先看看第一大个问题，不是写死的，应该是可以配置的，怎么弄？</p>
<ol>
<li>既然不是写死可配置的，那么肯定是针对这个类的，也就是说before，after应该先存放在某个地方，且这个控制类得知道这两个方法是我的，等到代理的时候取出来调用即可。<ol>
<li>before，after存放在哪里？<ol>
<li>肯定是类的方法啊，用某种类表示某种切面。</li>
</ol>
</li>
<li>怎么让控制类知道这两个方法是我的？<ol>
<li>既然before，after是类的，那么我只要在类上做个标记，告诉这是某控制类的。<ol>
<li>显然用注解做标识是十分合适的。</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<p>第二个大问题，不应该只有一组before,after，还有别的拦截器进行某方面处理，怎么解决？</p>
<ol>
<li>特别简单啊，我们可以把所有的拦截操作存起来，然后依次取出来即可。类似这样</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj,Method method,Object[] args,MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">		XXXbefore();</div><div class="line"> 		YYYbefore();</div><div class="line">		Object result = proxy.invokeSuper(obj,args);</div><div class="line">		XXXafter();</div><div class="line">  		YYYafter();</div><div class="line">		<span class="keyword">return</span> result;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>2.这里面还有个问题，分析方法应该具有控制类信息，也是就说得把控制类和方法当作参数传进来，以便分析。</p>
<p>方法已经有了.剩下的就是实施了。</p>
<p><img src="/img/java_web/java_web2.png" alt="java_web"></p>
<h3 id="定义切面注解"><a href="#定义切面注解" class="headerlink" title="定义切面注解"></a>定义切面注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Aspect &#123;</div><div class="line">    Class&lt;? extends Annotation&gt; value();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注解包含一个value属性，它是一个注解类，用来定义 Controller 这类的注解.</p>
<h3 id="搭建代理框架"><a href="#搭建代理框架" class="headerlink" title="搭建代理框架"></a>搭建代理框架</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Proxy</span> </span>&#123;</div><div class="line">    <span class="function">Object <span class="title">doProxy</span><span class="params">(ProxyChain proxyChain)</span> <span class="keyword">throws</span> Throwable</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Proxy接口包括了一个doProxy方法，传入一个 ProxyChain,用于执行链式操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyChain</span> </span>&#123;</div><div class="line">  	<span class="comment">//目标类</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; targetClass;</div><div class="line">  	<span class="comment">//目标对象</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object targetObject;</div><div class="line">  	<span class="comment">//目标方法</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Method targetMethod;</div><div class="line">  	<span class="comment">//方法代理</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MethodProxy methodProxy;</div><div class="line">  	<span class="comment">//方法参数</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] methodParams;</div><div class="line">	<span class="comment">//代理列表</span></div><div class="line">    <span class="keyword">private</span> List&lt;Proxy&gt; proxyList = <span class="keyword">new</span> ArrayList&lt;Proxy&gt;();</div><div class="line">  	<span class="comment">//索引</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> proxyIndex = <span class="number">0</span>;</div><div class="line">	<span class="comment">//构造方法，set，get省略。</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">doProxyChain</span><span class="params">()</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">        Object methodResult= <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (proxyIndex &lt; proxyList.size()) &#123;</div><div class="line">            methodResult = proxyList.get(proxyIndex++).doProxy(<span class="keyword">this</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            methodResult = methodProxy.invokeSuper(targetObject, methodParams);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> methodResult;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>代理管理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//创建所有代理对象</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyManager</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">createProxy</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; targetClass, <span class="keyword">final</span> List&lt;Proxy&gt; proxyList)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (T) Enhancer.create(targetClass, <span class="keyword">new</span> MethodInterceptor() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ProxyChain(targetClass, o, method, methodProxy, objects, proxyList).doProxyChain();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>谁来调用ProxyManager呢？当然是切面类了，因为在切面类中，需要在目标别调用的前后增加相应的逻辑。我们有必要写一个抽象类，提供一个模板方法，并在该抽象类的具体实现中扩展相应方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AspectProxy</span> <span class="keyword">implements</span> <span class="title">Proxy</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">doProxy</span><span class="params">(ProxyChain proxyChain)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"></div><div class="line">        Object result = <span class="keyword">null</span>;</div><div class="line">        Class&lt;?&gt; cls = proxyChain.getTargetClass();</div><div class="line">        Method method = proxyChain.getTargetMethod();</div><div class="line">        Object[] params = proxyChain.getMethodParams();</div><div class="line">        </div><div class="line">        begin();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (intercept(cls, method, params)) &#123;</div><div class="line">                before(cls, method, params);</div><div class="line">                result = proxyChain.doProxyChain();</div><div class="line">                after(cls, method, params);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> &#123;</div><div class="line">                result = proxyChain.doProxyChain();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            error(cls, method, params, e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">finally</span> &#123;</div><div class="line">            end();    </div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">begin</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] params)</span> <span class="keyword">throws</span> Throwable</span>&#123;&#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] params)</span> <span class="keyword">throws</span> Throwable</span>&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">intercept</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] params)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Class&lt;?&gt; cls, Method method, Object[] params, Exception e)</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这些抽象方法可在 AspectProxy 的子类中有选择的实现，就像下面这样的.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Aspect</span>(Controller.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ControllerAspect</span> <span class="keyword">extends</span> <span class="title">AspectProxy</span></span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ControllerAspect.class);</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> <span class="keyword">long</span> begin;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Class&lt;?&gt; cls,Method method,Object[] params)</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">		LOGGER.debug(<span class="string">"----begin---"</span>);</div><div class="line">		LOGGER.debug(String.format(<span class="string">"class:%s"</span>, cls.getName()));</div><div class="line">		LOGGER.debug(String.format(<span class="string">"method:%s"</span>, method.getName()));</div><div class="line">		begin = System.currentTimeMillis();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Class&lt;?&gt; cls,Method method,Object[] params)</span> <span class="keyword">throws</span> Throwable</span>&#123;</div><div class="line">		LOGGER.debug(String.format(<span class="string">"time:%dms"</span>, System.currentTimeMillis() - begin));</div><div class="line">		LOGGER.debug(<span class="string">"===end+===="</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="加载AOP框架"><a href="#加载AOP框架" class="headerlink" title="加载AOP框架"></a>加载AOP框架</h3><p>上面的逻辑基本就差不多了。剩下的就主要是把上一节的普通对象，变成代理对象即可。</p>
<p>由于我们需要扩展 AspectProxy抽象类的所有具体类,此外还需获取带有Aspect注解的所有类，因为需要在ClassHelper中添加两个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 类操作助手类</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">//加载所有包下的类放到set里面 可获取service controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassHelper</span> </span>&#123;</div><div class="line">	...</div><div class="line">   <span class="comment">//获取报名下所有superclss的 子类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetBySuper(Class&lt;?&gt; superClass) &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</div><div class="line">            <span class="keyword">if</span> (superClass.isAssignableFrom(superClass) &amp;&amp; !superClass.equals(cls)) &#123;</div><div class="line">                classSet.add(cls);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取带某注解的类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetByAnnotation(Class&lt;? extends Annotation&gt; annotationClass) &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</div><div class="line">            <span class="keyword">if</span> (cls.isAnnotationPresent(annotationClass)) &#123;</div><div class="line">                classSet.add(cls);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后的AopHelper类，看看它完成了什么工作，先获取切面class，以及对应的要增强所有的class，然后获取要增强class和对应增强的所有代理class。最后根据这个映射关系得到代理对象，替代原来对象即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AopHelper</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER  = LoggerFactory.getLogger(AopHelper.class);</div><div class="line">	</div><div class="line">	<span class="keyword">static</span>&#123;</div><div class="line">		<span class="keyword">try</span>&#123;</div><div class="line">			<span class="comment">//获取切面类和切面类上面注解集合 比如（controller)  切面和对应增强的class类，一个切面可以增强n个类</span></div><div class="line">			Map&lt;Class&lt;?&gt;,Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap = createProxyMap();</div><div class="line">			<span class="comment">//获取controller和该切面对象列表  比如(controllerraspect) 一个目标类可以被n个切面代理增强</span></div><div class="line">			Map&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt; targetMap = createTargetMap(proxyMap);</div><div class="line">			<span class="keyword">for</span> ( Map.Entry&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt; targetEntry : targetMap.entrySet())&#123;</div><div class="line">				Class&lt;?&gt; targetClass  = targetEntry.getKey();</div><div class="line">				List&lt;Proxy&gt; proxyList = targetEntry.getValue();</div><div class="line">													<span class="comment">// controller  切面对象</span></div><div class="line">				Object proxy = ProxyManager.createProxy(targetClass,proxyList);</div><div class="line">				BeanHelper.setBean(targetClass, proxy);</div><div class="line">			&#125;</div><div class="line">		&#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">			LOGGER.error(<span class="string">"aop failure"</span>,e);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; createProxyMap() <span class="keyword">throws</span> Exception &#123;</div><div class="line">        Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt;();</div><div class="line">        <span class="comment">//获取所有 AspectProxy的子类 比如controllerAspect</span></div><div class="line">        Set&lt;Class&lt;?&gt;&gt; proxyClassSet = ClassHelper.getClassSetBySuper(AspectProxy.class);</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; proxyClass : proxyClassSet) &#123;</div><div class="line">            <span class="keyword">if</span> (proxyClass.isAnnotationPresent(Aspect.class)) &#123;</div><div class="line">                Aspect aspect = proxyClass.getAnnotation(Aspect.class);</div><div class="line">                <span class="comment">//获取所有注解为aspect的value 也就是 注解Controller的类</span></div><div class="line">                Set&lt;Class&lt;?&gt;&gt; targetClassSet = createTargetClassSet(aspect);</div><div class="line">                			<span class="comment">// controlelraspect  List&lt;CustomerConstoller&gt;</span></div><div class="line">                proxyMap.put(proxyClass, targetClassSet);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> proxyMap;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt; createTargetMap(Map&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyMap) <span class="keyword">throws</span> Exception&#123;</div><div class="line">        Map&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt; targetMap = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, List&lt;Proxy&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Set&lt;Class&lt;?&gt;&gt;&gt; proxyEntry : proxyMap.entrySet()) &#123;</div><div class="line">            Class&lt;?&gt; proxyClass = proxyEntry.getKey();</div><div class="line">            Set&lt;Class&lt;?&gt;&gt; proxyClassSet = proxyEntry.getValue();</div><div class="line">            <span class="keyword">for</span> (Class&lt;?&gt; targetClass : proxyClassSet) &#123;</div><div class="line">                Proxy proxy = (Proxy) proxyClass.newInstance();</div><div class="line">                <span class="keyword">if</span> (targetMap.containsKey(targetClass)) &#123;</div><div class="line">                    targetMap.get(targetClass).add(proxy);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                    List&lt;Proxy&gt; proxyList = <span class="keyword">new</span> ArrayList&lt;Proxy&gt;();</div><div class="line">                    proxyList.add(proxy);</div><div class="line">                    targetMap.put(targetClass, proxyList);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> targetMap;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取带Aspect类放到set里面</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; createTargetClassSet(Aspect aspect) <span class="keyword">throws</span> Exception &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; targetClassSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="comment">//interface com.chenxing.online.annotation.Controller</span></div><div class="line">        Class&lt;? extends Annotation&gt; annotation = aspect.value();</div><div class="line">        <span class="keyword">if</span> (annotation != <span class="keyword">null</span> &amp;&amp; !annotation.equals(Aspect.class)) &#123;</div><div class="line">        	<span class="comment">//获取所有注解为controller的类</span></div><div class="line">            targetClassSet.addAll(ClassHelper.getClassSetByAnnotation(annotation));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> targetClassSet;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">new</span> AopHelper();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://yoursite.com/2016/10/15/打造轻量web框架02/" data-id="cj8lswfnt002g5svbtbm4hvuj" class="article-share-link" data-share="baidu" data-title="打造轻量web框架02">Share</a>
      

      
        <a href="http://yoursite.com/2016/10/15/打造轻量web框架02/#ds-thread" class="article-comment-link">Comments</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/11/10/JS 核心之 执行上下文(Execution Context)/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          JS 核心之执行上下文(Execution Context)
        
      </div>
    </a>
  
  
    <a href="/2016/10/15/打造轻量web框架01/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">打造轻量web框架</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <div id="ds-thread" class="ds-thread" data-thread-key="2016/10/15/打造轻量web框架02/" data-title="打造轻量web框架02" data-url="http://yoursite.com/2016/10/15/打造轻量web框架02/"></div>
  </section>
</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node/">Node</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/es6/">es6</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tools/">tools</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node/">Node</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/es6/">es6</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tools/">tools</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/JavaScript/" style="font-size: 17.5px;">JavaScript</a> <a href="/tags/Node/" style="font-size: 20px;">Node</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/es6/" style="font-size: 12.5px;">es6</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/tools/" style="font-size: 12.5px;">tools</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/09/15/koa-router小笔记/">koa-router小笔记</a>
          </li>
        
          <li>
            <a href="/2017/09/10/一些源码分析解析/">一些npm包源码分析</a>
          </li>
        
          <li>
            <a href="/2017/09/02/fiddler/">fiddler抓包工具</a>
          </li>
        
          <li>
            <a href="/2017/05/02/这些年我用过的软件/">那些年我用过的软件</a>
          </li>
        
          <li>
            <a href="/2017/04/02/利用pipe处理并发/">利用pipe处理并发的可行性</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Links</h3>
    <div class="widget">
      <ul>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 ChenXing<br>
      Powered by <a href="//hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="totop"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"reqianduan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>




<script src="/js/script.js"></script>

</div>
</body>
</html>
