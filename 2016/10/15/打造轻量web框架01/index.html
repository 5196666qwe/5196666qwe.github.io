<!DOCTYPE html>
<html lang="en">
<head>
  <!-- content-Type -->
<meta charset="utf-8">


<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="language" content="en">
<meta name="robots" content="all">


<meta content="yes" name="apple-mobile-web-app-capable">
<meta content="black" name="apple-mobile-web-app-status-bar-style">
<meta content="telephone=no" name="format-detection">
<meta content="email=no" name="format-detection">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






<meta name="google-site-verification" content="xxxxxxxxxx" />




<meta name="baidu-site-verification" content="xxxxxxxxxx" />







<meta name="keywords" content="Java," />


<meta name="description" content="理想的controlelr我们一直使用原始的servlet来充当mvc模式中的controller。这样做虽然可以实现基本的功能，但是servlet的数量会随着业务功能的扩展而不断增加，这不是我们所期望的。因此有必要减少Servlet的数量，将某类业务交给Controller处理，他负责调用Service的相关方法，并将返回值放入Request和Response。除此之外，Service不是通过n">
<meta property="og:type" content="article">
<meta property="og:title" content="打造轻量web框架">
<meta property="og:url" content="http://yoursite.com/2016/10/15/打造轻量web框架01/index.html">
<meta property="og:site_name" content="ChenXing">
<meta property="og:description" content="理想的controlelr我们一直使用原始的servlet来充当mvc模式中的controller。这样做虽然可以实现基本的功能，但是servlet的数量会随着业务功能的扩展而不断增加，这不是我们所期望的。因此有必要减少Servlet的数量，将某类业务交给Controller处理，他负责调用Service的相关方法，并将返回值放入Request和Response。除此之外，Service不是通过n">
<meta property="og:image" content="http://yoursite.com/img/java_web/java_web.png">
<meta property="og:updated_time" content="2017-03-16T03:51:54.242Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="打造轻量web框架">
<meta name="twitter:description" content="理想的controlelr我们一直使用原始的servlet来充当mvc模式中的controller。这样做虽然可以实现基本的功能，但是servlet的数量会随着业务功能的扩展而不断增加，这不是我们所期望的。因此有必要减少Servlet的数量，将某类业务交给Controller处理，他负责调用Service的相关方法，并将返回值放入Request和Response。除此之外，Service不是通过n">
<meta name="twitter:image" content="http://yoursite.com/img/java_web/java_web.png">






  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />






<link href="http://cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


<script>
(function(){
  var bp = document.createElement('script');
  bp.src = '//push.zhanzhang.baidu.com/push.js';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();
</script>

  <title> 打造轻量web框架 </title>
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'xxxxxxxxxx', 'auto');
  ga('send', 'pageview');
</script>



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?1551fdd18711ccb1c048bb11f579b1a4";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



</head>
<body lang="zh-Hans">

  <!--[if lte IE 9]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->


  <div class="another-theme layout">

    
<header class="header" id="header">

  <div class="header-cont">
    <div class="text-area">
      
        <h1 class="title" data-text="打造轻量web框架"> 打造轻量web框架 </h1>

        
        <div class="post-meta">
          <div class="post-time">
            发表于
            <time  datetime="2016-10-15T20:50:50+08:00" content="2016-10-15">
              2016-10-15
            </time>
          </div>

          
            <div class="post-category" >
              
                <span>
                  <a href="/categories#Java" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                

              
            </div>
          

          
            
              <span class="post-comments-count">
                <a href="/2016/10/15/打造轻量web框架01/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/15/打造轻量web框架01/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          
        </div>
        
      
    </div>
    <!-- Navigation -->
    
    <nav class="navigation clearfix" id="navigation">
      
        
        <a class="nav-link" href="/" rel="section">
          首页
        </a>
      
        
        <a class="nav-link" href="/tags" rel="section">
          标签
        </a>
      
        
        <a class="nav-link" href="/categories" rel="section">
          分类
        </a>
      
        
        <a class="nav-link" href="/about" rel="section">
          关于
        </a>
      
    </nav>
    
  </div>
  <div class="mask"></div>
</header>


    <main class="container">

      

  <article class="post-article post-type-normal post" itemscope>

  <div class="post-body">

    <div class="content markdown-body"><h2 id="理想的controlelr"><a href="#理想的controlelr" class="headerlink" title="理想的controlelr"></a>理想的controlelr</h2><p>我们一直使用原始的<code>servlet</code>来充当mvc模式中的<code>controller</code>。这样做虽然可以实现基本的功能，但是servlet的数量会随着业务功能的扩展而不断增加，这不是我们所期望的。因此有必要减少<code>Servlet</code>的数量，将某类业务交给<code>Controller</code>处理，他负责调用<code>Service</code>的相关方法，并将返回值放入<code>Request</code>和<code>Response</code>。除此之外，<code>Service</code>不是通过<code>new</code>的方法来创建的，而是通过一种<code>依赖注入</code>的方式，让框架为我们来创建所需要的对象。</p>
<p>我们在<code>Controller</code>中使用应该是长这样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//假设说我们是一个客户管理</span></div><div class="line"></div><div class="line"><span class="comment">//处理客户管理相关请求</span></div><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerController</span></span>&#123;</div><div class="line">  </div><div class="line">  <span class="meta">@Inject</span></div><div class="line">  <span class="keyword">private</span> CustomerService customerService;</div><div class="line">  </div><div class="line">  <span class="meta">@Action</span>(<span class="string">"get:/xxxxx"</span>)</div><div class="line">  <span class="function"><span class="keyword">public</span> View <span class="title">index</span><span class="params">(Param param)</span></span>&#123;</div><div class="line">    List&lt;Customer&gt; customerList = customerService.getCustomerList();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> View(<span class="string">"customer.jsp"</span>).addModel(<span class="string">"customerList"</span>,customerList);</div><div class="line">  &#125;</div><div class="line">  ....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过<code>Controller</code>注解来定义<code>Controller</code>类，类中通过<code>inject</code>注解定义一系列<code>Service</code>成员变量，这就是<code>依赖注入</code>，此外，有一系列<code>Action</code>注解所定义的方法，在方法中，调用了<code>Service</code>成员变量的方法完成具体业务逻辑。若是返回<code>View</code>对象，则表示<code>jsp</code>页面，若是返回了<code>Data</code>对象，则表示<code>JSON</code>数据。</p>
<p>让我们看看完成这个<code>controlle</code>r需要干几件事。</p>
<ol>
<li><p>最基本的定义注解类，<code>Controller</code>作为标识，<code>inject</code>用来依赖注入，<code>Action</code>表示请求方法和路径。</p>
</li>
<li><p>首先<code>servlet</code>应该统一处理，获取请求方法和路径，那么问题来了，请求到这个方法应该怎么执行？</p>
<ol>
<li>我们自然而然就能想到利用反射，获取相应参数，调用该方法。问题来了，我们是要请求的时候，实例化相应类，完成IOC,在调用方法？</li>
<li>显然这么做不合理，那么多请求，都反射，实例化类，很浪费资源的。我们换条道，提前把实例化过的类保存起来。等到请求的时候取出来，这么做合理很多。</li>
</ol>
</li>
<li><p>跟据上面的推测，我们首先要得到这些标识为<code>Controlle</code>r的类。怎么做？还是反射。获取注解。问题是<code>Class</code>对象哪来的？三种方法，class.forName();Object.class;object.getClass()</p>
<ol>
<li>不假思索，我们就能排除后面两种方法。那么如何获取包名+类名？遍历一下应用包目录，获取即可。然后就有了<code>class</code>对象。</li>
<li>有了<code>class</code>对象，根据注解获取Controller的<code>Class</code>对象，就有了相应的实例化对象。然后依赖注入相应类。即可。</li>
<li>最后的最后，<code>servlet</code>得到请求方法，方法路径获取对应参数，得到实例化对象，调用方法，根据方法的返回值，返回响应页面。o了。</li>
</ol>
</li>
<li>我们的思想已经到位了，剩下的就是实施了。</li>
</ol>
<p><img src="/img/java_web/java_web.png" alt="原型"></p>
<p>这大概是一张流程图，下面代码分别看不懂，先看看这个。</p>
<h2 id="定义框架配置项以及加载"><a href="#定义框架配置项以及加载" class="headerlink" title="定义框架配置项以及加载"></a>定义框架配置项以及加载</h2><p>假设我们搭建是一个<code>web</code>的<code>maven</code>项目，那么在<code>src/main/resources</code>目录下，创建一个名为<code>smart.properties</code>的配置文件，内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">smart.framework.jdbc.driver = com.mysql.jdbc.Driver</div><div class="line"></div><div class="line">smart.framework.jdbc.url= jdbc:mysql:<span class="comment">//localhost:3306/demo</span></div><div class="line">smart.framework.jdbc.username= root</div><div class="line">smart.framework.jdbc.password= <span class="number">123456</span></div><div class="line"></div><div class="line">smart.framework.app.base_package = com.xxxx.yyy   <span class="comment">//该项目的基础包名</span></div><div class="line">smart.framework.app.jsp_path= /WEB-INF/view/    <span class="comment">//jsp的路径</span></div><div class="line">smart.framework.app.asset_path= /asset/       <span class="comment">//静态文件资源路径，js或css。。。</span></div></pre></td></tr></table></figure>
<p>配置文件有了，就可以根据配置项的名称来获取配置项的值.我们创建一个<code>ConfigConstant</code>的常量类，维护配置文件中的相关配置名称</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigConstant</span> </span>&#123;</div><div class="line"></div><div class="line">    String CONFIG_FILE = <span class="string">"smart.properties"</span>;</div><div class="line"></div><div class="line">    String JDBC_DRIVER = <span class="string">"smart.framework.jdbc.driver"</span>;</div><div class="line">    String JDBC_URL = <span class="string">"smart.framework.jdbc.url"</span>;</div><div class="line">    String JDBC_USERNAME = <span class="string">"smart.framework.jdbc.username"</span>;</div><div class="line">    String JDBC_PASSWORD = <span class="string">"smart.framework.jdbc.password"</span>;</div><div class="line"></div><div class="line"></div><div class="line">    String APP_BASE_PACKAGE = <span class="string">"smart.framework.app.base_package"</span>;</div><div class="line">    String APP_JSP_PATH = <span class="string">"smart.framework.app.jsp_path"</span>;</div><div class="line">    String APP_ASSET_PATH = <span class="string">"smart.framework.app.asset_path"</span>;</div><div class="line"></div><div class="line">    String APP_UPLOAD_LIMIT = <span class="string">"smart.framework.app.upload_limit"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后我们用一个<code>ConfigHelper</code>类，定义一些静态方法来分别获取配置文件中的配置项。当然了真正实现的是<code>PropsUtil</code>我们的助手类了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigHelper</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Properties CONFIG_PROPS = PropsUtil.loadProps(ConfigConstant.CONFIG_FILE);</div><div class="line"></div><div class="line">    <span class="comment">//获取jdbc是驱动</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getJdbcDriver</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PropsUtil.getString(CONFIG_PROPS, ConfigConstant.JDBC_DRIVER);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取jdbc url</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getJdbcUrl</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PropsUtil.getString(CONFIG_PROPS, ConfigConstant.JDBC_URL);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//获取数据库username</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getJdbcUserName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PropsUtil.getString(CONFIG_PROPS, ConfigConstant.JDBC_USERNAME);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//获取数据库password</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getJdbcPassword</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PropsUtil.getString(CONFIG_PROPS, ConfigConstant.JDBC_PASSWORD);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//获取应用包名 也就是com.chenxing.online</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAppBasePackage</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PropsUtil.getString(CONFIG_PROPS, ConfigConstant.APP_BASE_PACKAGE);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">  	<span class="comment">//这里配置项目提供了默认值</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAppJspPath</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PropsUtil.getString(CONFIG_PROPS, ConfigConstant.APP_JSP_PATH, <span class="string">"/WEB-INF/view/"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAppAssetPath</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> PropsUtil.getString(CONFIG_PROPS, ConfigConstant.APP_ASSET_PATH, <span class="string">"/asset/"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>PropsUtil</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PropsUtil</span> </span>&#123;</div><div class="line">  	<span class="comment">//这里使用了logger日志系统来打印日志，可以不管</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(PropsUtil.class);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Properties <span class="title">loadProps</span><span class="params">(String fileName)</span> </span>&#123;</div><div class="line">        Properties props = <span class="keyword">null</span>;</div><div class="line">        InputStream is = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            is = Thread.currentThread().getContextClassLoader().getResourceAsStream(fileName);</div><div class="line">            <span class="keyword">if</span> (is == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(fileName + <span class="string">" file is not found"</span>);</div><div class="line">            &#125;</div><div class="line">            props = <span class="keyword">new</span> Properties();</div><div class="line">            props.load(is);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            LOGGER.error(<span class="string">"load properties file failure"</span>, e);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    is.close();</div><div class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                    LOGGER.error(<span class="string">"close input stream failure"</span>, e);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> props;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getString</span><span class="params">(Properties props, String key)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> getString(props, key, <span class="string">""</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getString</span><span class="params">(Properties props, String key, String defaultValue)</span> </span>&#123;</div><div class="line">        String value = defaultValue;</div><div class="line">        <span class="keyword">if</span> (props.containsKey(key)) &#123;</div><div class="line">            value = props.getProperty(key);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//getInt , getLong等等。。。</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="开发一个类加载器"><a href="#开发一个类加载器" class="headerlink" title="开发一个类加载器"></a>开发一个类加载器</h2><p>我们需要一个<code>类加载器</code>来加载基础包名下所有类，比如使用了某注解的类，实现了某接口的类。</p>
<p>有必要写一个<code>ClassUtil</code>工具类，提供与类操作相关的方法，比如获取类加载器，加载类，获取指定包名下的所有类。代码如下。具体实现有点复杂。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassUtil</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ClassUtil.class);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">//获取类加载器</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> Thread.currentThread().getContextClassLoader();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//加载类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className) &#123;</div><div class="line">        <span class="keyword">return</span> loadClass(className, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//加载类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, <span class="keyword">boolean</span> isInitialized) &#123;</div><div class="line">        Class&lt;?&gt; cls = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            cls = Class.forName(className, isInitialized, getClassLoader());</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">            LOGGER.error(<span class="string">"load class failure"</span>, e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> cls;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//获取指定包名下的所有类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSet(String packageName) &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Enumeration&lt;URL&gt; urls = getClassLoader().getResources(packageName.replace(<span class="string">"."</span>, <span class="string">"/"</span>));</div><div class="line">            <span class="comment">//com.xxxx.yyyy</span></div><div class="line">            System.out.println(packageName);</div><div class="line">            <span class="comment">//com/xxxx/yyyy</span></div><div class="line">            System.out.println(packageName.replace(<span class="string">"."</span>, <span class="string">"/"</span>));</div><div class="line">            <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</div><div class="line">                URL url = urls.nextElement();</div><div class="line">                <span class="keyword">if</span> (url != <span class="keyword">null</span>) &#123;</div><div class="line">                    String protocol = url.getProtocol();</div><div class="line">                    <span class="keyword">if</span> (protocol.equals(<span class="string">"file"</span>)) &#123;</div><div class="line">                        String packagePath = url.getPath().replaceAll(<span class="string">"%20"</span>, <span class="string">" "</span>);</div><div class="line">                        addClass(classSet, packagePath, packageName);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (protocol.equals(<span class="string">"jar"</span>)) &#123;</div><div class="line">                        JarURLConnection jarURLConnection = (JarURLConnection)url.openConnection();</div><div class="line">                        <span class="keyword">if</span> (jarURLConnection != <span class="keyword">null</span>) &#123;</div><div class="line">                            JarFile jarFile = jarURLConnection.getJarFile();</div><div class="line">                            <span class="keyword">if</span> (jarFile != <span class="keyword">null</span>) &#123;</div><div class="line">                                Enumeration&lt;JarEntry&gt; jarEntries = jarFile.entries();</div><div class="line">                                <span class="keyword">while</span> (jarEntries.hasMoreElements()) &#123;</div><div class="line">                                    JarEntry jarEntry = jarEntries.nextElement();</div><div class="line">                                    String jarEntryName = jarEntry.getName();</div><div class="line">                                    <span class="keyword">if</span> (jarEntryName.endsWith(<span class="string">".class"</span>)) &#123;</div><div class="line">                                        String className = jarEntryName.substring(<span class="number">0</span>, jarEntryName.lastIndexOf(<span class="string">"."</span>)).replaceAll(<span class="string">"/"</span>, <span class="string">"."</span>);</div><div class="line">                                        doAddClass(classSet, className);</div><div class="line">                                    &#125;</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            LOGGER.error(<span class="string">"get class set failure"</span>, e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//递归来方法添加class文件</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addClass</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; classSet, String packagePath, String packageName)</span> </span>&#123;</div><div class="line">    	File[] files  = <span class="keyword">new</span> File(packagePath).listFiles(<span class="keyword">new</span> FileFilter() &#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File file )</span> </span>&#123;</div><div class="line">				<span class="keyword">return</span> (file.isFile() &amp;&amp; file.getName().endsWith(<span class="string">".class"</span>)) || file.isDirectory();</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">    	</div><div class="line">    	<span class="keyword">for</span> (File file : files)&#123;</div><div class="line">    		String fileName = file.getName();</div><div class="line">    		<span class="keyword">if</span> ( file.isFile() )&#123;</div><div class="line">    			String className = fileName.substring(<span class="number">0</span>,fileName.lastIndexOf(<span class="string">"."</span>));</div><div class="line">    			</div><div class="line">    			<span class="keyword">if</span> (StringUtil.isNotEmpty(packageName))&#123;</div><div class="line">    				className = packageName + <span class="string">"."</span> + className;</div><div class="line">    			&#125;</div><div class="line">    			doAddClass(classSet, className);</div><div class="line">    		&#125; <span class="keyword">else</span> &#123;</div><div class="line">    			String subPackagePath = fileName;</div><div class="line">    			<span class="keyword">if</span> (StringUtil.isNotEmpty(packagePath))&#123;</div><div class="line">    				subPackagePath = packagePath + <span class="string">"/"</span> + subPackagePath;</div><div class="line">    			&#125;</div><div class="line">    			String subPackageName = fileName;</div><div class="line">    			<span class="keyword">if</span> (StringUtil.isNotEmpty(packageName))&#123;</div><div class="line">    				subPackageName = packageName + <span class="string">"."</span> + subPackageName;</div><div class="line">    			&#125;</div><div class="line">    			addClass(classSet, subPackagePath, subPackageName);</div><div class="line">    		&#125;</div><div class="line">    	&#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">//真正实现加载class的方法</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doAddClass</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; classSet, String className)</span> </span>&#123;</div><div class="line">        Class&lt;?&gt; cls = loadClass(className, <span class="keyword">false</span>);</div><div class="line">        classSet.add(cls);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于我们在<code>smart.properties</code>配置文件中指定了<code>smart.framework.app.base_package</code>， 它是整个应用的基础包名。通过<code>ClassUtil</code>加载的类都需要基于该基础包名。所以有必要提供<code>ClassHelper</code>助手类，让它分别获取应用包下的所有类，应用包名下所有的<code>Service</code>类，应用包名下所有的<code>Controller</code>类。此外我们可以将带有<code>Controller</code>注解和<code>Service</code>注解的类所产生的对象理解成<code>Bean</code>，所有有必要在该类中增加一个获取应用包名下所有<code>Bean</code>的方法。<code>ClassHelper</code>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 类操作助手类</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="comment">//加载所有包下的类放到set里面 可获取service controller</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassHelper</span> </span>&#123;</div><div class="line">	<span class="comment">//定义类集合 用于存放所加载的类</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;Class&lt;?&gt;&gt; CLASS_SET;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        String basePackage = ConfigHelper.getAppBasePackage();</div><div class="line">        CLASS_SET = ClassUtil.getClassSet(basePackage);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSet() &#123;</div><div class="line">        <span class="keyword">return</span> CLASS_SET;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取应用包名下所有service类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getServiceClassSet() &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</div><div class="line">            <span class="keyword">if</span> (cls.isAnnotationPresent(Service.class)) &#123;</div><div class="line">                classSet.add(cls);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//获取应用包名下所有controller类</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getControllerClassSet() &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</div><div class="line">            <span class="keyword">if</span> (cls.isAnnotationPresent(Controller.class)) &#123;</div><div class="line">                classSet.add(cls);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//获取应用包名下所有bean类 包括 service controller</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getBeanClassSet() &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        classSet.addAll(getControllerClassSet());</div><div class="line">        classSet.addAll(getServiceClassSet());</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetBySuper(Class&lt;?&gt; superClass) &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</div><div class="line">            <span class="keyword">if</span> (superClass.isAssignableFrom(superClass) &amp;&amp; !superClass.equals(cls)) &#123;</div><div class="line">                classSet.add(cls);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Class&lt;?&gt;&gt; getClassSetByAnnotation(Class&lt;? extends Annotation&gt; annotationClass) &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; classSet = <span class="keyword">new</span> HashSet&lt;Class&lt;?&gt;&gt;();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; cls : CLASS_SET) &#123;</div><div class="line">            <span class="keyword">if</span> (cls.isAnnotationPresent(annotationClass)) &#123;</div><div class="line">                classSet.add(cls);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> classSet;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样我们使用<code>ClassHelper</code>封装了<code>ClassUtil</code>，并提供了一系列方法。通过合叶方法可以直接获取我们想要的类集合。我们接下来会继承使用到这个类。</p>
<h2 id="定义注解类"><a href="#定义注解类" class="headerlink" title="定义注解类"></a>定义注解类</h2><p>我们目标是在控制器类上使用<code>Controller</code>注解，来控制类的方法上使用<code>Action</code>注解，在服务类上使用<code>service</code>注解，在控制类中可使用<code>inject</code>注解来将服务类依赖注入.</p>
<p>控制器注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Controller &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Action注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.METHOD)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Action &#123;</div><div class="line">	<span class="comment">//请求类型和路径</span></div><div class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>service注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.TYPE)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Service &#123;	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Inject注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.FIELD)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Inject &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="实现Bean容器"><a href="#实现Bean容器" class="headerlink" title="实现Bean容器"></a>实现Bean容器</h2><p>上面我们实现了<code>ClassHelper</code>类，它可以获取所加载的类，但无法通过类实例化对象。因此需要一个反射类，让它封装<code>java</code>反射相关的api，对外提供更好的工具方法。类名可叫做<code>ReflectionUtil</code>，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 反射工具类</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectionUtil</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ReflectionUtil.class);</div><div class="line">	<span class="comment">//创建实例</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newInstance</span><span class="params">(Class&lt;?&gt; cls)</span> </span>&#123;</div><div class="line">        Object instance = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            instance = cls.newInstance();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            LOGGER.error(<span class="string">"new instance failure"</span>, e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//调用方法</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">invokeMethod</span><span class="params">(Object obj, Method method, Object... args)</span> </span>&#123;</div><div class="line">        Object result = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            method.setAccessible(<span class="keyword">true</span>);</div><div class="line">            result = method.invoke(obj, args);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            LOGGER.error(<span class="string">"invoke method failure"</span>, e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//设置成员变量的值</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setField</span><span class="params">(Object obj, Field field, Object value)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            field.setAccessible(<span class="keyword">true</span>);</div><div class="line">            field.set(obj, value);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            LOGGER.error(<span class="string">"set field failure"</span>, e);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着我们需要获取所有被框架管理的<code>Bean</code>类(也就是带Controller注解和Service注解的类。上面ClassHelper已经帮我们获取了)。随后需要循环调用<code>ReflectionUtil</code>类的<code>newInstance</code>方法，来实例化对象，最后将每次创建的对象存放在一个静态的<code>Map&lt;Class&lt;?&gt;,Object&gt;</code>中。我们需要随时获取该<code>Map</code>，还需要通过该<code>Map</code>的<code>Key</code>来获取所对应的    <code>bean</code>对象。</p>
<p>BeanHelper类代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//获取所有带service和controller的类，保存到 map里面 key是 类 value是实体</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanHelper</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt; BEAN_MAP = <span class="keyword">new</span> HashMap&lt;Class&lt;?&gt;, Object&gt;();</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">    	System.out.println(<span class="string">"我是beanhelper"</span>);</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; beanClassSet = ClassHelper.getBeanClassSet();</div><div class="line">        <span class="keyword">for</span> (Class&lt;?&gt; beanClass : beanClassSet) &#123;</div><div class="line">            Object obj = ReflectionUtil.newInstance(beanClass);</div><div class="line">            BEAN_MAP.put(beanClass, obj);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//获取bean映射</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;Class&lt;?&gt;, Object&gt; getBeanMap() &#123;</div><div class="line">        <span class="keyword">return</span> BEAN_MAP;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//获取bean实例</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; cls)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!BEAN_MAP.containsKey(cls)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"can not get by class: "</span> + cls);</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> (T) BEAN_MAP.get(cls);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="实现依赖注入功能"><a href="#实现依赖注入功能" class="headerlink" title="实现依赖注入功能"></a>实现依赖注入功能</h2><p>还记得之前定义的<code>Inject</code>注解吗？我们就要用它来实现<code>Service</code>实例化。</p>
<p>我们自己不用通过<code>new</code>的方法来实例化，而是通过框架自己来实例化，像这样的实例化过程称为<code>Ioc</code>控制反转，也叫依赖注入。可以理解成一个类需要依赖的成员注入到这个类中。怎么实现？</p>
<p>最简单的方法，通过上面写的<code>BeanHelper</code>获取所有的<code>Bean Map</code>，然后遍历，取出来<code>Bean 类</code>和<code>Bean 实例</code></p>
<p>进而通过反射获取类中所有的成员变量，继续遍历这些所有成员变量，在循环中判断该成员是否带有<code>Inject</code>注解</p>
<p>然后取出该实例，通过反射实例化。</p>
<p>我们把上面这个逻辑写成一个名称<code>IocHelper</code>的类，代码如下；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 依赖注入助手类</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IocHelper</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">    	System.out.println(<span class="string">"我是ｉｏｃ"</span>);</div><div class="line">        Map&lt;Class&lt;?&gt;, Object&gt; beanMap = BeanHelper.getBeanMap();</div><div class="line">        <span class="keyword">if</span> (CollectionUtil.isNotEmpty(beanMap)) &#123;</div><div class="line">            <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; beanEntry : beanMap.entrySet()) &#123;</div><div class="line">                Class&lt;?&gt; beanClass = beanEntry.getKey();</div><div class="line">                Object beanInstance = beanEntry.getValue();</div><div class="line">                Field[] beanFields = beanClass.getDeclaredFields();</div><div class="line">                <span class="keyword">if</span> (ArrayUtil.isNotEmpty(beanFields)) &#123;</div><div class="line">                    <span class="keyword">for</span> (Field beanField : beanFields) &#123;</div><div class="line">                        <span class="keyword">if</span> (beanField.isAnnotationPresent(Inject.class)) &#123;</div><div class="line">                            Class&lt;?&gt; beanFieldClass = beanField.getClass();</div><div class="line">                            Object beanFieldInstance = ReflectionUtil.newInstance(beanField.getType());</div><div class="line">                            <span class="keyword">if</span> (beanFieldInstance != <span class="keyword">null</span>) &#123;</div><div class="line">                                ReflectionUtil.setField(beanInstance, beanField, beanFieldInstance);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>需要注意的是，此时<code>Ioc</code>框架中所管理的对象都是单例的，由于<code>Ioc</code>框架底层是从<code>BeanHelper</code>来获取map的，二map中的对象都是事先创建好并放入这个<code>bean</code>容器的，所有对象都是单例的。</p>
<h2 id="加载Controller"><a href="#加载Controller" class="headerlink" title="加载Controller"></a>加载Controller</h2><p>我们需要创建一个<code>ControllerHelper</code>类，让它来处理如下逻辑：<br>通过<code>ClassHelper</code>，我们可以获取所有定义了<code>Controller</code>注解的类，可以通过反射获取该类<br>中所有带有<code>Action</code>注解的方法，获取Action注解中的请求表达式，进而获取请求方法与请求路径，封装一个请求对象（Request）与处理对象（Handler)，最后将<code>Request</code>与<code>Handler</code>建立一个映射关系，放入一个<code>ActionMap</code>中，并提供一个可根据请求方法与请求路径获取处理对象的方法。</p>
<p>首先定义一个名为Request的类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//封装请求</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String requestMethod;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String requestPath;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Request</span><span class="params">(String requsetMethod, String requestPath)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.requestMethod = requsetMethod;</div><div class="line">        <span class="keyword">this</span>.requestPath = requestPath;</div><div class="line">    &#125;</div><div class="line">  <span class="comment">//set,get,hascode,equals</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后编写一个叫做<code>Handler</code>的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//封装action信息</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Class&lt;?&gt; controllerClass;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Method actionMethod;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Class&lt;?&gt; controllerClass, Method actionMethod)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.controllerClass = controllerClass;</div><div class="line">        <span class="keyword">this</span>.actionMethod = actionMethod;</div><div class="line">    &#125;</div><div class="line">	<span class="comment">//set,get</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后是我们的 ControllerHelper </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//控制助手类</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ControllerHelper</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// 请求和处理器的映射关系 </span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Request, Handler&gt; ACTION_MAP = <span class="keyword">new</span> HashMap&lt;Request, Handler&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        Set&lt;Class&lt;?&gt;&gt; controllerClassSet = ClassHelper.getControllerClassSet();</div><div class="line">        <span class="keyword">if</span> (CollectionUtil.isNotEmpty(controllerClassSet)) &#123;</div><div class="line">            <span class="keyword">for</span> (Class&lt;?&gt; controllerClass : controllerClassSet) &#123;</div><div class="line">                Method[] methods = controllerClass.getDeclaredMethods();</div><div class="line">                <span class="keyword">if</span> (ArrayUtil.isNotEmpty(methods)) &#123;</div><div class="line">                    <span class="keyword">for</span> (Method method : methods) &#123;</div><div class="line">                        <span class="keyword">if</span> (method.isAnnotationPresent(Action.class)) &#123;</div><div class="line">                            Action action = method.getAnnotation(Action.class);</div><div class="line">                            String mapping = action.value();</div><div class="line">                            <span class="keyword">if</span> (mapping.matches(<span class="string">"\\w+:/\\w*"</span>)) &#123;</div><div class="line">                                String[] array = mapping.split(<span class="string">":"</span>);</div><div class="line">                                <span class="keyword">if</span> (ArrayUtil.isNotEmpty(array) &amp;&amp; array.length == <span class="number">2</span>) &#123;</div><div class="line">                                	<span class="comment">//比方说 get:/customer</span></div><div class="line">                                	</div><div class="line">                                	<span class="comment">// get</span></div><div class="line">                                    String requestMethod = array[<span class="number">0</span>];</div><div class="line">                                    <span class="comment">///customer</span></div><div class="line">                                    String requestPath = array[<span class="number">1</span>];</div><div class="line">                                    Request request = <span class="keyword">new</span> Request(requestMethod, requestPath);</div><div class="line">                                    Handler handler = <span class="keyword">new</span> Handler(controllerClass, method);</div><div class="line">                                    ACTION_MAP.put(request, handler);</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Handler <span class="title">getHandler</span><span class="params">(String requestMethod, String requestPath)</span> </span>&#123;</div><div class="line">        Request request = <span class="keyword">new</span> Request(requestMethod, requestPath);</div><div class="line">        <span class="keyword">return</span> ACTION_MAP.get(request);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="请求转发器"><a href="#请求转发器" class="headerlink" title="请求转发器"></a>请求转发器</h2><p>以上过程都是为了这一步准备，我们要编写一个<code>Servlet</code>，让它处理所有的请求。从<code>HttpServletRequest</code>对象中获取请求方法和请求路径，通过<code>ControllerHelper#getHandler</code>方法来获取<code>Handler</code>对象。</p>
<p>拿到<code>Handler</code>对象后，我们可以方便地获取<code>Controller</code>类，进而通过<code>BeanHelper@getBean</code>来获取<code>Controller</code>的实例对象。</p>
<p>最后可以从<code>HttpServletRequest</code>对象中获取所有的请求参数，将其作为我们最开始上面的处理方法的<code>Param</code>对象</p>
<p>此外我们从<code>Handler</code>对象中获取<code>Action</code>的方法返回值，该返回值可能有两种情况</p>
<ol>
<li>若返回值是 View 类型的视图对象，则返回一个 jsp 对象，这也就是为什么我们最开始定义配置选项定义了jsp的路径</li>
<li>若是返回 Data 类型的数据对象， 则返回一个 Json 数据</li>
</ol>
<p>这两个类和我们处理返回的逻辑略去，有兴趣可以看看后面代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@WebServlet</span>(urlPatterns = <span class="string">"/*"</span>, loadOnStartup = <span class="number">0</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DispatcherServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig servletConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">    	System.out.println(ClassHelper.a+BeanHelper.a+IocHelper.a+ControllerHelper.a);</div><div class="line">        ServletContext servletContext = servletConfig.getServletContext();</div><div class="line">        ServletRegistration jspServlet = servletContext.getServletRegistration(<span class="string">"jsp"</span>);</div><div class="line">        jspServlet.addMapping(ConfigHelper.getAppJspPath() + <span class="string">"*"</span>);</div><div class="line">        ServletRegistration defaultServlet = servletContext.getServletRegistration(<span class="string">"default"</span>);</div><div class="line">        defaultServlet.addMapping(ConfigHelper.getAppAssetPath() + <span class="string">"*"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</div><div class="line"><span class="comment">//        super.service(req, resp);</span></div><div class="line">        String requestMethod = req.getMethod().toLowerCase();</div><div class="line">        String requestPath = req.getPathInfo();</div><div class="line">        Handler handler = ControllerHelper.getHandler(requestMethod, requestPath);</div><div class="line">        <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</div><div class="line">            Class&lt;?&gt; controllerClass = handler.getControllerClass();</div><div class="line">            Object controllerBean = BeanHelper.getBean(controllerClass);</div><div class="line">            Map&lt;String, Object&gt; paramMap = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</div><div class="line">            Enumeration&lt;String&gt; paramNames = req.getParameterNames();</div><div class="line">            <span class="keyword">while</span> (paramNames.hasMoreElements()) &#123;</div><div class="line">                String paramName = paramNames.nextElement();</div><div class="line">                String paramValue = req.getParameter(paramName);</div><div class="line">                paramMap.put(paramName, paramValue);</div><div class="line">            &#125;</div><div class="line">            String body = CodecUtil.decodeURL(StreamUtil.getString(req.getInputStream()));</div><div class="line">            <span class="keyword">if</span> (StringUtil.isNotEmpty(body)) &#123;</div><div class="line">                String[] params = StringUtil.splitString(body, <span class="string">"&amp;"</span>);</div><div class="line">                <span class="keyword">if</span> (ArrayUtil.isNotEmpty(params)) &#123;</div><div class="line">                    <span class="keyword">for</span> (String param : params) &#123;</div><div class="line">                        String[] array = StringUtil.splitString(param, <span class="string">"="</span>);</div><div class="line">                        <span class="keyword">if</span> (ArrayUtil.isNotEmpty(array) &amp;&amp; array.length == <span class="number">2</span>) &#123;</div><div class="line">                            String paramName = array[<span class="number">0</span>];</div><div class="line">                            String paramValue = array[<span class="number">1</span>];</div><div class="line">                            paramMap.put(paramName, paramValue);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            Param param = <span class="keyword">new</span> Param(paramMap);</div><div class="line">            Method actionMethod = handler.getActionMethod();</div><div class="line">            Object result = ReflectionUtil.invokeMethod(controllerBean, actionMethod, param);</div><div class="line">            <span class="keyword">if</span> (result <span class="keyword">instanceof</span> View) &#123;</div><div class="line">                View view = (View) result;</div><div class="line">                String path = view.getPath();</div><div class="line">                <span class="keyword">if</span> (StringUtil.isNotEmpty(path)) &#123;</div><div class="line">                    <span class="keyword">if</span>(path.startsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">                        resp.sendRedirect(req.getContextPath()+path);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">else</span> &#123;</div><div class="line">                        Map&lt;String, Object&gt; model = view.getModel();</div><div class="line">                        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : model</div><div class="line">                                .entrySet()) &#123;</div><div class="line">                            req.setAttribute(entry.getKey(), entry.getValue());</div><div class="line">                        &#125;</div><div class="line">                        req.getRequestDispatcher(ConfigHelper.getAppJspPath()+path).forward(req, resp);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (result <span class="keyword">instanceof</span> Data) &#123;</div><div class="line">                    Data data = (Data) result;</div><div class="line">                    Object model = data.getModel();</div><div class="line">                    <span class="keyword">if</span>(model != <span class="keyword">null</span>) &#123;</div><div class="line">                        resp.setContentType(<span class="string">"application/json"</span>);</div><div class="line">                        resp.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div><div class="line">                        PrintWriter writer = resp.getWriter();</div><div class="line">                        String json = JsonUtil.toJson(model);</div><div class="line">                        writer.write(json);</div><div class="line">                        writer.flush();</div><div class="line">                        writer.close();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我们搭建了一个简单的MVC框架，定义了一系列注解：通过Controller注解来定义Controller类；通过Inejct注解来实现依赖注入；通过Action注解来定义Action方法。通过一系列的Helper类来初始化MVC框架：通过DispatcherServlet来处理所有的请求；根据请求方法与请求路径来调用具体的Action方法，判断Action方法的返回值，若为View类型，则跳转到JSP页面，若为Data类型，则返回JSON数据。</p>
</div>

    <div class="post-sidebar">
  <div class="toggle-btn" id="toggle-btn">
    <i class="fa fa-reorder"></i>
  </div>
  <section class="post-toc-wrap" id="post-sidebar">
    <h2 class="toc-title">内容目录</h2>
    <div class="post-toc">
      
      
        <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#理想的controlelr"><span class="nav-text">理想的controlelr</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定义框架配置项以及加载"><span class="nav-text">定义框架配置项以及加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开发一个类加载器"><span class="nav-text">开发一个类加载器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定义注解类"><span class="nav-text">定义注解类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现Bean容器"><span class="nav-text">实现Bean容器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现依赖注入功能"><span class="nav-text">实现依赖注入功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#加载Controller"><span class="nav-text">加载Controller</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#请求转发器"><span class="nav-text">请求转发器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-text">总结</span></a></li></ol></div>
      
    </div>
  </section>
</div>


  </div>

  <footer class="post-footer">
    
      <div class="post-tags">
        
          <a href="/tags#Java" rel="tag">#Java</a>
        
      </div>
    
    

  </footer>

</article>




      
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/10/15/打造轻量web框架01/"
           data-title="打造轻量web框架" data-url="http://yoursite.com/2016/10/15/打造轻量web框架01/">
      </div>
    
  </div>




    </main>

    <footer class="footer clearfix">
  <div class="copyright" >
    <span>Copyright</span>
    
    &copy; 
    <span itemprop="copyrightYear">2017</span>
    <span class="author" itemprop="copyrightHolder">ChenXing</span>
  </div>

  <div class="info">
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <span id="busuanzi_container_site_pv">
        总访问量<span id="busuanzi_value_site_pv"></span>次
    </span>
  </div>

</footer>


  </div>

  <div class="back-top-btn" id="back-top-btn"><i class="fa fa-chevron-up"></i></div>





  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"xxxxxxxxxx"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     






<script type="text/javascript" src="/js/motto.min.js?v=0.4.5.1"></script>
<script type="text/javascript" src="/js/main.js?v=0.4.5.1"></script>


</body>
</html>
